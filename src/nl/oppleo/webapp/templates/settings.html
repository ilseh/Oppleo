{% extends "template.html" %}
{% block title %}Instellingen{% endblock %}
{% block jquery %} 
  {% include 'includes/include.jquery-3.3.1.html' %}
{% endblock %} 
{% block head %}
  {{ super() }}
  
  <!-- Socket IO -->
  <script src="{{ url_for('static', filename='plugins/socket.io/2.3.0/socket.io.js') }}"></script>

  <!-- Datepicker -->
  <link rel="stylesheet" href="{{ url_for('static', filename='plugins/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css') }}">  <script src="{{ url_for('static', filename='plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/bootstrap-datepicker/datepicker-nl.js') }}"></script>
  
  <!-- Select2 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='plugins/select2/4.0.7/select2.min.css') }}">
  <script src="{{ url_for('static', filename='plugins/select2/4.0.7/select2.min.js') }}"></script>

  <!-- Oppleo edit web components -->
  <script src="{{ url_for('static', filename='js/oppleo-edit-str.js') }}" shadydom></script>
  <script src="{{ url_for('static', filename='js/oppleo-edit-select.js') }}" shadydom></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/oppleo-edit-select.css') }}">

  <style>
    .paginate_button {
        padding: 0px !important;
    }
    .XXtbody td {
      padding: 2px 2px !important;
      text-align: center;
      background-color: #36404a;
    }
    td.diag_pre {
      box-sizing: inherit;
      overflow-x: hidden !important;
    }
    td.diag_name {
      text-align: right;
      vertical-align: top;
      padding: 10px;
      width: 60px;
    }
    td.diag_value {
      color: #3bafda;
      text-align: left;
      margin-left: 10px;
    }
    td.diag_value ul li {
      list-style-type: none;
    }
    td.diag_value ul li span:nth-of-type(1) {
      display: inline-block;
      width: 50px;
    }
    td.diag_value ul li span:nth-of-type(2) {
      display: inline-block;
      width: 100px;
      text-align: right;
    }
    .set_title {
      padding-left: 100px;
      padding-bottom: 20px;
    }
    .set_name {
      text-align: left;
      padding-left: 110px;
      /* background-color: red; */
      text-decoration: underline;
    }
    .set_val {
      text-align: left;
      padding-left: 140px;
      display: flex;
    }
    .set_val_last {
      padding-bottom: 20px;
    }
    .set_val_name {
      width: 120px;
/*      background-color: royalblue; */
      text-align: right;
      padding-right: 20px;
    }
    .set_val_val {
      text-align: left;
      width: 200px;
/*      background-color: sandybrown; */
      padding-left: 20px;
    }
    .set_val_val_right {
      text-align: right;
      width: 100px;
/*      background-color: sandybrown; */
      padding-left: 20px;
    }



    div.hours-of-day {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      width: 100%;
      height: .5em;
      margin-top: 0;
      /* background-color: red;*/
    }

    td[id^="offPeak"] {
      padding: 0px;
      padding-top: 5px;
      margin: 0px;
    }
    td[id^="offPeak"] > div:nth-child(1) {
      background-color: #ef5350;
      margin-bottom: 2px;
    }
    td[id^="offPeak"] > div:nth-child(2) {
      margin-bottom: 2px;
    }

    div.hours-of-day span {
      width: 4.166%;
      /*background-color: #00b19d; */
      border-right: 1px solid #868e96; 
      border-top: 1px solid #868e96; 
      font-size: 10px; 
      color: #868e96; /* green: #00b19d orange #ffaa00 */
    }
    div.hours-of-day span:nth-child(1) {
      border-left: 1px solid #868e96; 
    }

    .form-control {
      color: #ffffff !important;
      background-color: #434f5c;/* #576676; */
    }
    .form-control:disabled, .form-control[readonly] {
      color: #3bafda !important;
      background-color: rgba(0,0,0,.05);/* #576676; */
    }

  </style>

  <script>
    function timestamp() {
      d = new Date();
      return (d.getFullYear() + "-" + 
             (d.getMonth()<10?'0':'') + (d.getMonth()+1) + "-" + 
             (d.getDate()<10?'0':'') + d.getDate() + '.' + 
             (d.getHours()<10?'0':'') + d.getHours() + ":" + 
             (d.getMinutes()<10?'0':'') + d.getMinutes() + "." + 
             (d.getSeconds()<10?'0':'') + d.getSeconds() + '.' + 
             (d.getMilliseconds()<100?'0':'') + (d.getMilliseconds()<10?'0':'') + d.getMilliseconds()
      )
    }

    function updateSettings( param, value ) {
      console.log(timestamp() + ' updateSettings()')            
      // Show spinner
      $('.spinner').show()
      data = {
            csrf_token    : '{{ csrf_token() }}',
            param         : param,
            value         : value
          }
      $.ajax({
        type		    : 'POST',
        url			    : ('/update_settings/' + encodeURIComponent(param) +'/' + encodeURIComponent(value) + '/'),
        dataType	  : 'json',
        headers     : { 'ignore-login-next': 'true' },
        encode		  : true,
        data        : data
      }) // using the done promise callback
      .done(function(data) {
        // log data to the console so we can see
        console.log(data)
        switch (data.status) {
          case 200:
            switch (data.param) {
              case 'offPeakAddHolidayEntry':
                el = `<tr id="offPeakHoliday_` + data.value + `">
                        <td class="text-dark">` + desc + `:</td>
                        <td class="text-primary">` + 
                          ( recurring ? 
                            'Elk jaar op ' + hDaySplit[0] + ' ' + hDaySplit[1] :
                            'In ' + hDaySplit[2] + ' op ' + hDaySplit[0] + ' ' + hDaySplit[1]
                          ) +
                          `<button 
                            type="button" 
                            id="offPeakDelete_` + data.value + `"
                            style="float: right;"
                            class="btn btn-xs btn-low-key-danger waves-effect waves-light" 
                            data-toggle="tooltip" 
                            data-placement="bottom" 
                            data-html="true" 
                            title="<em class='text-danger font-weight-bold'>Let op!<br /><span class='text-white font-weight-normal'>Wordt direct verwijderd!</span></em>"
                            > 
                              <i class="fas fa-trash-alt"></i> Verwijder 
                          </button>
                        </td>
                      </tr>`
                $(el).insertBefore('tr#offPeakNewHolidayDate')
                // Add delete buttons
                $('#offPeakDelete_' + data.value).on('click', function(e) {
                  $(this).tooltip('hide') // Make sure tooltips don't remain          
                  var id = $(this).attr("id").replace("offPeakDelete_", "")
                  updateSettings( 'offPeakDeleteEntry', id )
                  // Remove from view
                  $('tr#offPeakHoliday_' + id).remove()
                })
                // Activate tooltips
                $('[data-toggle=tooltip]').tooltip({ 
                  boundary: 'window', 
                  trigger : 'hover'   // Allow button clicks
                })
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Daluren zon/feestdag opgeslagen [' + data.value + '].')
                break
              case 'offPeakDeleteEntry':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Daluren zon/feestdag verwijderd [' + data.value + '].')
                break
              case 'chargerName':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Laadpunt naam gewijzigd in ' + data.value + '.');
                break
              case 'factorWhkm':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Whkm factor gewijzigd in ' + data.value + '.');
                break
              case 'chargerTariff':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Laadpunt tarief gewijzigd in ' + data.value + '.');
                break
              default:
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Instelling aangepast.')
                break
            }
            break
          case 409:
            autoHideNotify('warning', 'top-left', 'Foutmelding', 'Wijziging kon niet doorgevoerd worden. ' + data.reason)
            break
          case 404:
          default:
            autoHideNotify('warning','top-left', 'Onbekend', 'Instelling onbekend. Niet gewijzigd.')
            break
        }

      })
      .fail(function(data) {
        notify('error','top-left', 'Connectie fout', 'Instelling niet gewijzigd.')
      })
      .always(function() {
        // Remove spinner
        $('.spinner').hide()
      })
    }

    var diag_data = {{ diag_json | safe }}

    jQuery(document).ready(function() {
      console.log(timestamp() + " file load completed!")
      $('pre#diag_json').html( 
        JSON.stringify(diag_data, undefined, 2) 
      )
      $('pre#diag_json').show()
      $('input#allowPeakOnePeriod').bootstrapToggle()
      $('input#allowPeakOnePeriod').change(function() {
        updateSettings( 'allowPeakOnePeriod', $(this).prop('checked') )
      })
      $('input#offpeakEnabled').bootstrapToggle()
      $('input#offpeakEnabled').change(function() {
        updateSettings( 'offpeakEnabled', $(this).prop('checked') )
      })
      $('input#prowlEnabled').change(function() {
        updateSettings( 'prowlEnabled', $(this).prop('checked') )
      })
      $('input#webChargeOnDashboard').change(function() {
        updateSettings( 'webChargeOnDashboard', $(this).prop('checked') )
      })
      $('input#authWebCharge').change(function() {
        updateSettings( 'authWebCharge', $(this).prop('checked') )
      })

      $('input#restrictMenu').change(function() {
        updateSettings( 'restrictMenu', $(this).prop('checked') )
      })
      $('input#restrictDashboardAccess').change(function() {
        updateSettings( 'restrictDashboardAccess', $(this).prop('checked') )
      })
      $('input#allowLocalDashboardAccess').change(function() {
        updateSettings( 'allowLocalDashboardAccess', $(this).prop('checked') )
      })
      
      $('input#autoSessionEnabled').bootstrapToggle()
      $('input#autoSessionEnabled').change(function() {
        updateSettings( 'autoSessionEnabled', $(this).prop('checked') )
      })
      $('input#autoSessionCondenseSameOdometer').bootstrapToggle()
      $('input#autoSessionCondenseSameOdometer').change(function() {
        updateSettings( 'autoSessionCondenseSameOdometer', $(this).prop('checked') )
      })
      // Add 'bootstrapToggle_' to the id field, and use the parameter name after
      $('input[id^=bootstrapToggle]').bootstrapToggle()
      $('input[id^=bootstrapToggle]').change(function() {
        updateSettings( 
          $(this).attr("id").replace('bootstrapToggle_', ''), 
          $(this).prop('checked')
        )
      })
      $('td[id^=offPeak] > div:nth-child(2)').each(function( index ) {
        var id = $(this).parent().attr("id")
        for (i = 0; i < 24; i++) {
          $(this).append( "<span style='color: #00b19d;'>" + (i %24) + "</span>" )
        }
      })
      $('#holidayDate').datepicker({
          todayHighlight: true,
          autoclose: true,
          startDate : undefined,
          endDate   : undefined,
          format: "d MM yyyy",    // 7 January 2020
          language: 'nl'
      })
      $('#offPeakNewDate').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        // Clean data fields
        $('#holidayDate').val('')
        $('#holidayDescription').val('')
        // Set recurring to false
        $('#offPeakNewRecurring').find('i').toggleClass('fa-calendar-day', true)
        $('#offPeakNewRecurring').find('i').toggleClass('fa-redo-alt', false)
        // Show input
        $('tr#offPeakNewHolidayDate').toggle(200)
        $('#offPeakNewCancel').show()
        $('#offPeakNewSave').show()
        $(this).hide()
      })
      $('#offPeakNewCancel').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        $('tr#offPeakNewHolidayDate').toggle(200)
        $('#offPeakNewDate').show()
        $('#offPeakNewSave').hide()
        $(this).hide()
      })
      $('#offPeakNewRecurring').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        $(this).find('i').toggleClass('fa-calendar-day')
        $(this).find('i').toggleClass('fa-redo-alt')
      })
      $('#offPeakNewSave').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        hDayDate = $('#holidayDate').val()
        hDaySplit = hDayDate.split(' ')
        if (hDaySplit == undefined || hDaySplit.length < 3) {
          autoHideNotify('warning', 'top-left', 'Waarschuwing', 'Geen of onjuist datumveld ingevoerd. Zon/feestdag niet opgeslagen...')
          return
        }
        hDayMonth = -1
        $.each(months, function(i, month) {
					if (month == hDaySplit[1]) {
            hDayMonth = i
					}
				})
        if (hDayMonth == -1) {
          autoHideNotify('warning', 'top-left', 'Waarschuwing', 'Geen of onjuist datumveld ingevoerd. Zon/feestdag niet opgeslagen...')
          return
        }
        desc = $('#holidayDescription').val()
        if (desc.length == 0) {
          autoHideNotify('warning', 'top-left', 'Waarschuwing', 'Geen omschrijving ingevoerd. Zon/feestdag niet opgeslagen...')
          return
        }
        recurring = $('button#offPeakNewRecurring').html().indexOf("fa-redo-alt") >= 0
        updateSettings( 'offPeakAddHolidayEntry', hDaySplit[0] + '|' + hDayMonth + '|' + hDaySplit[2] + '|' + recurring + '|' + encodeURI(desc) )
        $('tr#offPeakNewHolidayDate').toggle()
        $('#offPeakNewDate').show()
        $('#offPeakNewSave').hide()
        $('#offPeakNewCancel').hide()
      })
      // Add delete buttons
      $('button[id^=offPeakDelete]').on('click', function(e) {
        $(this).tooltip('hide') // Make sure tooltips don't remain 
        var id = $(this).attr("id").replace("offPeakDelete_", "")
        updateSettings( 'offPeakDeleteEntry', id )
        // Remove from view
        $('tr#offPeakHoliday_' + id).remove()
      })
      $('button[data-toggle=tooltip]').tooltip({ 
        boundary: 'window',
        trigger : 'hover'   // Allow button clicks
      })
      // Oppleo web component applied change
      $('oppleo-edit-str').on('apply', (e) => {
        console.log('oppleo-edit-str onApply [' + e.target.id + '] oldValue:' + e.detail.oldValue + ' newValue:' + e.detail.newValue)
        // Submit
        updateSettings( e.target.id, e.detail.newValue )
      })
      // Oppleo web component applied change
      $('oppleo-edit-select').on('apply', (e) => {
        console.log('oppleo-edit-str onApply [' + e.target.id + '] oldValue:' + e.detail.oldValue + ' oldText:' + e.detail.oldText + ' newValue:' + e.detail.newValue + ' newText:' + e.detail.newText)
        // Submit
        updateSettings( e.target.id, e.detail.newValue )
      })

      $('button#softwateUpdateCheck').on('click', getSoftwareStatus)

       // Remove spinner
      $('.spinner').hide()
    })

    </script>

{% endblock %}
{% block content %}

<div class="wrapper" id="{{ var1 }}">
  <div class="container-fluid">

    <!-- Page-Title -->
    <div class="row">
        <div class="col-sm-12">
            <div class="page-title-box">
            </div>
        </div>
    </div>
    <!-- end page title end breadcrumb -->

    <div class="row">
      <div class="col-md-12">
          <div class="card-box">
              <h4 class="header-title m-t-0 m-b-30">Instellingen</h4>

              <ul class="nav nav-tabs tabs-bordered nav-justified">
                <li class="nav-item">
                  <a href="#v-charger" class="nav-link{% if active==1 %} active{% endif %}" data-toggle="tab" aria-expanded="false"><i class="fas fa-charging-station"></i> Laadpunt</a>
                </li>
                <li class="nav-item">
                  <a href="#v-kwhmeter" class="nav-link{% if active==2 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-tachometer-alt"></i> kWh meter</a>
                </li>
                <li class="nav-item">
                  <a href="#v-network" class="nav-link{% if active==3 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-network-wired"></i> Netwerk</a>
                </li>
                <li class="nav-item">
                  <a href="#v-database" class="nav-link{% if active==4 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-database"></i> Database</a>
                </li>
                <li class="nav-item">
                  <a href="#v-hardware" class="nav-link{% if active==5 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-microchip"></i> Hardware</a>
                </li>
                <li class="nav-item">
                  <a href="#v-diagnostics" class="nav-link{% if active==6 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-stethoscope"></i> Diagnostics</a>
                </li>
              </ul>

              <div class="tab-content">

                  <div class="tab-pane{% if active==1 %} active{% endif %}" id="v-charger">
                    <div class="col-lg-12">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-charging-station"></i> Laadpunt</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            {% if oppleoconfig %}
                            <tr>
                              <td class="text-dark">Naam laadpunt:</td>
                              <td class="text-primary" style="width: 75%;">
                                <oppleo-edit-str 
                                  id="chargerName"
                                  value="{{ oppleoconfig.chargerName }}"
                                  validation="^([0-9]|[a-z]|[A-Z]|[!@#$%\^&*._\-])+$"
                                  info="Om openstaande laadsessies te voorkomen kan de naam van het laadpunt alleen worden gewijzigd wanneer de laadsessie is afgesloten."
                                  />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">kWh Factor:</td>
                              <td class="text-primary" style="width: 75%;">
                                <oppleo-edit-str 
                                  id="factorWhkm"
                                  value="{{ oppleoconfig.factorWhkm }}"
                                  validation="^([0-9])+$"
                                  info="De Wh per km factor waarmee het km/h equivalent wordt berekend. Een waarde van 162 komt overeen met wat de Tesla Model 3 laat zien op het scherm in de auto. Een meer realistisch gemiddelde op basis van 16.836km in een Tesla Model 3 is 182Wh/km"
                                  />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Laadpunt tarief:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="chargerTariff"
                                  prefix="&euro; " 
                                  value="{{ oppleoconfig.chargerTariff }}"
                                  validation="^[0-9]*[.]*[0-9]+$"
                                  info="Standaard tarief in Den Haag in 2020 is &euro; 0.34. Het tarif kan alleen worden gewijzigd wanneer de laadsessie is afgesloten."
                                  />
                            </tr>
                            {% endif %}
                            {% if ('modified_at' in charger_config) %}
                            <tr>
                              <td class="text-dark">Laatste wijziging:</td>
                              <td class="text-primary">{{ charger_config['modified_at'] }}</td>
                            </tr>
                            {% endif %}


                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> Rapportages</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Bonnummer prefix:</td>
                              <td class="text-primary">
                                <form id="receipt-prefix-form">
                                  <oppleo-edit-str 
                                  id="receiptPrefix"
                                  prefix="" 
                                  value="{{ oppleoconfig.receiptPrefix }}"
                                  validation="^[A-Za-z0-9.-]{0,20}$"
                                  info="Prefix voor de bonnummers gegenereert in PDF maandrapporten. Het bonnummersformat is [prefix][jaartal][maand]. De prefix mag cijfers, kleine en hoofdletters, en punt of streep bevatten en niet langer zijn dan 20 karakters."
                                  />
                                </form>
                              </td>
                            </tr>          



                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> Daluren</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Alleen laden binnen daluren:</td>
                              <td class="text-primary">
                                <form id="peak-hours-off-peak-enabled-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.offpeakEnabled %}checked{% endif %}
                                    name="offpeakEnabled"
                                    id="offpeakEnabled"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Eenmalig laden buiten daluren:</td>
                              <td class="text-primary">
                                <form id="peak-hours-allow-peak-once-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.allowPeakOnePeriod %}checked{% endif %}
                                    name="allowPeakOnePeriod"
                                    id="allowPeakOnePeriod"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>

                            {% if 'offPeak' in diag and 'allReps' in diag['offPeak'] %}
                            {% for weekday in diag['offPeak']['allReps'] %}
                            {% set weekdayOffPeak = diag['offPeak']['allReps'][weekday] %}
                            <tr">
                              <td class="text-dark">{{ weekday }}:</td>
                              <td class="text-primary" id="offPeak{{ weekday }}">
                                <div class="progress">
                                  {% for section in weekdayOffPeak %}
                                  {% set diffMins = section['diffMins'] %}
                                  {% set diffMinsPercentage = (diffMins / (24 * 60)) *100 %}
                                  {% set offPeak = section['offPeak'] %}
                                  <div class="progress-bar progress-bar-striped {% if section['offPeak'] %}progress-bar-animated bg-success{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ diffMinsPercentage }}%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                  {% endfor %}
                                </div>
                                <div class="hours-of-day"></div>
                              </td>
                            </tr>
                            {%- endfor -%}
                            {%- endif -%}

                            {% if 'offPeak' in diag and 'all' in diag['offPeak'] %}
                            {% for offPeak in diag['offPeak']['all'] %}
                            {% if offPeak.is_holiday() %}
                            <tr id="offPeakHoliday_{{ offPeak.id }}">
                              <td class="text-dark">{{ offPeak.description }}:</td>
                              <td class="text-primary">
                                {% if offPeak.recurring %} 
                                  Elk jaar op {{ offPeak.holiday_day }} {{ offPeak.monthNlStr() }}
                                {% endif %}
                                {% if not offPeak.recurring %} 
                                  In {{ offPeak.holiday_year }} op {{ offPeak.holiday_day }} {{ offPeak.monthNlStr() }}
                                {% endif %}
                                <button 
                                  type="button" 
                                  id="offPeakDelete_{{ offPeak.id }}"
                                  style="float: right;"
                                  class="btn btn-xs btn-low-key-danger waves-effect waves-light" 
                                  data-toggle="tooltip" 
                                  data-placement="bottom" 
                                  data-html="true"
                                  title="<em class='text-danger font-weight-bold'>Let op!<br /><span class='text-white font-weight-normal'>Wordt direct verwijderd!</span></em>"
                                  > 
                                    <i class="fas fa-trash-alt"></i> Verwijder 
                                </button>
                              </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            {% endif %}

                            <tr id="offPeakNewHolidayDate" style="display: none;">
                              <td class="text-primary" style="text-align: right;">Nieuwe zon/feestdag:</td>
                              <td class="text-primary">

                                  <div class="input-daterange input-group">
                                    <div class="input-group-prepend">
                                      <span class="input-group-text bg-primary b-0 text-white">
                                        <i class="far fa-calendar-alt"></i>
                                      </span>
                                    </div>
                                    <input type="text" id="holidayDate" class="form-control" name="holidayDate" placeholder="Datum" value=""/>
                                    <div class="input-group-prepend">
                                      <span class="input-group-text bg-primary b-0 text-white">
                                        <i class="fas fa-heading"></i>
                                      </span>
                                    </div>
                                    <input type="text" id="holidayDescription" class="form-control" name="holidayDescription" style="text-align: left; flex: 40%;" placeholder="Omschrijving" value=""/>
                                    <button
                                      id="offPeakNewRecurring"
                                      type="button" 
                                      class="btn waves-effect waves-light btn-primary" 
                                      data-toggle="tooltip" 
                                      data-placement="bottom" 
                                      data-html="true" 
                                      title="<em>Klik om jaarlijks terugkerend te maken</em>"
                                      >
                                      <i class="fas fa-calendar-day"></i>
                                    </button> 
                                  </div>
                                                  
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">&nbsp;</td>
                              <td class="text-primary">
                                <button 
                                  type="button" 
                                  id="offPeakNewDate" 
                                  class="btn btn-outline-primary waves-effect waves-light"
                                  > 
                                  <i class='fas fa-edit'></i> Nieuwe zon/feestdag 
                                </button>
                                <button 
                                  type="button" 
                                  id="offPeakNewSave" 
                                  style="float: right; display: none;"
                                  class="btn btn-primary waves-effect waves-light"
                                  > 
                                  <i class='far fa-thumbs-up'></i> Opslaan 
                                </button>
                                <div style="float: right; width: 5px;">&nbsp;</div>
                                <button 
                                  type="button" 
                                  id="offPeakNewCancel"
                                  style="float: right; display: none;"
                                  class="btn btn-secondary waves-effect waves-light" 
                                  > 
                                  <i class='fas fa-times'></i> Annuleren 
                                </button>
                              </td>
                            </tr>




                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> Prowl (iOS Push messages)</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Prowl actief:</td>
                              <td class="text-primary">
                                <form id="prowl-enabled-form">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.prowlEnabled %}checked{% endif %}
                                    name="prowlEnabled"
                                    id="prowlEnabled"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Prowl API key:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="prowlApiKey"
                                  prefix="" 
                                  value="{{ oppleosystemconfig.prowlApiKey }}"
                                  validation="^[A-Za-z0-9]+$"
                                  info="API key voor je <a href='https://www.prowlapp.com/'>Prowl</a> push message app."
                                  />
                            </tr>


                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-credit-card"></i> WebCharge</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark"> WebCharge op Dashboard:</td>
                              <td class="text-primary">
                                <form id="webcharge-on-dashboard-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.webChargeOnDashboard %}checked{% endif %}
                                    name="webChargeOnDashboard"
                                    id="webChargeOnDashboard"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Autorisatie:</td>
                              <td class="text-primary">
                                <form id="auth-webcharge-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.authWebCharge %}checked{% endif %}
                                    name="authWebCharge"
                                    id="authWebCharge"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>                            


                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-credit-card"></i> Afschermen</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark"> Menuopties afschermen:</td>
                              <td class="text-primary">
                                <form id="restrict-menu-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.restrictMenu %}checked{% endif %}
                                    name="restrictMenu"
                                    id="restrictMenu"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Dashboard afschermen:</td>
                              <td class="text-primary">
                                <form id="restrict-dashboard-access-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.restrictDashboardAccess %}checked{% endif %}
                                    name="restrictDashboardAccess"
                                    id="restrictDashboardAccess"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>                               

                            <tr>
                              <td class="text-dark">Dashboard lokaal onafgeschermd:</td>
                              <td class="text-primary">
                                <form id="allow-local-dashboard-access-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.allowLocalDashboardAccess %}checked{% endif %}
                                    name="allowLocalDashboardAccess"
                                    id="allowLocalDashboardAccess"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Reverse Proxy:</td>
                              <td class="text-primary">
                                <form id="router-ip-address-form">
                                  <oppleo-edit-str 
                                  id="routerIPAddress"
                                  prefix="" 
                                  value="{{ oppleoconfig.routerIPAddress }}"
                                  validation="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4}$"
                                  info="IPv4 adres van de Reverse Proxy. Verkeer van de Reverse Proxy wordt gezien als Extern verkeer, overige IPv4 adressen worden gezien als lokaal verkeer."
                                  />
                                </form>
                              </td>
                            </tr>          

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-credit-card"></i> Software versie</h4>
                              </th>
                            </tr>
                            <tr id="softwateUpdateCurrentVersionRow">
                              <td class="text-dark"> Huidige versie:</td>
                              <td class="text-primary">{{ diag['lastSoftwareUpdate'] }}</td>
                            </tr>
                            <tr id="softwateUpdateCheckRow">
                              <td class="text-dark"></td>
                              <td class="text-primary">
                                <button 
                                  type="button" 
                                  id="softwateUpdateCheck" 
                                  class="btn btn-outline-success btn-sm waves-effect waves-light"
                                  > 
                                  <i class='far fa-question-circle'></i> Controleer op updates 
                                </button>                                
                              </td>
                            </tr>

                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==2 %} active{% endif %}" id="v-kwhmeter">
                    <div class="col-lg-9">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-tachometer-alt"></i> kWh meter</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            {% if (energydevicemodel is not none) %}
                            <tr>
                              <td class="text-dark">Device interface:</td>
                              <td class="text-primary">Modbus</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Port name:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="port_name"
                                  prefix="" 
                                  value="{{ energydevicemodel.port_name }}"
                                  validation=""
                                  info="USB poort naam voor de modbus interface, bijv. /dev/ttyUSB0"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Slave address:</td>
                              <td class="text-primary">                                
                                <oppleo-edit-str 
                                id="slave_address"
                                prefix="" 
                                value="{{ energydevicemodel.slave_address }}"
                                validation="^([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])$"
                                info="Slave adres ingesteld op de kWh meter (modbus slave adres). Standaard waarde 1, waarde tussen 1 en 256."
                                />
                                </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Mode:</td>
                              <td class="text-primary">{{ energydevicemodel.mode }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Snelheid:</td>
                              <td class="text-primary">
                                <oppleo-edit-select 
                                id="baudrate"
                                options='[ { "text": "2400", "value": "2400" }, 
                                           { "text": "4800", "value": "4800" },
                                           { "text": "9600", "value": "9600" },
                                           { "text": "19200", "value": "19200" },
                                           { "text": "38400", "value": "38400" },
                                           { "text": "57600", "value": "57600" },
                                           { "text": "115200", "value": "115200" }
                                         ]'
                                selectedText="{{ energydevicemodel.baudrate }}"
                                info="Seriele poort snelheid om de kWh meter uit te lezen. Dit moet overeenkomen met de snelheid op de kWh meter! Max van de Eastron SMD630 Modbus is 38400"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Byte size:</td >
                              <td class="text-primary">{{ energydevicemodel.bytesize }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Stop bits:</td >
                              <td class="text-primary">{{ energydevicemodel.stopbits }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Parity:</td >
                              <td class="text-primary">{{ energydevicemodel.parity }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Modbus timeout:</td>
                              <td class="text-primary">{{ energydevicemodel.modbus_timeout }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Serial timeout:</td>
                              <td class="text-primary">{{ energydevicemodel.serial_timeout }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Debug:</td>
                              <td class="text-primary">{{ energydevicemodel.debug }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Close port after each call:</td>
                              <td class="text-primary">{{ energydevicemodel.close_port_after_each_call }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Modbus register configuration:</td>
                              <td class="text-primary">
                                <oppleo-edit-select 
                                id="modbusConfig"
                                options='[ {% for mco in diag['modbusConfigOptions'] %}{ "text": "{{ mco.short }}", "value": "{{ mco.name }}" }{% if mco.name != (diag['modbusConfigOptions'] | last).name %}, {% endif %}{% endfor %} ]'
                                selectedValue="{{ energydevicemodel.modbus_config }}"
                                info="Modbus register definitie, kan verschillen per energiemeter type en versie."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">kWh meter uitleesinterval:</td>
                              <td class="text-primary">                                
                                <oppleo-edit-str 
                                id="modbusInterval"
                                value="{{ oppleoconfig.modbusInterval }}"
                                suffix=" seconden"
                                validation="^([1-9]|[1-5][0-9]|60)$"
                                info="Interval in seconden tussen achtereenvolgende kWh meter uitlezingen (1-60 seconden). Een kortere periode geeft veranderingen sneller weer op de web interface en maakt een meer ganulaire log bij wijzigingen, maar zorgt ook voor meer log entries."
                                />
                                </td>
                            </tr>

                            {% endif %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==3 %} active{% endif %}" id="v-network">
                    <div class="col-lg-6">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-network-wired"></i> Netwerk</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            {% if ('ip' in diag and 'eth0' in diag['ip'] and 'INET' in diag['ip']['eth0'] and diag['ip']['eth0']['INET'] | length > 0 and 'addr' in diag['ip']['eth0']['INET'][0]) %}
                            <tr>
                              <td class="text-dark">IPv4:</td>
                              <td class="text-primary">{{ diag['ip']['eth0']['INET'][0]['addr'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('ip' in diag and 'en0' in diag['ip'] and 'INET' in diag['ip']['en0'] and diag['ip']['en0']['INET'] | length > 0 and 'addr' in diag['ip']['en0']['INET'][0]) %}
                            <tr>
                              <td class="text-dark">IPv4:</td>
                              <td class="text-primary">{{ diag['ip']['en0']['INET'][0]['addr'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('ip' in diag and 'eth0' in diag['ip'] and 'INET6' in diag['ip']['eth0'] and diag['ip']['eth0']['INET6'] | length > 0 and 'addr' in diag['ip']['eth0']['INET6'][0]) %}
                            <tr>
                              <td class="text-dark">IPv6:</td>
                              <td class="text-primary">{{ diag['ip']['eth0']['INET6'][0]['addr'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('ip' in diag and 'en0' in diag['ip'] and 'INET6' in diag['ip']['en0'] and diag['ip']['en0']['INET6'] | length > 0 and 'addr' in diag['ip']['en0']['INET6'][0]) %}
                            <tr>
                              <td class="text-dark">IPv6:</td>
                              <td class="text-primary">{{ diag['ip']['en0']['INET6'][0]['addr'] }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                              <td class="text-dark">HTTP Host:</td>
                              <td class="text-primary">{{ oppleosystemconfig.httpHost }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">HTTP Port:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="httpPort"
                                prefix="" 
                                value="{{ oppleosystemconfig.httpPort }}"
                                validation="^([0-9]{1,4}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$"
                                info="HTTP port waarop de Oppleo service beschikbaar is."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Reloader:</td>
                              <td class="text-primary">{{ oppleoconfig.useReloader }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==4 %} active{% endif %}" id="v-database">
                    <div class="col-lg-12">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-database"></i> Database</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            <tr>
                              <td class="text-dark">Database:</td>
                              <td class="text-primary">PostgreSQL</td>
                            </tr>
                            <tr>
                              <td class="text-dark">SQLAlchemy URL:</td>
                              <td class="text-primary">
                                  <oppleo-edit-str 
                                  id="DATABASE_URL"
                                  prefix="" 
                                  value="{{ oppleosystemconfig.DATABASE_URL }}"
                                  validation="^(postgresql://)[a-zA-Z0-9]+(:)[a-zA-Z0-9]+(@)[a-zA-Z0-9.:/]+$"
                                  info="Alleen PostgresSQL ondersteund. Formaat: postgresql://charger:charger@10.0.1.160:5432/charger"
                                  />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">SQLAlchemy Pool Status:</td>
                              <td class="text-primary">{{ oppleosystemconfig.sqlAlchemyPoolStatus() }}</td>
                            </tr>

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> On Database Failure</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Herstart toestaan:<br />(via webapp)</td>
                              <td class="text-primary">
                                <form id="on-db-failure-allow-restart">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.onDbFailureAllowRestart %}checked{% endif %}
                                    id="bootstrapToggle_onDbFailureAllowRestart"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Magic Password:<br />(herstart autorisatie)</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="onDbFailureMagicPassword"
                                prefix=""
                                value=""
                                hide="[hashed]"
                                validation="^[a-zA-Z0-9]{8,}$"
                                info="Wanneer de database niet beschikbaar is zijn alle instellingen onbekend en is inloggen niet mogelijk. Dit wachtwoord geeft alleen dan autorisatie om de applicatie te herstarten, en eventueel de database URL opnieuw in te stellen."
                                />
                            </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Database URL wijzigen:</td>
                              <td class="text-primary">
                                <form id="on-db-failure-allow-url-change">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.onDbFailureAllowUrlChange %}checked{% endif %}
                                    name="bootstrapToggle_onDbFailureAllowUrlChange"
                                    id="bootstrapToggle_onDbFailureAllowUrlChange"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Toon Database URL:<br />(DB wachtwoord!)</td>
                              <td class="text-primary">
                                <form id="on-db-failure-show-current-url">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.onDbFailureShowCurrentUrl %}checked{% endif %}
                                    name="bootstrapToggle_onDbFailureShowCurrentUrl"
                                    id="bootstrapToggle_onDbFailureShowCurrentUrl"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                        
                          </tbody>
                        </table>
                        <img src="{{ url_for('static', filename='images/postgresql.png') }}" width="100px">
                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==5 %} active{% endif %}" id="v-hardware">
                    <div class="col-lg-12">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-microchip"></i> Platform</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            {% if ('model' in diag) %}
                            <tr>
                              <td class="text-dark" style="min-width: 200px;">Model:</td>
                              <td class="text-primary">{{ diag['model'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('revision' in diag) %}
                            <tr>
                              <td class="text-dark">Revision:</td>
                              <td class="text-primary">{{ diag['revision'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('proc' in diag) %}
                            <tr>
                              <td class="text-dark">Processor:</td>
                              <td class="text-primary">{{ diag['proc'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('threading' in diag and 'active_count' in diag['threading']) %}
                            <tr>
                              <td class="text-dark">Thread count:</td>
                              <td class="text-primary">{{ diag['threading']['active_count'] }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                              <td class="text-dark">System type:</td>
                              <td class="text-primary">{{ diag['os']['sysname'] }} ({{ diag['platform'] }})</td>
                            </tr>
                            <tr>
                              <td class="text-dark">System uptime:</td>
                              <td class="text-primary">{{ diag['uptime']['sysuptime'] }} (Start: {{ diag['uptime']['sysstarttime'] }})</td>
                            </tr>
                            {% if diag['systemctl'] is mapping %}
                            <tr>
                              <td class="text-dark"><i>systemd</i> Status:</td>
                              <td class="text-primary">{{ diag['systemctl']['status'] }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark"><i>systemd</i> pid:</td>
                              <td class="text-primary">{{ diag['systemctl']['pid'] }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark"><i>systemd</i> Memory:</td>
                              <td class="text-primary">{{ diag['systemctl']['mem'] }}</td>
                            </tr>
                            {% else %}
                            <tr>
                              <td class="text-dark"><i>systemd</i>:</td>
                              <td class="text-primary">No</td>
                            </tr>
                            {% endif %}

                            <tr>
                              <td class="text-dark">Oppleo uptime:</td>
                              <td class="text-primary">{{ diag['uptime']['piduptime'] }} (Start: {{ diag['uptime']['pidstarttime'] }})</td>
                            </tr>


                            {% if ('threading' in diag and 'enum' in diag['threading']) %}
                            {% for thread in diag['threading']['enum'] %}
                            <tr>
                              {% if diag['threading']['enum'].index(thread) == 0 %}
                              <td class="text-dark">Threads:</td>
                              {% else %}
                              <td class="text-dark">&nbsp;</td>
                              {% endif %}
                              <td class="text-primary">{{ thread.name }}</td>
                            </tr>
                            {% endfor %}
                            {% endif %}

                            {% for sid, connectedClient in oppleoconfig.connectedClients.items() %}
                            <tr>
                              <td class="text-dark">Connected WebClient:</td>
                              <td class="text-primary">{{ sid }}</td>
                            </tr>
                            {% endfor %}

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> General-Purpose Input/Output (GPIO)</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">GPIO Mode:</td>
                              <td class="text-primary">
                                <oppleo-edit-select 
                                id="gpioMode"
                                options='[ { "text": "BCM: Broadcom SOC Channel (GPIO01 etc.)", "value": "BCM" },
                                           { "text": "BOARD: De GPIO.BOARD spec (Pin 1 etc.)", "value": "BOARD" }
                                       ]'
                                selectedValue="{{ oppleoconfig.gpioMode }}"
                                info="Raspberry Pi GPIO Pin definitie. De GPIO.BOARD spec refereert aan de pins per pin nummer op de header. GPIO.BCM spec refereert aan de pins per <b>Broadcom SOC Channel</b> nummer, als GPIO01. Bij elke Raspberry Pi versie kan de <i>BOARD</i> header Pin nummering verschillen, terwijl de <i>BCM</i> nummering meestal onveranderd blijft."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Red Led:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pinLedRed"
                                prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                value="{{ oppleoconfig.pinLedRed }}"
                                validation="^[0-9]+$"
                                info="BCM GPIO Mode GPIO13"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Green Led:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pinLedGreen"
                                prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                value="{{ oppleoconfig.pinLedGreen }}"
                                validation="^[0-9]+$"
                                info="BCM GPIO Mode GPIO12"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Blue Led:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pinLedBlue"
                                prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                value="{{ oppleoconfig.pinLedBlue }}"
                                validation="^[0-9]+$"
                                info="BCM GPIO Mode GPIO16"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Buzzer:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pinBuzzer"
                                prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                value="{{ oppleoconfig.pinBuzzer }}"
                                validation="^[0-9]+$"
                                info="BCM GPIO Mode GPIO23"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">EVSE Switch:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pinEvseSwitch"
                                prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                value="{{ oppleoconfig.pinEvseSwitch }}"
                                validation="^[0-9]+$"
                                info="BCM GPIO Mode GPIO5"
                                />
                            </tr>
                            <tr>
                              <td class="text-dark">EVSE Led:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pinEvseLed"
                                prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                value="{{ oppleoconfig.pinEvseLed }}"
                                validation="^[0-9]+$"
                                info="BCM GPIO Mode GPIO6"
                                />
                            </tr>
                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> LED Pulse levels</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Led pulse min:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pulseLedMin"
                                suffix="%" 
                                value="{{ oppleoconfig.pulseLedMin }}"
                                validation="^([1-9][0-9]?|100)$"
                                info="3%"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Led pulse max:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pulseLedMax"
                                suffix="%" 
                                value="{{ oppleoconfig.pulseLedMax }}"
                                validation="^([1-9][0-9]?|100)$"
                                info="98%"
                                />
                              </td>
                            </tr>
                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> Auto-session</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Ingeschakeld:</td>
                              <td class="text-primary">
                                <form id="peak-hours-off-peak-enabled-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.autoSessionEnabled %}checked{% endif %}
                                    name="autoSessionEnabled"
                                    id="autoSessionEnabled"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Minutes:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="autoSessionMinutes"
                                suffix=" min" 
                                value="{{ oppleoconfig.autoSessionMinutes }}"
                                validation="^([1-9]+)$"
                                info="Tesla Model 3 settings are 0.1kWh in 90 minutes"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Energy:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="autoSessionEnergy"
                                suffix="kWh" 
                                value="{{ oppleoconfig.autoSessionEnergy }}"
                                validation="^[0-9]*[.]*[0-9]+$"
                                info="Tesla Model 3 settings are 0.1kWh in 90 minutes"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Condense sessies:</td>
                              <td class="text-primary">
                                <form id="peak-hours-off-peak-enabled-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.autoSessionCondenseSameOdometer %}checked{% endif %}
                                    name="autoSessionCondenseSameOdometer"
                                    id="autoSessionCondenseSameOdometer"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                                                        
                            {% if ('os' in diag) %}
                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> OS</h4>
                              </th>
                            </tr>
                            {% for os_line in diag['os'] %}
                            <tr>
                              <td class="text-dark">&nbsp;</td>
                              <td class="text-primary">{{ os_line }}</td>
                            </tr>
                            {% endfor %}
                            {% endif %}

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-hdd"></i> Disk</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Root:</td>
                              <td class="text-primary">/</td>
                            </tr>
                            {% if ('disk' in diag and 'total' in diag['disk'] and 'size' in diag['disk']['total'] and 'unit' in diag['disk']['total']) %}
                            <tr>
                              <td class="text-dark">Total:</td>
                              <td class="text-primary">{{ diag['disk']['total']['size'] }} {{ diag['disk']['total']['unit'] }}</td>
                            </tr>
                            {% endif %}    
                            {% if ('disk' in diag and 'free' in diag['disk'] and 'size' in diag['disk']['free'] and 'unit' in diag['disk']['free']) %}
                            <tr>
                              <td class="text-dark">Free:</td>
                              <td class="text-primary">{{ diag['disk']['free']['size'] }} {{ diag['disk']['free']['unit'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('disk' in diag and 'used' in diag['disk'] and 'size' in diag['disk']['used'] and 'unit' in diag['disk']['used']) %}
                            <tr>
                              <td class="text-dark">Used:</td>
                              <td class="text-primary">{{ diag['disk']['used']['size'] }} {{ diag['disk']['used']['unit'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('disk' in diag and 'percent' in diag['disk']) %}
                            <tr>
                              <td class="text-dark">&nbsp;</td>
                              <td class="text-primary">{{ diag['disk']['percent'] }}% in use</td>
                            </tr>
                            {% endif %}

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-memory"></i> Memory</h4>
                              </th>
                            </tr>
                            {% if ('pmem' in diag and diag['pmem'] is not none and 'MemTotalFormatted' in diag['pmem'] and 'size' in diag['pmem']['MemTotalFormatted'] and 'unit' in diag['pmem']['MemTotalFormatted']) %}
                            <tr>
                              <td class="text-dark">Total:</td>
                              <td class="text-primary">{{ diag['pmem']['MemTotalFormatted']['size'] }} {{ diag['pmem']['MemTotalFormatted']['unit'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('pmem' in diag and diag['pmem'] is not none and 'MemFreeFormatted' in diag['pmem'] and 'size' in diag['pmem']['MemFreeFormatted'] and 'unit' in diag['pmem']['MemFreeFormatted']) %}
                            <tr>
                              <td class="text-dark">Free:</td>
                              <td class="text-primary">{{ diag['pmem']['MemFreeFormatted']['size'] }} {{ diag['pmem']['MemFreeFormatted']['unit'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('pmem' in diag and diag['pmem'] is not none and 'MemAvailableFormatted' in diag['pmem'] and 'size' in diag['pmem']['MemAvailableFormatted'] and 'unit' in diag['pmem']['MemAvailableFormatted']) %}
                            <tr>
                              <td class="text-dark">Available:</td>
                              <td class="text-primary">{{ diag['pmem']['MemAvailableFormatted']['size'] }} {{ diag['pmem']['MemAvailableFormatted']['unit'] }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-clipboard-list"></i> Logging</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Logfile:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="logFile"
                                value="{{ oppleoconfig.logFile }}"
                                validation="^((/)+[a-zA-Z0-9\\-_/ ]*(.log))$"
                                info="Default locatie is in /tmp/Oppleo.log en de extensie moet .log zijn. De applicatie moet worden herstart na het wijzigen van de log file om wijzigingen in gebruik te nemen."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">SQLALCHEMY_TRACK_MODIFICATIONS:</td>
                              <td class="text-primary">{{ oppleosystemconfig.SQLALCHEMY_TRACK_MODIFICATIONS }}
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">ENV:</td>
                              <td class="text-primary">
                                <oppleo-edit-select 
                                id="ENV"
                                options='[ { "text": "Development", "value": "Development", "optgroup": "Environment setting" }, 
                                           { "text": "Production", "value": "Production", "optgroup": "Environment setting" }
                                         ]'
                                selectedText="{{ oppleosystemconfig.ENV }}"
                                info="Bij Production worden Threads gestart om o.a. de kWh meter uit te lezen en wijzigingen op te slaan in de database, en worde de EVSE aangestuurd. In Development worden hiervoor stubs gebruikt."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">DEBUG:</td>
                              <td class="text-primary">{{ oppleosystemconfig.DEBUG }}
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">TESTING:</td>
                              <td class="text-primary">{{ oppleosystemconfig.TESTING }}
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">PYTHONPATH:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="PYTHONPATH"
                                value="{{ oppleosystemconfig.PYTHONPATH }}"
                                validation="^([a-zA-Z0-9\\-_/]{0,})$"
                                info="Python PATH variable."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">EXPLAIN_TEMPLATE_LOADING:</td>
                              <td class="text-primary">{{ oppleosystemconfig.EXPLAIN_TEMPLATE_LOADING }}
                              </td>
                            </tr>
                          </tbody>
                        </table>
                        <img src="{{ url_for('static', filename='images/Powered-by-Raspberry-Pi-Logo.png') }}" width="100px">

                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==6 %} active{% endif %}" id="v-diagnostics">
                    <div class="col-lg-12">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-network-wired"></i> Diagnostics</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            <tr>
                              <td class="text-dark">
                                <pre id="diag_json" style="color:rgba(255, 255, 255, 0.7);"></pre>
                              </td>
                            </tr>
                          </tbody>
                        </table>

                      </div>
                    </div>
                  </div>

          </div>
      </div> <!-- end col -->
    </div> <!-- end row -->

  </div>
</div>
{% endblock %}
