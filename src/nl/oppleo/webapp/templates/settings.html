{% extends "template.html" %}
{% block title %}Instellingen{% endblock %}
{% block jquery %} 
  {% include 'includes/include.jquery-3.3.1.html' %}
{% endblock %} 
{% block head %}
  {{ super() }}
  
  <!-- Socket IO -->
  <script src="{{ url_for('static', filename='plugins/socket.io/4.7.2/socket.io.min.js') }}"></script>

  <!-- Datepicker -->
  <link rel="stylesheet" href="{{ url_for('static', filename='plugins/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css') }}">  <script src="{{ url_for('static', filename='plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/bootstrap-datepicker/datepicker-nl.js') }}"></script>
  
  <!-- https://select2.org/ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='plugins/select2/4.0.7/select2.min.css') }}">
  <script src="{{ url_for('static', filename='plugins/select2/4.0.7/select2.min.js') }}"></script>

  <!-- https://timepicker.co/ -->
  <link href="/static/plugins/timepicker/1.3.5/jquery.timepicker.min.css" rel="stylesheet" type="text/css" />
  <script src="/static/plugins/timepicker/1.3.5/jquery.timepicker.min.js" type="text/javascript"></script>

  <!-- Custombox -->
  <link rel="stylesheet" href="{{ url_for('static', filename='plugins/custombox/4.0.3/dist/custombox.min.css') }}">
  <script src="{{ url_for('static', filename='plugins/custombox/4.0.3/dist/custombox.min.js') }}"></script>

  <!-- Oppleo edit web components -->
  <script src="{{ url_for('static', filename='js/oppleo-edit-str.js') }}" shadydom></script>
  <script src="{{ url_for('static', filename='js/oppleo-edit-select.js') }}" shadydom></script>
  <script src="{{ url_for('static', filename='js/oppleo-edit-time.js') }}" shadydom></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/oppleo-edit-select.css') }}">

  <style>
    .paginate_button {
        padding: 0px !important;
    }
    .tbody td {
      padding: 2px 2px !important;
      text-align: center;
      background-color: #36404a;
    }
    td.diag_pre {
      box-sizing: inherit;
      overflow-x: hidden !important;
    }
    td.diag_name {
      text-align: right;
      vertical-align: top;
      padding: 10px;
      width: 60px;
    }
    td.diag_value {
      color: #3bafda;
      text-align: left;
      margin-left: 10px;
    }
    td.diag_value ul li {
      list-style-type: none;
    }
    td.diag_value ul li span:nth-of-type(1) {
      display: inline-block;
      width: 50px;
    }
    td.diag_value ul li span:nth-of-type(2) {
      display: inline-block;
      width: 100px;
      text-align: right;
    }
    .set_title {
      padding-left: 100px;
      padding-bottom: 20px;
    }
    .set_name {
      text-align: left;
      padding-left: 110px;
      /* background-color: red; */
      text-decoration: underline;
    }
    .set_val {
      text-align: left;
      padding-left: 140px;
      display: flex;
    }
    .set_val_last {
      padding-bottom: 20px;
    }
    .set_val_name {
      width: 120px;
/*      background-color: royalblue; */
      text-align: right;
      padding-right: 20px;
    }
    .set_val_val {
      text-align: left;
      width: 200px;
/*      background-color: sandybrown; */
      padding-left: 20px;
    }
    .set_val_val_right {
      text-align: right;
      width: 100px;
/*      background-color: sandybrown; */
      padding-left: 20px;
    }



    div.hours-of-day {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      width: 100%;
      height: .5em;
      margin-top: 0;
      /* background-color: red;*/
    }

    td[id^="offPeak"] {
      padding: 0px;
      padding-top: 5px;
      margin: 0px;
    }
    td[id^="offPeak"] > div:nth-child(1) {
      background-color: #ef5350;
      margin-bottom: 2px;
    }
    td[id^="offPeak"] > div:nth-child(2) {
      margin-bottom: 2px;
    }

    div.hours-of-day span {
      width: 4.166%;
      /*background-color: #00b19d; */
      border-right: 1px solid #868e96; 
      border-top: 1px solid #868e96; 
      font-size: 10px; 
      color: #868e96; /* green: #00b19d orange #ffaa00 */
    }
    div.hours-of-day span:nth-child(1) {
      border-left: 1px solid #868e96; 
    }

    .form-control {
      color: #ffffff !important;
      background-color: #434f5c;/* #576676; */
    }
    .form-control:disabled, .form-control[readonly] {
      color: #3bafda !important;
      background-color: rgba(0,0,0,.05);/* #576676; */
    }


  </style>

  <script>

    function sendMessage( message, type, spinner=false, successCallback=null, failCallback=null ) {
      console.log(timestamp() + ' sendMessage()')            
      if (spinner) {
        // Show spinner
        $('.spinner').show()
      }
      data = {
          csrf_token    : '{{ csrf_token() }}',
          message       : message
        }
      $.ajax({
        type		    : 'POST',
        url			    : ('/notification/'+encodeURIComponent(type)+'/'),
        dataType	  : 'json',
        headers     : { 'ignore-login-next': 'true' },
        encode		  : true,
        data        : data
      }) // using the done promise callback
      .done(function(data) {
        if (successCallback != null) { successCallback(data) }
      })
      .fail(function(data) {
        if (failCallback != null) { failCallback(data) }
      })
      .always(function() {
        if (spinner) {
          // Show spinner
          $('.spinner').hide()
        }
      })
    }

    function mqttHistory( action, method, successCallback=null, failCallback=null, alwaysCallback=null ) {
      console.log(timestamp() + ' mqttHistory()')            
      data = {
          csrf_token  : '{{ csrf_token() }}',
          action      : action
        }
      $.ajax({
        type		    : method,
        url			    : '/mqtt/history/'+(action!=undefined?encodeURIComponent(action)+'/':''),
        dataType	  : 'json',
        headers     : { 'ignore-login-next': 'true' },
        encode		  : true,
        data        : data
      }) // using the done promise callback
      .done(function(data) {
        if (successCallback != null) { successCallback(data) }
      })
      .fail(function(data) {
        if (failCallback != null) { failCallback(data) }
      })
      .always(function() {
        if (alwaysCallback != null) { alwaysCallback(data) }
      })
    }    

    // Load pushover sounds
    function loadPushoverSounds(apiKey, selectedSound=undefined) {
      data = {
          csrf_token    : '{{ csrf_token() }}'
        }
      $.ajax({
        type		    : 'GET',
        url			    : ('/pushover/'+encodeURIComponent(apiKey)+'/sounds/'),
        dataType	  : 'json',
        headers     : { 'ignore-login-next': 'true' },
        encode		  : true,
        data        : data
      }) // using the done promise callback
      .done(function(data) {
        // pushoverSound
        if (data.status == 200) {
          // data.sounds
          let dObj = []
          for (var sound in data.sounds) {
            if (data.sounds.hasOwnProperty(sound)) {
              dObj.push( { id: sound, text: data.sounds[sound], selected: (sound == selectedSound || (selectedSound == undefined && sound == 'pushover')) } )
            }
          }
          $('oppleo-edit-select#pushoverSound').prop('options', JSON.stringify(dObj))
        } else {
          console.log('Failed to load sounds for pushover token ' + data.apiKey)
        }
      })
      .fail(function(data) {
        console.log('Failed to load sounds for pushover token ' + data.apiKey)
      })
      .always(function() {
      })
    }


    // Load pushover sounds
    function loadPushoverDevices(userKey, apiKey, selectedDevice=undefined) {
      data = {
          csrf_token    : '{{ csrf_token() }}'
        }
      $.ajax({
        type		    : 'GET',
        url			    : ('/pushover/'+encodeURIComponent(userKey)+'/'+encodeURIComponent(apiKey)+'/devices/'),
        dataType	  : 'json',
        headers     : { 'ignore-login-next': 'true' },
        encode		  : true,
        data        : data
      }) // using the done promise callback
      .done(function(data) {
        // pushoverDevices
        if (data.status == 200) {
          // data.sounds
          let dObj = []
          dObj.push( { id: '*', text: 'Alle actieve devices', selected: (selectedDevice == undefined) } )
          for (var device in data.devices) {
            if (data.devices.hasOwnProperty(device)) {
              dObj.push( { id: device, text: data.devices[device], selected: (device == selectedDevice) } )
            }
          }
          $('oppleo-edit-select#pushoverDevice').prop('options', JSON.stringify(dObj))
        } else {
          console.log('Failed to load devices for pushover userKey ' + data.userKey + ' apiKey ' + data.apiKey)
        }
      })
      .fail(function(data) {
        console.log('Failed to load devices for pushover userKey ' + data.userKey + ' apiKey ' + data.apiKey)
      })
      .always(function() {
      })
    }

    function updateSettings( param, value ) {
      console.log(timestamp() + ' updateSettings()')            
      // Show spinner
      $('.spinner').show()
      if (value === true) value = 'true'
      if (value === false) value = 'false'     
      data = {
            csrf_token    : '{{ csrf_token() }}',
            param         : param,
            value         : value
          }
      $.ajax({
        type		    : 'POST',
        url			    : ('/update_settings/'+encodeURIComponent(param)+'/'+(value.length>0?encodeURIComponent(value)+'/':'')),
        dataType	  : 'json',
        headers     : { 'ignore-login-next': 'true' },
        encode		  : true,
        data        : data
      }) // using the done promise callback
      .done(function(data) {
        // log data to the console so we can see
        console.log(data)
        switch (data.status) {
          case 200:
            switch (data.param) {
              case 'offPeakAddHolidayEntry':
                el = `<tr id="offPeakHoliday_` + data.value + `">
                        <td class="text-dark">` + desc + `:</td>
                        <td class="text-primary">` + 
                          ( recurring ? 
                            'Elk jaar op ' + hDaySplit[0] + ' ' + hDaySplit[1] :
                            'In ' + hDaySplit[2] + ' op ' + hDaySplit[0] + ' ' + hDaySplit[1]
                          ) +
                          `<button 
                            type="button" 
                            id="offPeakDelete_` + data.value + `"
                            style="float: right;"
                            class="btn btn-xs btn-low-key-danger waves-effect waves-light" 
                            data-toggle="tooltip" 
                            data-placement="bottom" 
                            data-html="true" 
                            title="<em class='text-danger font-weight-bold'>Let op!<br /><span class='text-white font-weight-normal'>Wordt direct verwijderd!</span></em>"
                            > 
                              <i class="fas fa-trash-alt"></i> Verwijder 
                          </button>
                        </td>
                      </tr>`
                $(el).insertBefore('tr#offPeakNewHolidayDate')
                // Add delete buttons
                $('#offPeakDelete_' + data.value).on('click', function(e) {
                  $(this).tooltip('hide') // Make sure tooltips don't remain          
                  var id = $(this).attr("id").replace("offPeakDelete_", "")
                  updateSettings( 'offPeakDeleteEntry', id )
                  // Remove from view
                  $('tr#offPeakHoliday_' + id).remove()
                })
                // Activate tooltips
                $('[data-toggle=tooltip]').tooltip({ 
                  boundary: 'window', 
                  trigger : 'hover'   // Allow button clicks
                })
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Daluren zon/feestdag opgeslagen [' + data.value + '].')
                break
              case 'offPeakDeleteEntry':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Daluren zon/feestdag verwijderd [' + data.value + '].')
                break
              case 'chargerID':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Laadpunt ID gewijzigd in ' + data.value + '.')
                break
              case 'chargerNameText':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Laadpunt naam gewijzigd in ' + data.value + '.')
                break
              case 'factorWhkm':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Whkm factor gewijzigd in ' + data.value + '.')
                break
              case 'chargerTariff':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Laadpunt tarief gewijzigd in ' + data.value + '.')
                break
              case 'smbBackupSettings':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Offsite backup instellingen aangepast.')
                // Now update the fields
                let dObj = JSON.parse(data.value)
                if (dObj.hasOwnProperty('osBackupType')) {
                  switch(dObj.osBackupType) {
                    case '{{ oppleoconfig.OS_BACKUP_TYPE_SMB }}':
                      $('td#osBackupTypeDisplay').text('{{ oppleoconfig.OS_BACKUP_TYPE_SMB_STR }}')
                      break
                    case '{{ oppleoconfig.OS_BACKUP_TYPE_AFP }}':
                      $('td#osBackupTypeDisplay').text('{{ oppleoconfig.OS_BACKUP_TYPE_AFP_STR }}')
                      break
                    case '{{ oppleoconfig.OS_BACKUP_TYPE_ONEDRIVE }}':
                      $('td#osBackupTypeDisplay').text('{{ oppleoconfig.OS_BACKUP_TYPE_ONEDRIVE_STR }}')
                      break
                    case '{{ oppleoconfig.OS_BACKUP_TYPE_ICLOUD }}':
                      $('td#osBackupTypeDisplay').text('{{ oppleoconfig.OS_BACKUP_TYPE_ICLOUD_STR }}')
                      break
                    case '{{ oppleoconfig.OS_BACKUP_TYPE_UNKNOWN }}':
                    deafult:
                      $('td#osBackupTypeDisplay').text('{{ oppleoconfig.OS_BACKUP_TYPE_UNKNOWN_STR }}')
                      break
                  }
                }
                $('td#smbBackupServerNameOrIPAddress').text(dObj.serverOrIP)
                $('td#smbBackupUsername').text(dObj.username)
                $('td#smbBackupPassword').attr('value', dObj.password)
                $('td#smbBackupPassword').text('********')
                let serviceName = ( dObj.serviceName.startsWith('//') ? '' : '//' ) + dObj.serviceName
                $('span#smbBackupServiceName').text( serviceName )
                let remotePath = ( dObj.remotePath.startsWith('/') ? '' : '/' ) +
                                 dObj.remotePath +
                                 ( dObj.remotePath.endsWith('/') ? '' : '/' )
                $('span#smbBackupRemotePath').text( remotePath )
                $('td#currentSmbBackupServiceName').html('<span class="text-secondary">(Huidige service: </span>' +
                                                        '<span class="text-success">' + serviceName + '</span>' +
                                                        '<span class="text-secondary">)</span>'
                                                        )
                $('td#currentSmbBackupRemotePath').html('<span class="text-secondary">(Huidige path: </span>' +
                                                        '<span class="text-success">' + remotePath + '</span>' +
                                                        '<span class="text-secondary">)</span>'
                                                        )
                break
              case 'osBackupEnabled':
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Offsite backup geactiveerd.')
                break

              case 'pushoverApiKey':
              case 'pushoverUserKey':
                if (typeof $('#pushoverApiKey')[0].$input.value === 'string' && $('#pushoverApiKey')[0].$input.value.length > 0) {
                  loadPushoverSounds( $('#pushoverApiKey')[0].$input.value, $($('#pushoverSound')[0].$select).find("option:selected").val() )
                  if (typeof $('#pushoverUserKey')[0].$input.value === 'string' && $('#pushoverUserKey')[0].$input.value.length > 0) {
                    loadPushoverDevices( $('#pushoverUserKey')[0].$input.value, $('#pushoverApiKey')[0].$input.value )
                  }
                }
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Offsite backup geactiveerd.')
                break

              default:
                autoHideNotify('success', 'top-left', 'Gewijzigd', 'Instelling aangepast.')
                break
            }
            break
          case 404:
            autoHideNotify('warning','top-left', 'Onbekend', 'Instelling onbekend (404). Niet gewijzigd.')
            break
          case 405:
            switch (data.param) {
              case 'osBackupEnabled':
                // Simple toggling $('#osBackupEnabled').bootstrapToggle('off') triggers change event (and submit)
                // Thus destroy, update, and recreate.              
                $('#osBackupEnabled').bootstrapToggle('destroy')
                $('#osBackupEnabled').prop("checked", false)
                $('#osBackupEnabled').bootstrapToggle()
                autoHideNotify('warning','top-left', 'Niet toegestaan', 'Activeren offsite backup alleen toegestaan met werkende instellingen (405). Configureer eerst de Offsite Backup instellingen.')
                break
              default:
                autoHideNotify('warning','top-left', 'Niet toegestaan', 'Instelling wijzigen niet toegestaan (405).')
                break
            }
            break
          case 409:
            autoHideNotify('warning', 'top-left', 'Foutmelding', 'Wijziging kon niet doorgevoerd worden. ' + data.reason)
            break
          default:
            autoHideNotify('warning','top-left', 'Onbekend', 'Instelling onbekend. Niet gewijzigd.')
            break
        }

      })
      .fail(function(data) {
        autoHideNotify('error','top-left', 'Connectie fout', 'Instelling niet gewijzigd.')
      })
      .always(function() {
        // Remove spinner
        $('.spinner').hide()
      })
    }

    function getBackupData( req ) {
      console.log(timestamp() + ' getBackupData()')            
      // Show spinner
      $('.spinner').show()
      data = {
            csrf_token    : '{{ csrf_token() }}',
            param         : req
          }
      $.ajax({
        type		    : 'GET',
        url			    : ('/backup/' + encodeURIComponent(req) +'/'),
        dataType	  : 'json',
        headers     : { 'ignore-login-next': 'true' },
        encode		  : true,
        data        : data
      }) // using the done promise callback
      .done(function(data) {
        switch (data.status) {
          case 401:
            // Not authosized response
            autoHideNotify('warning','top-left', 'Autorisatie fout', 'Data niet beschikbaar.')
            break
          case 200:
            // Ok response
            switch (data.cmd) {
              case 'smbshares':
                // Oppleo web component applied change
                $('oppleo-edit-select#smbBackupShareName')[0].setAttribute('options', 
                  '[' + data.smbshares.map(share => '{ "text": "'+share+'", "value": "'+share+'" }').join(", ") + ']'
                )
                $('oppleo-edit-select#smbBackupShareName')[0].render()
                break

              case 'smbvalidateuser':
                // 
                if (data.smbvalidateuser === 'true') {
                  $('button#smbBackupValidatePassword').html('<i class="fas fa-user-check"></i>') 
                  $('button#smbBackupValidatePassword').addClass('btn-outline-success')
                  $('button#smbBackupValidatePassword').removeClass('btn-outline-warning')
                  $('button#smbBackupValidatePassword').removeClass('btn-outline-danger')
                } else {
                  $('button#smbBackupValidatePassword').html('<i class="fas fa-user-slash"></i>') 
                  $('button#smbBackupValidatePassword').removeClass('btn-outline-success')
                  $('button#smbBackupValidatePassword').removeClass('btn-outline-warning')
                  $('button#smbBackupValidatePassword').addClass('btn-outline-danger')
                }

              default:
                break
            }
          default:
            break
        }
      })
      .fail(function(data) {
        autoHideNotify('error','top-left', 'Connectie fout', 'Data niet beschikbaar.')
      })
      .always(function() {
        // Remove spinner
        $('.spinner').hide()
      })
    }

    function offsiteBackupDataReq( req, reqdata={}, successCallback=null, failCallback=null ) {
      console.log(timestamp() + ' offsiteBackupDataReq()')            
      // Show spinner
      $('.spinner').show()
      data = {
        csrf_token    : '{{ csrf_token() }}',
        param         : req,
        data          : JSON.stringify(reqdata)
      }
      $.ajax({
        type		    : 'GET',
        url			    : ('/backup/' + encodeURIComponent(req) +'/' + encodeURIComponent(JSON.stringify(reqdata)) +'/'),
        dataType	  : 'json',
        headers     : { 'ignore-login-next': 'true' },
        encode		  : true,
        data        : data
      }) // using the done promise callback
      .done(function(data) {
        switch (data.status) {
          case 400:   // Bad request
          case 500:   // Internal Server Error
            autoHideNotify('error','top-left', 'Bad request ('+data.status+')', 'Data niet beschikbaar.')
            if (failCallback != null) { failCallback(data) }
            break
          case 401:
            // Not authorized response
            autoHideNotify('warning','top-left', 'Autorisatie fout', 'Data niet beschikbaar.')
            if (failCallback != null) { failCallback(data) }
            break
          case 404:   // Not Found
            if (failCallback != null) { failCallback(data) }
            break
          case 200:
            // Ok response
            switch (data.cmd) {
              case 'smbValidateAccount':
                if (data.validConnection || data.validConnection === 'true') {   // --> tab 1 to tab 2
                  $('a[href="#bm-step3"').tab('show')
                  $("button#modal-footer-prevaction").prop('disabled', false)
                  $('#offsiteBackupServerOrIP')[0].$input.classList.remove("border", "border-danger")
                  $("#bm-step2-msg").html("")
                  $('#offsiteBackupUsername')[0].$input.classList.remove("border", "border-danger")
                  $('#offsiteBackupPassword')[0].$input.classList.remove("border", "border-danger")
                  $('button#modal-footer-nextaction').addClass('btn-primary')
                  $('button#modal-footer-nextaction').removeClass('btn-danger')
                  // Load shares
                  offsiteBackupDataReq( 'smbListServices', 
                        reqdata={ 
                          serverOrIP: $('#offsiteBackupServerOrIP')[0].$input.value, 
                          username: $('#offsiteBackupUsername')[0].$input.value, 
                          password: $('#offsiteBackupPassword')[0].$input.value 
                        })
                } else {                        // --> stay on tab 1
                  if (!data.resolved || data.resolved === 'false') {
                    $("#bm-step2-msg").html("Server niet bereikbaar")
                    $('#offsiteBackupServerOrIP')[0].$input.classList.add("border", "border-danger")
                  } else if (!data.connectionRefused || data.connectionRefused === 'false') {
                    $("#bm-step2-msg").html("Authenticatiefout")
                    $('#offsiteBackupUsername')[0].$input.classList.add("border", "border-danger")
                    $('#offsiteBackupPassword')[0].$input.classList.add("border", "border-danger")
                  } else {
                    $("#bm-step2-msg").html("Onbekende fout")
                  }
                  $('button#modal-footer-nextaction').removeClass('btn-primary')
                  $('button#modal-footer-nextaction').addClass('btn-danger')
                }
                $('button#modal-footer-nextaction').html(' <i class="fas fa-angle-right"></i> ')
                break

              case 'smbListServices':
                if (data.validConnection || data.validConnection === 'true') {
                  // Load shares in selectbox
                  let dObj = []
                  data.shareList.forEach( (v) => {
                    dObj.push( { id: v, text: v  } )
                  })
                  $('oppleo-edit-select#osBackupServiceName').prop('options', JSON.stringify(dObj))

                } else {                        // --> stay on tab 1
                  if (!data.resolved || data.resolved === 'false') {
                    $("#bm-step2-msg").html("Server niet bereikbaar")
                  } else if (!data.connectionRefused || data.connectionRefused === 'false') {
                    $("#bm-step2-msg").html("Authenticatiefout")
                  } else {
                    $("#bm-step2-msg").html("Onbekende fout")
                  }
                }
                break

              case 'smbListDirectories':
                if (data.validConnection || data.validConnection === 'true') {   // --> tab 1 to tab 2
                  // Load directories in selectbox
                  let dObj = []
                  data.directoryList.forEach( (v) => {
                    dObj.push( { id: v, text: v } )
                  })
                  $('oppleo-edit-select#smbBackupRemotePathSelect').prop('options', JSON.stringify(dObj))
                } else {                        // --> stay on tab 1
                  if (!data.resolved || data.resolved === 'false') {
                    $("#bm-step2-msg").html("Server niet bereikbaar")
                  } else if (!data.connectionRefused || data.connectionRefused === 'false') {
                    $("#bm-step2-msg").html("Authenticatiefout")
                  } else {
                    $("#bm-step2-msg").html("Onbekende fout")
                  }
                }
                break

              case 'listLocalBackups':
              case 'listOffsiteBackups':
              case 'createBackupNow':
              case 'removeLocalBackup':
              case 'removeOffsiteBackup':
                // Call callback
                if (successCallback != null) { successCallback(data) }
                break


              default:
                break
            }
            break
          default:
            if (failCallback != null) { failCallback(data) }
            break
        }
      })
      .fail(function(data) {
        autoHideNotify('error','top-left', 'Connectie fout', 'Data niet beschikbaar.')
        if (failCallback != null) { failCallback(data) }
      })
      .always(function() {
        // Remove spinner
        $('.spinner').hide()
      })
    }

    function updateExternalSubnet( subnetOrIP, action, successCallback=null, failCallback=null ) {
      console.log(timestamp() + ' updateExternalSubnet()')            
      // Show spinner
      $('.spinner').show()
      data = {
        csrf_token    : '{{ csrf_token() }}',
        subnetOrIP    : subnetOrIP,
        action        : action
      }
      $.ajax({
        type		    : action,
        url			    : ('/external_subnet/' + encodeURIComponent(subnetOrIP) +'/'),
        dataType	  : 'json',
        headers     : { 'ignore-login-next': 'true' },
        encode		  : true,
        data        : data
      }) // using the done promise callback
      .done(function(data) {
        switch (data.status) {
          case 400:   // Bad request
          case 500:   // Internal Server Error
            autoHideNotify('error','top-left', 'Bad request ('+data.status+')', 'Data niet beschikbaar.')
            if (failCallback != null) { failCallback(data) }
            break
          case 401:
            // Not authorized response
            autoHideNotify('warning','top-left', 'Autorisatie fout', 'Data niet beschikbaar.')
            if (failCallback != null) { failCallback(data) }
            break
          case 404:   // Not Found
            if (failCallback != null) { failCallback(data) }
            break
          case 200:
            // Ok response
            if (successCallback != null) { successCallback(data) }
            break
          default:
            if (failCallback != null) { failCallback(data) }
            break
        }
      })
      .fail(function(data) {
        autoHideNotify('error','top-left', 'Connectie fout', 'Data niet beschikbaar.')
        if (failCallback != null) { failCallback(data) }
      })
      .always(function() {
        // Remove spinner
        $('.spinner').hide()
      })
    }

    var diag_data = {{ diag_json | safe }}
    var diag_hamqtt_data = {{ diag_hamqtt_json | safe }}
    var diag_cht = {{ diag_cht | safe }}
    

    var backupOffsiteDialog = null

    function updateSmbBackupSettings(includeType=false) {
      // Succesful ending, Keep on/off enabled
//      $('td#smbBackupServerNameOrIPAddress').text($('#offsiteBackupServerOrIP')[0].$input.value)
//      $('td#smbBackupPassword').attr('value', $('#offsiteBackupUsername')[0].$input.value)
//      $('td#smbBackupPassword').text('********')
      let serviceName = $($('#osBackupServiceName')[0].$select).find("option:selected").text()
 //     $('span#smbBackupServiceName').text((typeof serviceName == 'string' && serviceName.length > 0 ? '//' + serviceName : ''))
//yyyy
//smbBackupServiceName
//currentSmbBackupServiceName

//      $('td#currentSmbBackupServiceName').html('<span class="text-secondary">(Huidige service: </span>' +
//                                               '<span class="text-success">//' + serviceName + '/</span>' +
//                                               '<span class="text-secondary">)</span>'
//                                              )

      let remotePath = $('#smbBackupRemotePathList ul li').map( (i, el) => {return el.innerText.trim() }).toArray().join('')
//      $('span#smbBackupRemotePath').text(remotePath)
      // - Submit to server
      let smbSetttings = { 
              serverOrIP      : $('#offsiteBackupServerOrIP')[0].$input.value, 
              username        : $('#offsiteBackupUsername')[0].$input.value, 
              password        : $('#offsiteBackupPassword')[0].$input.value,
              serviceName     : serviceName,
              remotePath      : remotePath
      }
      if (includeType) {
        smbSetttings['osBackupType'] = '{{ oppleoconfig.OS_BACKUP_TYPE_SMB }}'
      }
      updateSettings( 'smbBackupSettings', JSON.stringify(smbSetttings) )
      // Close modal dialog
      backupOffsiteDialog.modal('hide')
    }

    function showBackupModal() {
      // Init modal dialog

      // TODO - populate type, serverorip, username and password fields with existing values
      // TODO - ook share en path als er niets wijzigd aan de server en user/pw?
      // XXXX
      // TODO bug bij next na share - button al enabled
      $('#offsiteBackupServerOrIP')[0].$input.classList.remove("border", "border-danger")
      $("#bm-step2-msg").html("")
      $('#offsiteBackupUsername')[0].$input.classList.remove("border", "border-danger")
      $('#offsiteBackupPassword')[0].$input.classList.remove("border", "border-danger")

      $('#osBackupServiceName')[0].$select_container.classList.remove("border", "border-danger")
      $("#bm-step3-msg").html("")

      $('button#modal-footer-nextaction').html(' <i class="fas fa-angle-right"></i> ')

      backupOffsiteDialog.modal('show')
      $('a[href="#bm-step1"').tab('show')
    }

    let backupStatusSocket = null
    /*
      TODO: startBackupStatusWebSocket NEVER gets called!
    */
    function startBackupStatusWebSocket() {
      // start up the SocketIO connection to the server on namespace /backup
      backupStatusSocket = io.connect(window.location.protocol+'//'+window.location.hostname+(window.location.port?':'+window.location.port:'')+'/backup')

      // this is a callback that triggers when the "my response" event is emitted by the server.
      backupStatusSocket.on('backup_started', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        if (msg.id == '{{ oppleoconfig.chargerID }}') {
          $('button#backup-create').prop('disabled', true)
          $('button#backup-create').html(' <i class="fas fa-spinner fa-spin"></i> Backup actief...')
          $('#backupNowStatusText').html('<span class="text-success">Backup gestart op ' + msg.data.started + '</span>')
        }
      })
      backupStatusSocket.on('backup_completed', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        return // ########
        if (msg.id == '{{ oppleoconfig.chargerID }}') {
          // '%Y-%m-%d %H:%M.%S' -> 2011-10-10T14:48:00
          let ts = new Date(msg.data.started.substring(0, 10)+'T'+msg.data.started.replace(/\./g,':').substring(11, 19))
          let tc = new Date(msg.data.completed.substring(0, 10)+'T'+msg.data.completed.replace(/\./g,':').substring(11, 19))
          var elapsed = Math.round((tc - ts) /1000) // convert from milliseconds to seconds
          var elapS = (elapsed > 3600 ? Math.floor(elapsed / 3600) + 'uur, ' : '') +
                      ((elapsed % 3600) > 60 ? Math.floor((elapsed % 3600) /60) + 'min, ' : '') +
                      (elapsed % 60) + 'sec'
          $('#backupNowStatusText').html('<span class="text-success">Backup uitgevoerd op ' + msg.data.completed + ' (' + formatFilesize(msg.data.filesize) + ' in ' + elapS + ')</span>')
          $('#backupSuccessTimestamp').html(ts.getDate()+' '+months[ts.getMonth()]+' '+ts.getFullYear()+' '+
                                            (ts.getHours()<10?'0':'')+ts.getHours()+':'+(ts.getMinutes()<10?'0':'')+ts.getMinutes()+'u'
                                           )
          $('button#backup-create').prop('disabled', false)
          $('button#backup-create').html(' <i class="fas fa-angle-right"></i> Maak backup')
          // Add to local list if visible
          if (!$('tr#localBackupList').hasClass('d-none') && msg.data.localBackupSuccess) {
            // Visible
            let row = $('<tr style="display: none;">')
            let cells = $('<td class="text-center"><i class="far fa-save"></i></td><td>'+msg.data.completed+'</td><td class="text-center">'+formatFilesize(msg.data.filesize)+'</td><td>'+msg.data.filename+'</td><td class="text-center"><button type="button" class="btn btn-xs btn-outline-danger pl-1 pr-1" id="backup-delete-local"> <i class="far fa-trash-alt"></i> </button></td>')
            row.append(cells)
            $('tbody#backupLocalList').prepend(row)
            row.fadeIn(300).fadeOut(300).fadeIn(300).fadeOut(300).fadeIn(300)
            let cnt = parseInt($('#backupLocalCount').text().split(' backups')[0]) +1
            $('#backupLocalCount').html(cnt + ' backups')
            addClickEventToLocalBackupDeleteButton()
          }
          // Add to offsite list if visible and created
          if (!$('tr#offsiteBackupList').hasClass('d-none') && msg.data.osBackupSuccess ) {
            // Visible
            let row = $('<tr style="display: none;">')
            let cells = $('<td class="text-center"><i class="far fa-save"></i></td><td>'+msg.data.completed+'</td><td class="text-center">'+formatFilesize(msg.data.filesize)+'</td><td>'+msg.data.filename+'</td><td class="text-center"><button type="button" class="btn btn-xs btn-outline-danger pl-1 pr-1" id="backup-delete-offsite"> <i class="far fa-trash-alt"></i> </button></td>')
            row.append(cells)
            $('tbody#backupOffsiteList').prepend(row)
            row.fadeIn(300).fadeOut(300).fadeIn(300).fadeOut(300).fadeIn(300)
            let cnt = parseInt($('#backupOffsiteCount').text().split(' backups')[0]) +1
            $('#backupOffsiteCount').html(cnt + ' backups')
            addClickEventToOffsiteBackupDeleteButton()
          }
        }
      })
      backupStatusSocket.on('backup_failed', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        if (msg.id == '{{ oppleoconfig.chargerID }}') {
          $('#backupNowStatusText').html('<span class="text-danger">Backup mislukt! (' + msg.data.reason + ')</span>')
        }
      })

      backupStatusSocket.on('local_backup_purged', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        if (msg.id == '{{ oppleoconfig.chargerID }}') {
          msg.data.forEach( (dbEl, i) => {                    // iterate over deleted backup
            let rows = $('tbody#backupLocalList tr')
            rows.each( (i, vbEl) => {                       // check each row
              let vbElt1 = $(vbEl).find("td:eq(3)").text()  // 3rd column
              if (vbElt1 == dbEl.filename) {
                // remove deleted 
                vbEl.remove()
              }
            })
          })
          let cnt = parseInt($('#backupLocalCount').text().split(' backups')[0]) - msg.data.length
          $('#backupLocalCount').html(cnt + ' backups')
        }
      })
      backupStatusSocket.on('os_backup_purged', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        if (msg.id == '{{ oppleoconfig.chargerID }}') {
          msg.data.forEach( (dbEl, i) => {                    // iterate over deleted backup
            let rows = $('tbody#backupOffsiteList tr')
            rows.each( (i, vbEl) => {                       // check each row
              let vbElt1 = $(vbEl).find("td:eq(3)").text()  // 3rd column
              if (vbElt1 == dbEl.filename) {
                // remove deleted 
                vbEl.remove()
              }
            })
          })
          let cnt = parseInt($('#backupOffsiteCount').text().split(' backups')[0]) - msg.data.length
          $('#backupOffsiteCount').html(cnt + ' backups')
          // TODO xxxxx
        }
      })
    }

    let settingsStatusSocket = null
    function startSettingsStatusWebSocket() {

      // start up the SocketIO connection to the server on namespace /settings
      settingsStatusSocket = io.connect(window.location.protocol+'//'+window.location.hostname+(window.location.port?':'+window.location.port:'')+'/settings')

      // this is a callback that triggers when the "my response" event is emitted by the server.

      settingsStatusSocket.on('ha_mqtt_status_update', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        $('span#ha_mqtt_status_disconnected').toggleClass('d-none', msg.data.state != 'DISCONNECTED')
        $('span#ha_mqtt_status_connected').toggleClass('d-none', msg.data.state != 'CONNECTED')
        $('span#ha_mqtt_status_connect_failed').toggleClass('d-none', msg.data.state != 'FAILED')
        $('span#ha_mqtt_status_not_authorized').toggleClass('d-none', msg.data.state != 'NOT_AUTHORIZED')
        $('span#ha_mqtt_status_unreachable').toggleClass('d-none', msg.data.state != 'UNREACHABLE')
        $('span#ha_mqtt_status_other').toggleClass('d-none', msg.data.state != 'OTHER')

        $('button#triggeraction-ha-mqtt-send-autodiscovery').attr('disabled', msg.data.state != 'CONNECTED')
        $('button#triggeraction-ha-mqtt-send-most-recent').attr('disabled', msg.data.state != 'CONNECTED')
      })

      settingsStatusSocket.on('ha_mqtt_autodiscover', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
      })
      settingsStatusSocket.on('ha_mqtt_message_send', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
      })

      settingsStatusSocket.on('ha_mqtt_ha_status', function(msg) {
        // HomeAssistant has announced to be online/ offline
        console.log('Received: ' + JSON.stringify(msg))
        $('span#ha_mqtt_ha_offline').toggleClass('d-none', msg.data.state != 'OFFLINE')
        $('span#ha_mqtt_ha_online').toggleClass('d-none', msg.data.state != 'ONLINE')
        $('span#ha_mqtt_ha_unknown').toggleClass('d-none', msg.data.state != 'UNKNOWN')
      })
    }


    function updateMqttHistoryControls(status) {
      // Enable correct buttons
      $('button#mqtt-send-history-start').attr('disabled', (status == 'started'))
      $('button#mqtt-send-history-start').toggleClass('btn-outline-warning', (status != 'started'))
      $('button#mqtt-send-history-start').toggleClass('btn-outline-secondary', (status == 'started'))
      $('button#mqtt-send-history-pause').attr('disabled', (status != 'started'))
      $('button#mqtt-send-history-pause').toggleClass('btn-outline-success', (status == 'started'))
      $('button#mqtt-send-history-pause').toggleClass('btn-outline-secondary', (status != 'started'))
      $('button#mqtt-send-history-cancel').attr('disabled', (status != 'started' && status != 'paused'))
      $('button#mqtt-send-history-cancel').toggleClass('btn-outline-danger', (status == 'started' || status == 'paused'))
      $('button#mqtt-send-history-cancel').toggleClass('btn-outline-secondary', (status != 'started' && status != 'paused'))
    }

    function formatTimeperiod(timeInSeconds) {
      let fs = ''
      // Days
      if (timeInSeconds > (60*60*24)) {
        let days = Math.floor( timeInSeconds / (60*60*24) )
        fs += days + ( days > 1 ? " dagen " : " dag " )
        timeInSeconds -= ( days * (60*60*24) )
      }
      // Hours
      let hours = Math.floor( timeInSeconds / (60*60) )
      fs += ( hours < 10 ? "0" : "" ) + hours + ":"
      timeInSeconds -= ( hours * (60*60) )
      // Minutes
      let minutes = Math.floor( timeInSeconds / (60) )
      fs += ( minutes < 10 ? "0" : "" ) + minutes + ":"
      timeInSeconds -= ( minutes * (60) )
      // Seconds
      let seconds = Math.floor( timeInSeconds )
      fs += ( seconds < 10 ? "0" : "" ) + seconds + "u"
      return fs
    }


    function updateMqttHistoryStatusMessage(data) {
      // msg.data.remaining
      console.log(data)
      if (data.process == 'initial') {
        $("span#mqtt-send-history-progress.info").attr('data-original-title', '')
        $("span#mqtt-send-history-progress-info").fadeOut(2500)
        $("span#mqtt-send-history-progress").attr('data-original-title', '')
        $("span#mqtt-send-history-progress").slideUp(2500)
        return
      }
      let progressTooltip = ""
      progress = (Math.floor((data.processed/data.total)*100))
      switch (data.process) {
        case 'started':
          progressTooltip = "<span class='text-primary'>Actief [" + progress + "%]</span><br>"
          break
        case 'paused':
          progressTooltip = "<span class='text-primary'>Gepauzeerd [" + progress + "%]</span><br>"
          break
        case 'cancelled':
          progressTooltip = "<span class='text-primary'>Geannuleerd [" + progress + "%]</span><br>"
          break
        case 'completed':
          progressTooltip = "<span class='text-primary'>Afgerond</span><br>"
          break
        default:
          progressTooltip = "<span class='text-primary'>Onbekend</span><br>"
          break
      }

      progressTooltip += "Totaal: "+data.total.toLocaleString('nl')+"<br>"
      progressTooltip += "Verwerkt: "+data.processed.toLocaleString('nl')+"<br>"
      progressTooltip += "Duur: "+formatTimeperiod(data.processingtime)+"<br>"
      if (data.settings.batchProcessing) {
        progressTooltip += "Batch omvang: "+data.settings.batchSize.toLocaleString('nl')+"<br>"
      }
      progressTooltip += "MQTT berichten: "+data.mqttEvents.toLocaleString('nl')+"<br>"
      progressTooltip += "MQTT delay: "+Math.floor(data.settings.delayBetweenMqttMessages*1000)+"ms<br>"
      progressTooltip += "Status updates: "+data.frontEndUpdates.toLocaleString('nl')+"<br>"
      progressTooltip += "Update interval: "+data.settings.timeBetweenFrontEndUpdates.toLocaleString('nl')+"s<br>"
      if (data.hasOwnProperty('tps') && data.hasOwnProperty('currentTps')) {
        if (data.process == 'started') {
          progressTooltip += "Snelheid: "+data.currentTps+"/s<br>"
        }
        if (data.process != 'initial') {
          progressTooltip += "Gemiddeld: "+data.tps+"/s<br>"
        }
      }
      if (data.hasOwnProperty('timeremaining')) {
        progressTooltip += "Resterend (geschat): "+formatTimeperiod(data.timeremaining)
      }

      $("span#mqtt-send-history-progress-info").attr('data-original-title', progressTooltip)
      if ($("span#mqtt-send-history-progress-info:hover").length != 0) {
        // Mouse over, force replace tooltip
        $("span#mqtt-send-history-progress-info").tooltip("dispose").tooltip('show')
      }
      if (data.process != 'initial') {
        $("span#mqtt-send-history-progress-info").fadeIn(2500)
      } else {
        $("span#mqtt-send-history-progress-info").fadeOut(2500)
      }
      
      $("span#mqtt-send-history-progress").attr('data-original-title', progress+"%")
      if ($("span#mqtt-send-history-progress:hover").length != 0) {
        // Mouse over, force replace tooltip
        $("span#mqtt-send-history-progress").tooltip("dispose").tooltip('show')
      }
      if (['initial', 'cancelled', 'completed'].includes(data.process)) {
        $("span#mqtt-send-history-progress").slideUp(2500)
      }
      if (['started', 'paused'].includes(data.process)) {
        $("span#mqtt-send-history-progress").slideDown()
      }
      $('div#mqtt-send-history-progress-bar').css( 'width', progress+"%")
      $('div#mqtt-send-history-progress-bar').toggleClass( 'progress-bar-animated', (data.process == 'started') )
      $('div#mqtt-send-history-progress-bar').toggleClass( 'bg-success', (data.process == 'started') )
      $('div#mqtt-send-history-progress-bar').toggleClass( 'bg-secondary', (data.process != 'started') )
    }

    function requestMqttHistoryStatus() {
      mqttHistory( undefined, 'GET', function(result) {
          // Success
          console.log(result)
          switch (result.status) {
            case 200:
              // Enable buttons
              updateMqttHistoryControls(result.details.process)
              updateMqttHistoryStatusMessage(result.details)
              break
            default:
              autoHideNotify('warning','top-left', 'Server fout', 'Kon geen MQTT Historieverzenden status opvragen.')
              break
          }
        }, function(result) {
          // Failed
          autoHideNotify('warning','top-left', 'Server fout', 'Kon geen MQTT Historieverzenden status opvragen.')
        }, function(result) {
          // Always
        }
      )
    }

    let mqttHistoryStatusSocket = null
    function startMqttHistoryStatusWebSocket() {
      // start up the SocketIO connection to the server on namespace /backup
      mqttHistoryStatusSocket = io.connect(window.location.protocol+'//'+window.location.hostname+(window.location.port?':'+window.location.port:'')+'/mqtt')
      // this is a callback that triggers when the "my response" event is emitted by the server.
      mqttHistoryStatusSocket.io.on("reconnect", (attempt) => {
        requestMqttHistoryStatus()
      })
      mqttHistoryStatusSocket.on('mqtt_send_history_init', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        updateMqttHistoryControls(msg.data.process)
        updateMqttHistoryStatusMessage(msg.data)
      })
      mqttHistoryStatusSocket.on('mqtt_send_history_started', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        updateMqttHistoryControls(msg.data.process)
        updateMqttHistoryStatusMessage(msg.data)
      })
      mqttHistoryStatusSocket.on('mqtt_send_history_update', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        updateMqttHistoryControls(msg.data.process)
        updateMqttHistoryStatusMessage(msg.data)
      })
      mqttHistoryStatusSocket.on('mqtt_send_history_paused', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        updateMqttHistoryControls(msg.data.process)
        updateMqttHistoryStatusMessage(msg.data)
      })
      mqttHistoryStatusSocket.on('mqtt_send_history_cancelled', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        updateMqttHistoryControls(msg.data.process)
        updateMqttHistoryStatusMessage(msg.data)
      })
      mqttHistoryStatusSocket.on('mqtt_send_history_completed', function(msg) {
        console.log('Received: ' + JSON.stringify(msg))
        updateMqttHistoryControls(msg.data.process)
        updateMqttHistoryStatusMessage(msg.data)
      })
    }




    function addClickEventToLocalBackupDeleteButton() {
      // Remove existing click event handlers
      $('button#backup-delete-local').off('click')
      // Remove existing click event handlers
      $('button#backup-delete-local').on('click', function(ev) {
        let backupFilename = $(ev.currentTarget).parent().prev().text()
        $(ev.currentTarget).prop('disabled', true)
        offsiteBackupDataReq( 'removeLocalBackup', reqdata={ filename: $(ev.currentTarget).parent().prev().text() }, function(result) {
          autoHideNotify('success','top-left', 'Backup verwijderd', 'Lokale backup is verwijderd.')
          // remove from list
          $(ev.currentTarget).parent().parent().fadeOut(300).fadeIn(300).fadeOut(300, function() { $(this).remove() })
          let cnt = parseInt($('#backupLocalCount').text().split(' backups')[0]) -1
          $('#backupLocalCount').html(cnt + ' backups')
        }, function(result) {
          autoHideNotify('error','top-left', 'Backup niet verwijderd', 'Het verwijderen van de lokale backup is niet gelukt ('+result.status+').')
          $(ev.currentTarget).prop('disabled', false)
        })
      })
    }

    function addClickEventToOffsiteBackupDeleteButton() {
      // Remove existing click event handlers
      $('button#backup-delete-offsite').off('click')
      // Remove existing click event handlers
      $('button#backup-delete-offsite').on('click', function(ev) {
        let backupFilename = $(ev.currentTarget).parent().prev().text()
        $(ev.currentTarget).prop('disabled', true)
        offsiteBackupDataReq( 'removeOffsiteBackup', reqdata={ filename: $(ev.currentTarget).parent().prev().text() }, function(result) {
          autoHideNotify('success','top-left', 'Backup verwijderd', 'Offsite backup is verwijderd.')
          // remove from list
          $(ev.currentTarget).parent().parent().fadeOut(300).fadeIn(300).fadeOut(300, function() { $(this).remove() })
          let cnt = parseInt($('#backupOffsiteCount').text().split(' backups')[0]) -1
          $('#backupOffsiteCount').html(cnt + ' backups')
        }, function(result) {
          autoHideNotify('error','top-left', 'Backup niet verwijderd', 'Het verwijderen van de offsite backup is niet gelukt ('+result.status+').')
          $(ev.currentTarget).prop('disabled', false)
        })
      })
    }

    // 
    function buttonSubnetOrIPDelete(e) {
      console.log(e.currentTarget)
      e.preventDefault()
      $(e.currentTarget).tooltip('hide') // Make sure tooltips don't remain 
      let value = $(e.currentTarget).parent().children('span.subnetOrIP').text()
      // Submit
      updateExternalSubnet( value, 'DELETE', 
        function(result) {
          // successCallback
          autoHideNotify('success','top-left', 'Verwijderd', 'Het IP of subnet is verwijderd.')
          // Remove this row if not the first row, and move everything up one row
          let el = $("span.subnetOrIP:contains('"+result.subnetOrIP32+"')")
          let cnt = $("span.subnetOrIP").length
          let pel = el.parent().parent() // td - tr
          pel = el.closest('tr')
          let elIdx = (pel.prevAll('.subnetOrIPRow').length + 1)
          // Only one entry, delete and show empty
          if (pel.is('.subnetOrIPRow') && cnt == 1) {
            // First row, and only. Remove
            pel.find('td:nth-child(2)').empty()
            pel.find('td:nth-child(2)').append('<span class="subnetOrIP"><i class="far fa-clipboard"></i> <span class="pl-2">Geen</span></span>')
          }
          // Multiple entries, and first one deleted, move one up
          if (pel.is('.subnetOrIPRow') && cnt > 1 && elIdx == 1) {
            // First row, move second one up and remove that one
            let pel2 = pel.next()
            //pel.find('td:nth-child(2)').html(pel2.find('td:nth-child(2)').html())
            pel.find('td:nth-child(2)').empty()
            pel.find('td:nth-child(2)').append(pel2.find('td:nth-child(2)').contents())
            pel2.remove()
          }
          // Multiple entries, and not first one deleted, just remove
          if (pel.is('.subnetOrIPRow') && cnt > 1 && elIdx > 1) {
            // Not the first row, just remove this one
            pel.remove()
          }
        }, function(result) {
          // failCallback
          if (!([400, 401, 404, 500].includes(result.status))) {
              autoHideNotify('error','top-left', 'Niet verwijderd', 'Het verwijderen van het IP adres is niet gelukt ('+result.status+').')
          }
      })
    }

    function activatekWhMeterSettings$(enabled=false, simulating=false) {
      // Cancel editing
      $('oppleo-edit-str#port_name')[0].cancel()
      $('oppleo-edit-str#slave_address')[0].cancel()
      $('oppleo-edit-select#mode')[0].cancel()
      $('oppleo-edit-select#baudrate')[0].cancel()
      $('oppleo-edit-select#bytesize')[0].cancel()
      $('oppleo-edit-select#stopbits')[0].cancel()
      $('oppleo-edit-select#parity')[0].cancel()
      $('oppleo-edit-str#serial_timeout')[0].cancel()
      $('oppleo-edit-select#modbusConfig')[0].cancel()
      $('oppleo-edit-str#modbusInterval')[0].cancel()
      // Disable
      $('oppleo-edit-str#port_name')[0].disable(enabled||simulating)
      $('oppleo-edit-str#slave_address')[0].disable(enabled||simulating)
      $('oppleo-edit-select#mode')[0].disable(enabled||simulating)
      $('oppleo-edit-select#baudrate')[0].disable(enabled||simulating)
      $('oppleo-edit-select#bytesize')[0].disable(enabled||simulating)
      $('oppleo-edit-select#stopbits')[0].disable(enabled||simulating)
      $('oppleo-edit-select#parity')[0].disable(enabled||simulating)
      $('oppleo-edit-str#serial_timeout')[0].disable(enabled||simulating)
      $('oppleo-edit-select#modbusConfig')[0].disable(enabled||simulating)
      $('oppleo-edit-str#modbusInterval')[0].disable(enabled||simulating)

      $('input#simulate').bootstrapToggle('destroy')
      $('input#simulate').attr('data-onstyle', (enabled?"secondary":"primary"))
      $('input#simulate').attr("disabled",enabled)
      $('input#simulate').bootstrapToggle()

      $('input#energyDeviceEnabled').bootstrapToggle('destroy')
      $('input#energyDeviceEnabled').attr('data-onstyle', (simulating?"secondary":"primary"))
      $('input#energyDeviceEnabled').attr("disabled",simulating)
      $('input#energyDeviceEnabled').bootstrapToggle()

      $('input#close_port_after_each_call').bootstrapToggle('destroy')
      $('input#close_port_after_each_call').attr('data-onstyle', (enabled||simulating?"secondary":"primary"))
      $('input#close_port_after_each_call').attr("disabled",enabled||simulating)
      $('input#close_port_after_each_call').bootstrapToggle()

      $('span#energyDeviceEnabledInfo').toggleClass('text-secondary', !enabled)
      $('span#energyDeviceEnabledInfo').toggleClass('text-warning', enabled)
      $('span#energyDeviceEnabledInfo').toggleClass('font-italic', !enabled)

      $('span#energyDeviceSimulateInfo').toggleClass('text-secondary', !simulating)
      $('span#energyDeviceSimulateInfo').toggleClass('text-warning', simulating)
      $('span#energyDeviceSimulateInfo').toggleClass('font-italic', !simulating)

    }

    jQuery(document).ready(function() {
      console.log(timestamp() + " file load completed!")
      $('pre#diag_json').html( 
        JSON.stringify(diag_data, undefined, 2) 
      )
      $('pre#diag_json').show()
      $('pre#diag_hamqtt_json').html( 
        JSON.stringify(diag_hamqtt_data, undefined, 2) 
      )
      $('pre#diag_hamqtt_json').show()
      $('pre#diag_cht').html( 
        JSON.stringify(diag_cht, undefined, 2) 
      )
      $('pre#diag_cht').show()
      $('input#allowPeakOnePeriod').bootstrapToggle()
      $('input#allowPeakOnePeriod').change(function() {
        updateSettings( 'allowPeakOnePeriod', $(this).prop('checked') )
      })
      $('input#offpeakEnabled').bootstrapToggle()
      $('input#offpeakEnabled').change(function() {
        updateSettings( 'offpeakEnabled', $(this).prop('checked') )
      })
      $('input#prowlEnabled').change(function() {
        updateSettings( 'prowlEnabled', $(this).prop('checked') )
      })
      $('input#webChargeOnDashboard').change(function() {
        updateSettings( 'webChargeOnDashboard', $(this).prop('checked') )
      })
      $('input#authWebCharge').change(function() {
        updateSettings( 'authWebCharge', $(this).prop('checked') )
      })
      $('input#vehicleDataOnDashboard').change(function() {
        updateSettings( 'vehicleDataOnDashboard', $(this).prop('checked') )
      })
      $('input#wakeupVehicleOnDataRequest').change(function() {
        updateSettings( 'wakeupVehicleOnDataRequest', $(this).prop('checked') )
      })

      $('input#restrictMenu').change(function() {
        updateSettings( 'restrictMenu', $(this).prop('checked') )
      })
      $('input#restrictDashboardAccess').change(function() {
        updateSettings( 'restrictDashboardAccess', $(this).prop('checked') )
      })
      $('input#allowLocalDashboardAccess').change(function() {
        updateSettings( 'allowLocalDashboardAccess', $(this).prop('checked') )
      })
      $('input#bypassLocal2FA').change(function() {

        // TODO: if 2FA enabled, check 2FA!
        //       make field in database and oppleoConfig
        //       add to flaskRoute.py

        updateSettings( 'bypassLocal2FA', $(this).prop('checked') )
      })
      
      $('input#autoSessionEnabled').bootstrapToggle()
      $('input#autoSessionEnabled').change(function() {
        updateSettings( 'autoSessionEnabled', $(this).prop('checked') )
      })
      $('input#autoSessionCondenseSameOdometer').bootstrapToggle()
      $('input#autoSessionCondenseSameOdometer').change(function() {
        updateSettings( 'autoSessionCondenseSameOdometer', $(this).prop('checked') )
      })
      $('input#energyDeviceEnabled').bootstrapToggle()
      $('input#energyDeviceEnabled').change(function() {
        // Only allow changes if this is disabled
        activatekWhMeterSettings$( $(this).prop('checked'), $('input#simulate').prop('checked') )
        updateSettings( 'energyDeviceEnabled', $(this).prop('checked') )
      })
      // Default
      activatekWhMeterSettings$( {% if energydevicemodel.device_enabled %}true{% else %}false{% endif %} )
      $('input#simulate').change(function() {
        activatekWhMeterSettings$( $('input#energyDeviceEnabled').prop('checked'), $(this).prop('checked') )
        updateSettings( 'simulate', $(this).prop('checked') )
      })
      $('input#close_port_after_each_call').change(function() {
        updateSettings( 'close_port_after_each_call', $(this).prop('checked') )
      })

      $('input#oppleoLedEnabled').change(function() {
        updateSettings( 'oppleoLedEnabled', $(this).prop('checked') )
      })
      $('input#buzzerEnabled').change(function() {
        updateSettings( 'buzzerEnabled', $(this).prop('checked') )
      })
      $('input#evseLedReaderEnabled').change(function() {
        updateSettings( 'evseLedReaderEnabled', $(this).prop('checked') )
      })
      $('input#evseSwitchEnabled').change(function() {
        updateSettings( 'evseSwitchEnabled', $(this).prop('checked') )
      })
      $('input#rfidEnabled').change(function() {
        updateSettings( 'rfidEnabled', $(this).prop('checked') )
      })

      // Add 'bootstrapToggle_' to the id field, and use the parameter name after
      $('input[id^=bootstrapToggle]').bootstrapToggle()
      $('input[id^=bootstrapToggle]').change(function() {
        updateSettings( 
          $(this).attr("id").replace('bootstrapToggle_', ''), 
          $(this).prop('checked')
        )
      })
      $('td[id^=offPeak] > div:nth-child(2)').each(function( index ) {
        var id = $(this).parent().attr("id")
        for (i = 0; i < 24; i++) {
          $(this).append( "<span style='color: #00b19d;'>" + (i %24) + "</span>" )
        }
      })
      $('#holidayDate').datepicker({
          todayHighlight: true,
          autoclose: true,
          startDate : undefined,
          endDate   : undefined,
          format: "d MM yyyy",    // 7 January 2020
          language: 'nl'
      })
      $('#offPeakNewDate').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        // Clean data fields
        $('#holidayDate').val('')
        $('#holidayDescription').val('')
        // Set recurring to false
        $('#offPeakNewRecurring').find('i').toggleClass('fa-calendar-day', true)
        $('#offPeakNewRecurring').find('i').toggleClass('fa-redo-alt', false)
        // Show input
        $('tr#offPeakNewHolidayDate').toggle(200)
        $('#offPeakNewCancel').show()
        $('#offPeakNewSave').show()
        $(this).hide()
      })
      $('#offPeakNewCancel').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        $('tr#offPeakNewHolidayDate').toggle(200)
        $('#offPeakNewDate').show()
        $('#offPeakNewSave').hide()
        $(this).hide()
      })
      $('#offPeakNewRecurring').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        $(this).find('i').toggleClass('fa-calendar-day')
        $(this).find('i').toggleClass('fa-redo-alt')
      })
      $('#offPeakNewSave').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        hDayDate = $('#holidayDate').val()
        hDaySplit = hDayDate.split(' ')
        if (hDaySplit == undefined || hDaySplit.length < 3) {
          autoHideNotify('warning', 'top-left', 'Waarschuwing', 'Geen of onjuist datumveld ingevoerd. Zon/feestdag niet opgeslagen...')
          return
        }
        hDayMonth = -1
        $.each(months, function(i, month) {
					if (month == hDaySplit[1]) {
            hDayMonth = i
					}
				})
        if (hDayMonth == -1) {
          autoHideNotify('warning', 'top-left', 'Waarschuwing', 'Geen of onjuist datumveld ingevoerd. Zon/feestdag niet opgeslagen...')
          return
        }
        // Found the 0-based (js) month. translate to python/db 1-based month (0->1, 11->12, never wraps)
        hDayMonth = parseInt(hDayMonth) +1
        desc = $('#holidayDescription').val()
        if (desc.length == 0) {
          autoHideNotify('warning', 'top-left', 'Waarschuwing', 'Geen omschrijving ingevoerd. Zon/feestdag niet opgeslagen...')
          return
        }
        recurring = $('button#offPeakNewRecurring').html().indexOf("fa-redo-alt") >= 0
        updateSettings( 'offPeakAddHolidayEntry', hDaySplit[0] + '|' + hDayMonth + '|' + hDaySplit[2] + '|' + recurring + '|' + encodeURI(desc) )
        $('tr#offPeakNewHolidayDate').toggle()
        $('#offPeakNewDate').show()
        $('#offPeakNewSave').hide()
        $('#offPeakNewCancel').hide()
      })
      // Add delete buttons
      $('button[id^=offPeakDelete]').on('click', function(e) {
        $(this).tooltip('hide') // Make sure tooltips don't remain 
        var id = $(this).attr("id").replace("offPeakDelete_", "")
        updateSettings( 'offPeakDeleteEntry', id )
        // Remove from view
        $('tr#offPeakHoliday_' + id).remove()
      })
      $('button[data-toggle=tooltip]').tooltip({ 
        boundary: 'window',
        trigger : 'hover'   // Allow button clicks
      })
      // Oppleo web component applied change
      $('oppleo-edit-str').on('apply', (e) => {
        console.log('oppleo-edit-str onApply [' + e.target.id + '] oldValue:' + e.detail.oldValue + ' newValue:' + e.detail.newValue)
        // Pushover?
        if (e.target.id == 'pushoverApiKey' || e.target.id == 'pushoverUserKey') {
          let pushoverSound = $($('#pushoverSound')[0].$select).find("option:selected").val()
          let pushoverSoundName = $($('#pushoverSound')[0].$select).find("option:selected").text()
          $('oppleo-edit-select#pushoverSound').prop('options', JSON.stringify([{ id: pushoverSound, text: pushoverSoundName, selected: true }]))
          let device = $($('#pushoverDevice')[0].$select).find("option:selected").val()
          let deviceName = $($('#pushoverDevice')[0].$select).find("option:selected").text()
          $('oppleo-edit-select#pushoverDevice').prop('options', JSON.stringify([{ id: device, text: deviceName, selected: true }]))
        }
        // Submit
        updateSettings( e.target.id, e.detail.newValue )
      })
      // Oppleo web component applied change
      $('oppleo-edit-select').on('apply', (e) => {
        console.log('oppleo-edit-str onApply [' + e.target.id + '] oldValue:' + e.detail.oldValue + ' oldText:' + e.detail.oldText + ' newValue:' + e.detail.newValue + ' newText:' + e.detail.newText)
        if (e.target.id == 'backupInterval' && e.detail.newValue == '{{ oppleoconfig.BACKUP_INTERVAL_WEEKDAY }}') {
          $('#backupDayOfMonthRow').addClass('d-none')
          $('#backupDayOfWeekRow').removeClass('d-none')
        }
        if (e.target.id == 'backupInterval' && e.detail.newValue == '{{ oppleoconfig.BACKUP_INTERVAL_CALDAY }}') {
          $('#backupDayOfMonthRow').removeClass('d-none')
          $('#backupDayOfWeekRow').addClass('d-none')
        }
        // Submit
        updateSettings( e.target.id, e.detail.newValue )
      })
      // Oppleo web component applied change
      $('oppleo-edit-time').on('apply', (e) => {
        console.log('oppleo-edit-time onApply [' + e.target.id + '] oldValue:' + e.detail.oldValue + ' newValue:' + e.detail.newValue)
        // Submit
        updateSettings( e.target.id, e.detail.newValue )
      })

      $('button#softwateUpdateCheck').on('click', getSoftwareStatus)
      
      // --- Backup

      // Fill the backup weekday and calday fields
      let weekDays = JSON.parse('{{ oppleoconfig.backupIntervalWeekday }}')
      $('tr#backupDayOfWeekRow input:checkbox').each((i, el) => {
        $(el).prop('checked', weekDays[parseInt(el.id.replace('backupDayOfWeekDay',''))])
      })
      $('tr#backupDayOfWeekRow input:checkbox').on( "change", (ev) => {
        let cbs = []
        $('tr#backupDayOfWeekRow input:checkbox').each((i, el) => {
          cbs[parseInt(el.id.replace('backupDayOfWeekDay',''))] = $(el).prop('checked')
        })
        updateSettings( 'backupIntervalWeekday', JSON.stringify(cbs) )
      })
      let calDays = JSON.parse('{{ oppleoconfig.backupIntervalCalday }}') // 0-based
      $('tr#backupDayOfMonthRow input:checkbox').each((i, el) => {
        $(el).prop('checked', calDays[parseInt(el.id.replace('backupDayOfMonthDay',''))-1])
      })
      $('tr#backupDayOfMonthRow input:checkbox').on( "change", (ev) => {
        let cbs = []
        $('tr#backupDayOfMonthRow input:checkbox').each((i, el) => {
          cbs[parseInt(el.id.replace('backupDayOfMonthDay',''))] = $(el).prop('checked')
        })
        updateSettings( 'backupIntervalCalday', JSON.stringify(cbs) )
      })

      $('button#backup-create').on('click', function(ev) {
        $('button#backup-create').prop('disabled', true)
        offsiteBackupDataReq( 'createBackupNow', reqdata={}, function(result) {
          // Button enabled after websocket message backup completed
        }, function(result) {
          // Fail
          autoHideNotify('error','top-left', 'Backup maken mislukt', 'Het maken van een backup is mislukt.')
          $('button#backup-create').prop('disabled', false)
          $('button#backup-create').html(' <i class="fas fa-angle-right"></i> Maak backup')
        })
      })
      $('button#backup-local-showinfo').on('click', function(ev) {
        $('button#backup-local-showinfo').prop('disabled', true)
        $('button#backup-local-showinfo').html(' <i class="fas fa-spinner fa-spin"></i> Ophalen...')
        offsiteBackupDataReq( 'listLocalBackups', reqdata={}, function(result) {
          $('tr#localBackupList').removeClass('d-none')
          $('tbody#backupLocalList tr').remove()
          // YYYY-MM-DD HH.mm.ss => YYYY-MM-DDTHH:mm:ss.sss
          result.localBackupList.sort(function(elA, elB) {
            let [elAd, elAt] = elA.timestamp.split(' ')
            let [elBd, elBt] = elB.timestamp.split(' ')
            let elAdo = new Date(elAd +'T'+elAt.replace(/\./g,':'))
            let elBdo = new Date(elBd +'T'+elBt.replace(/\./g,':'))
            // return >0 sort B before A
            return ( elBdo.getTime() > elAdo.getTime() ? 1 : ( elBdo.getTime() < elAdo.getTime() ? -1 : 0 ) )
          })
          result.localBackupList.forEach( (el, i ) => {
            let row = $('<tr style="display: none;">')
            let cells = $('<td class="text-center"><i class="far fa-save"></i></td><td>'+el.timestamp+'</td><td class="text-center">'+formatFilesize(el.filesize)+'</td><td>'+el.filename+'</td><td class="text-center"><button type="button" class="btn btn-xs btn-outline-danger pl-1 pr-1" id="backup-delete-local"> <i class="far fa-trash-alt"></i> </button></td>')        
            row.append(cells)
            $('tbody#backupLocalList').append(row)
            row.delay(i*150).fadeIn(300)
          })
          addClickEventToLocalBackupDeleteButton()
          $('#backupLocalCount').html(result.localBackupList.length + ' backups')
          $('button#backup-local-showinfo').prop('disabled', false)
          $('button#backup-local-showinfo').html(' <i class="fas fa-angle-right"></i> Gegevens vernieuwen')
        }, function(result) {
          // Fail
          $('button#backup-local-showinfo').prop('disabled', false)
          $('button#backup-local-showinfo').html(' <i class="fas fa-angle-right"></i> Gegevens ophalen')
        })
      
      })
      $('button#backup-offsite-showinfo').on('click', function(ev) {
        $('button#backup-offsite-showinfo').prop('disabled', true)
        $('button#backup-offsite-showinfo').html(' <i class="fas fa-spinner fa-spin"></i> Ophalen...')
        offsiteBackupDataReq( 'listOffsiteBackups', reqdata={}, function(result) {
          $('tr#offsiteBackupList').removeClass('d-none')
          $('tbody#backupOffsiteList tr').remove()
          // YYYY-MM-DD HH.mm.ss => YYYY-MM-DDTHH:mm:ss.sss
          result.osBackupList.sort(function(elA, elB) {
            let [elAd, elAt] = elA.timestamp.split(' ')
            let [elBd, elBt] = elB.timestamp.split(' ')
            let elAdo = new Date(elAd +'T'+elAt.replace(/\./g,':'))
            let elBdo = new Date(elBd +'T'+elBt.replace(/\./g,':'))
            // return >0 sort B before A
            return ( elBdo.getTime() > elAdo.getTime() ? 1 : ( elBdo.getTime() < elAdo.getTime() ? -1 : 0 ) )
          })
          result.osBackupList.forEach( (el, i ) => {
            let row = $('<tr style="display: none;">')
            let cells = $('<td class="text-center"><i class="far fa-save"></i></td><td>'+el.timestamp+'</td><td class="text-center">'+formatFilesize(el.filesize)+'</td><td>'+el.filename+'</td><td class="text-center"><button type="button" class="btn btn-xs btn-outline-danger pl-1 pr-1" id="backup-delete-offsite"> <i class="far fa-trash-alt"></i> </button></td>')        
            row.append(cells)
            $('tbody#backupOffsiteList').append(row)
            row.delay(i*150).fadeIn(300)
          })
          addClickEventToOffsiteBackupDeleteButton()
          $('#backupOffsiteCount').html(result.osBackupList.length + ' backups')
          $('button#backup-offsite-showinfo').prop('disabled', false)
          $('button#backup-offsite-showinfo').html(' <i class="fas fa-angle-right"></i> Gegevens vernieuwen')
        }, function(result) {
          switch(result.status) {
            case 404:
              autoHideNotify('warning','top-left', 'Onbekend', 'Fout bij het ophalen van de gegevens.')
              break
            default:
              autoHideNotify('error','top-left', 'Onbekend', 'Fout bij het ophalen van de gegevens.')
          }
          // Fail
          $('button#backup-offsite-showinfo').prop('disabled', false)
          $('button#backup-offsite-showinfo').html(' <i class="fas fa-angle-right"></i> Gegevens ophalen')
        } )
      })

      $('button#smbBackupValidatePassword').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        // Clean data fields
        getBackupData('smbvalidateuser')
        $('button#smbBackupValidatePassword').html('<i class="fas fa-user-cog"></i>') 
        $('button#smbBackupValidatePassword').removeClass('btn-outline-success')
        $('button#smbBackupValidatePassword').addClass('btn-outline-warning')
        $(this).tooltip('hide')
      })     
      $('#smbBackupSelectShare').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        // Clean data fields
        getBackupData('smbshares')
        $(this).tooltip('hide')
      })

      let mrbs = '{{ oppleoconfig.backupSuccessTimestamp }}'
      let mrbd = new Date(mrbs.substring(0, 10)+'T'+mrbs.replace(/\./g,':').substring(11, 19))
      $('#backupSuccessTimestamp').html(mrbd.getDate()+' '+months[mrbd.getMonth()]+' '+mrbd.getFullYear()+' '+
                                        (mrbd.getHours()<10?'0':'')+mrbd.getHours()+':'+(mrbd.getMinutes()<10?'0':'')+mrbd.getMinutes()+'u'
                                       )
      backupOffsiteDialog = $('#offsiteBackupModal').modal({
        backdrop: 'static',
        keyboard: false,
        show: false
      })
      backupOffsiteDialog.on('hidden.bs.modal', function () {
        // Modal closed. Close all select2's
        $('oppleo-edit-select').each( (i, el) => el.close() )
      })        

      $('oppleo-edit-select').on('select', (e) => {
        console.log('oppleo-edit-str onSelect [' + e.target.id + '] id:' + e.detail.id + ' text:' + e.detail.text)
        $('button#modal-directory-apply').prop('disabled', false)
        $('button#modal-directory-apply').attr('data-original-title', 'Selecteer directory "' + e.detail.text + '"')
        // Reset no service chosen error
        $("#bm-step3-msg").html("")
        $('#osBackupServiceName')[0].$select_container.classList.remove("border", "border-danger")
        $('button#modal-footer-nextaction').addClass('btn-primary')
        $('button#modal-footer-nextaction').removeClass('btn-danger')
      })
      $('oppleo-edit-select').on('unselect', (e) => {
        console.log('oppleo-edit-str onSelect [' + e.target.id + '] id:' + e.detail.id + ' text:' + e.detail.text)
        $('button#modal-directory-apply').prop('disabled', true)
        $('button#modal-directory-apply').attr('data-original-title', '')

      })
      $('button#modal-directory-apply').on('click', function(bev) {
        $('button#modal-directory-apply').prop('disabled', true)
        $('button#modal-directory-apply').attr('data-original-title', '')
        $('button#modal-directory-apply').tooltip('hide') // Make sure tooltips don't remain          
        let dir = $($('#smbBackupRemotePathSelect')[0].$select).find("option:selected").text()

        let li = $('<li style="display: inline;">' + dir + '</li>')
        let span = $(`<span
                        class="text-secondary onhover-danger cursor-pointer"
                        data-toggle="tooltip" 
                        data-placement="bottom" 
                        data-html="true"
                        title='Verwijder "` + dir + `" uit het path'
                        >
                        <sup><i class="fas fa-times"></i></sup>
                      </span>`)
        li.append(span)
        let liSep = $('<li style="display: inline;">/</li>')
        $('#smbBackupRemotePathList ul').append(li)
        $('#smbBackupRemotePathList ul').append(liSep)

        span.on('click', (sev) => {
          let nextLiList = $(sev.currentTarget).parent().nextAll()
          nextLiList.each( (i, el) => { $(el).remove() })
          // prevList is from the currentTarget, thus reverse order
          let prevLiList = $(sev.currentTarget).parent().prevAll().reverse()
          let smbPath = ""
          prevLiList.each( (i, el) => { smbPath += el.innerText.trim() })
          $(sev.currentTarget).parent().remove()
          offsiteBackupDataReq( 'smbListDirectories', 
                          reqdata={ 
                            serverOrIP: $('#offsiteBackupServerOrIP')[0].$input.value, 
                            username: $('#offsiteBackupUsername')[0].$input.value, 
                            password: $('#offsiteBackupPassword')[0].$input.value,
                            serviceName: $($('#osBackupServiceName')[0].$select).find("option:selected").text(),
                            smbPath: smbPath
                          })
        })

        let smbPath = ""
        $('#smbBackupRemotePathList ul li').each( (i, el) => { smbPath += el.innerText.trim() })
        offsiteBackupDataReq( 'smbListDirectories', 
                        reqdata={ 
                          serverOrIP: $('#offsiteBackupServerOrIP')[0].$input.value, 
                          username: $('#offsiteBackupUsername')[0].$input.value, 
                          password: $('#offsiteBackupPassword')[0].$input.value,
                          serviceName: $($('#osBackupServiceName')[0].$select).find("option:selected").text(),
                          smbPath: smbPath
                        })
      })

      $('button#modal-backup-edit').on('click', (ev) => {
        showBackupModal()
      })

      $('input#backupEnabled').change(function() {
        // Switching on/off - submit to server
        updateSettings( 'backupEnabled', $(this).prop('checked') )
      })
      $('input#osBackupEnabled').change(function() {
        // Switching on/off - submit to server
        updateSettings( 'osBackupEnabled', $(this).prop('checked') )
      })
      $('a[href="#bm-step1"').tab('show')
      $("button#modal-footer-nextaction").on('click', function(e) {
        $('button#modal-footer-nextaction').html(' <i class="fas fa-spinner fa-spin"></i> ')
        var activeTab = $("ul#BackupModalNavTabs li a.active").attr("href")
        switch (activeTab) {
          case '#bm-step1':
            $('a[href="#bm-step2"').tab('show')
            $('button#modal-footer-nextaction').html(' <i class="fas fa-angle-right"></i> ')
            $("button#modal-footer-prevaction").prop('disabled', false)
            // Close all select2's
            $('oppleo-edit-select').each( (i, el) => el.close() )
            break
          case '#bm-step2':
            // Validate the account
            offsiteBackupDataReq( 'smbValidateAccount', 
                        reqdata={ 
                          serverOrIP: $('#offsiteBackupServerOrIP')[0].$input.value, 
                          username: $('#offsiteBackupUsername')[0].$input.value, 
                          password: $('#offsiteBackupPassword')[0].$input.value 
                        })
            break
          case '#bm-step3':
            if ($($('#osBackupServiceName')[0].$select).find("option:selected").length == 0) {
              // Nothing selected
              $("#bm-step3-msg").html("Selecteer een service")
              $('#osBackupServiceName')[0].$select_container.classList.add("border", "border-danger")
              $('button#modal-footer-nextaction').html(' <i class="fas fa-angle-right"></i> ')
              $('button#modal-footer-nextaction').addClass('btn-danger')
              $('button#modal-footer-nextaction').removeClass('btn-primary')
            } else {
              $("#bm-step3-msg").html("")
              $('#osBackupServiceName')[0].$select_container.classList.remove("border", "border-danger")
              $('button#modal-footer-nextaction').addClass('btn-primary')
              $('button#modal-footer-nextaction').removeClass('btn-danger')
              $('button#modal-directory-apply').prop('disabled', true)
              $('button#modal-directory-apply').attr('data-original-title', '')
              // get the root in the service
              offsiteBackupDataReq( 'smbListDirectories', 
                          reqdata={ 
                            serverOrIP: $('#offsiteBackupServerOrIP')[0].$input.value, 
                            username: $('#offsiteBackupUsername')[0].$input.value, 
                            password: $('#offsiteBackupPassword')[0].$input.value,
                            serviceName: $($('#osBackupServiceName')[0].$select).find("option:selected").text(),
                            smbPath: '/'
                          })
              // Clear path, start fresh
              $('#smbBackupRemotePathList ul li').remove()
              $('#smbBackupRemotePathList ul').append('<li style="display: inline;">/</li>')
              // Close all select2's
              $('oppleo-edit-select').each( (i, el) => el.close() )
              $('a[href="#bm-step4"').tab('show')
              $('button#modal-footer-nextaction').html(' <i class="fas fa-flag-checkered"></i> ')
            }

            break
          case '#bm-step4':
            // Next action on 4 is submit
            let osBackupType = $($('#osBackupType')[0].$select).select2('data').pop().id
            
            switch(osBackupType) {
              case '{{ oppleoconfig.OS_BACKUP_TYPE_SMB }}':
                updateSmbBackupSettings(true)
                $('button#modal-footer-nextaction').html(' <i class="fas fa-flag-checkered"></i> ')
                // Close all select2's
                $('oppleo-edit-select').each( (i, el) => el.close() )
                break
              case '{{ oppleoconfig.OS_BACKUP_TYPE_AFP }}':
              case '{{ oppleoconfig.OS_BACKUP_TYPE_ONEDRIVE }}':
              case '{{ oppleoconfig.OS_BACKUP_TYPE_ICLOUD }}':
              case '{{ oppleoconfig.OS_BACKUP_TYPE_UNKNOWN }}':
              default:
                autoHideNotify('error','top-left', 'Niet mogelijk', 'Dit offsite backup type wordt (nog) niet ondersteund.')
                $('button#modal-footer-nextaction').html(' <i class="fas fa-flag-checkered"></i> ')
                break
            }
        }          

      })
      // Cancel clicked
      $("button#modal-footer-cancel").on('click', function(e) {
        // Cancel button pressed
        $('#offsiteBackupModal').modal('hide')
      })

      $("button#modal-footer-prevaction").on('click', function(e) {
        $('.spinner').show()
        var activeTab = $("ul#BackupModalNavTabs li a.active").attr("href")
        switch (activeTab) {
          case '#bm-step1': // disabled
            break
          case '#bm-step2':
            $('a[href="#bm-step1"').tab('show')
            $("button#modal-footer-prevaction").prop('disabled', true)
            // Close all select2's
            $('oppleo-edit-select').each( (i, el) => el.close() )
            break
          case '#bm-step3':
            $("#bm-step3-msg").html("")
            $('#osBackupServiceName')[0].$select_container.classList.remove("border", "border-danger")
            $('button#modal-footer-nextaction').addClass('btn-primary')
            $('button#modal-footer-nextaction').removeClass('btn-danger')
            $('a[href="#bm-step2"').tab('show')
            // Close all select2's
            $('oppleo-edit-select').each( (i, el) => el.close() )
            break
          case '#bm-step4':
            $('a[href="#bm-step3"').tab('show')
            $('button#modal-footer-nextaction').html(' <i class="fas fa-angle-right"></i> ')
            // Close all select2's
            $('oppleo-edit-select').each( (i, el) => el.close() )
            break
        }          
        $('.spinner').hide()
      })
      $('a[href="#bm-step?"').on('click', function (e) {
        e.preventDefault()
      })
      // - Subnet/ Reverse Proxy
      $('#newSubnetOrIPButton').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        // Clean data fields
        $('#newSubnetOrIPInput').val('')
        // Show input
        $('#newSubnetOrIPInputRow').removeClass('d-none')
        $('#newSubnetOrIPButton').addClass('d-none')
        $('#newSubnetOrIPCancel').removeClass('d-none')
        $('#newSubnetOrIPSave').removeClass('d-none')
        // Is this the only entry, and is it empty?
        $('tr#newSubnetOrIPInputRow td:nth-child(1)').html(
          ($('.subnetOrIPRow').length == 1 && $('.subnetOrIPRow').html().includes('<i class="far fa-clipboard"></i>') ? 'Extern netwerk/ Reverse Proxy:' : '&nbsp;' )
        )
        if ($('.subnetOrIPRow').length == 1 && $('.subnetOrIPRow').html().includes('<i class="far fa-clipboard"></i>')) {
          $('.subnetOrIPRow').addClass('d-none')
        }
      })
      $('#newSubnetOrIPCancel').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        // Clean data fields
        $('#newSubnetOrIPInput').val('')
        // Hide input
        $('#newSubnetOrIPInputRow').addClass('d-none')
        $('#newSubnetOrIPButton').removeClass('d-none')
        $('#newSubnetOrIPCancel').addClass('d-none')
        $('#newSubnetOrIPSave').addClass('d-none')
        if ($('.subnetOrIPRow').length == 1) {
          $('.subnetOrIPRow').removeClass('d-none')
        }
      })
      $('#newSubnetOrIPInput').on('paste input', (e) => {
        // Only accept digits, dot and slash
        e.preventDefault()
        $(e.currentTarget).val($(e.currentTarget).val().replace(/[^(0-9|.|/)]/g, '').substring(0,18))
        let validation="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$|((\/(3[0-2]|[012]?[0-9])){0,1})$)){4}$"
        let regex = new RegExp(validation)
        if (regex.test($(e.currentTarget).val())) {
          $(e.currentTarget).removeClass("border-danger")
        }
      })
      $('button.subnetOrIPDelete').on('click', function(e) {
        buttonSubnetOrIPDelete(e)
      })
      $('#newSubnetOrIPSave').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        // Verify data field, only accept digits, dot and slash
        let validation="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$|((\/(3[0-2]|[012]?[0-9])){0,1})$)){4}$"
        let regex = new RegExp(validation)
        if (regex.test($('#newSubnetOrIPInput').val())) {
          $('#newSubnetOrIPInput').removeClass("border-danger")
        } else {                                  // Invalid
          $('#newSubnetOrIPInput').addClass("border-danger")
          return
        }
        // Submit
        updateExternalSubnet( $('#newSubnetOrIPInput').val(), 'POST', 
          function(result) {
            // successCallback
            autoHideNotify('success','top-left', 'Toegevoegd', 'Het IP of subnet is toegevoegd.')
            let nsoi = `<i class="`+( result.isSingleIP ? 'fas fa-desktop' : 'fas fa-network-wired')+` w-20px mr-2"></i>
                        <span class="subnetOrIP">`+result.subnetOrIP32+`</span>
                        <button type="button" style="float: right;" class="subnetOrIPDelete btn btn-xs btn-low-key-danger waves-effect waves-light" data-toggle="tooltip" data-placement="bottom" data-html="true" title="" data-original-title="<em class='text-danger font-weight-bold'>Let op!<br /><span class='text-white font-weight-normal'>Wordt direct verwijderd!</span></em>"> 
                          <i class="fas fa-trash-alt"></i> Verwijder 
                        </button>`

            let cnt = $(".subnetOrIPRow").length
            // 
            if (cnt == 1 && $('.subnetOrIPRow').hasClass('d-none')) {
              // Empty - fill first entry - find First row and Replace
              let el = $('.subnetOrIPRow').find('td:nth-child(2)')
              el.empty()
              el.append($(nsoi))
              $('.subnetOrIPRow').removeClass('d-none')
            } else {
              // Not empty - add entry
              let newRow = `<tr class="subnetOrIPRow">
                              <td class="text-dark">&nbsp;</td>
                              <td class="text-primary">
                              ` + nsoi + `
                              </td>
                            </tr>`
              let tr = $("span.subnetOrIP").last().closest('tr')
              $(newRow).insertAfter(tr)

            }
            // Remove existing click event handlers and Activate Delete button
            $('button.subnetOrIPDelete').off('click')
            $('button.subnetOrIPDelete').on('click', function(e) {
              buttonSubnetOrIPDelete(e)
            })
            // Tooltip Delete button
            $('[data-toggle=tooltip]').tooltip({ 
                    boundary: 'window', 
                    trigger : 'hover'   // Allow button clicks
            })
            // Hide input
            $('#newSubnetOrIPInputRow').addClass('d-none')
            $('#newSubnetOrIPButton').removeClass('d-none')
            $('#newSubnetOrIPCancel').addClass('d-none')
            $('#newSubnetOrIPSave').addClass('d-none')
          }, function(result) {
            // failCallback
            if (!([400, 401, 404, 500].includes(result.status))) {
                autoHideNotify('error','top-left', 'Niet toegevoegd', 'Het toevoegen van het IP adres is niet gelukt ('+result.status+').')
            }
        })

      })

      $("button[id$='-send-testmessage']").on('click', function(ev) {
        console.log(timestamp() + ' button send test message()')            
        $('button#'+ev.currentTarget.id).attr('disabled', true)
        let type = ev.currentTarget.id.replace("-send-testmessage", "")

        sendMessage( 'Testbericht', type, true, function(result) {
          if (result.status == 200) {
            autoHideNotify('success','top-left', 'Testbericht verzonden', 'Testbericht verzonden.')
          } else {
            autoHideNotify('error','top-left', 'Testbericht niet verzonden', 'Testbericht niet verzonden.')
          }
          $('button#'+ev.currentTarget.id).attr('disabled', false)

        }, function(result) {
          autoHideNotify('error','top-left', 'Testbericht niet verzonden', 'Testbericht niet verzonden.')
          $('button#'+ev.currentTarget.id).attr('disabled', false)
        })
      })
      $("button[id^='triggeraction-']").on('click', function(ev) {
        console.log(timestamp() + ' button send homeassistant mqtt autodiscovery')            
        $('button#'+ev.currentTarget.id).attr('disabled', true)
        let type = ev.currentTarget.id.replace("triggeraction-", "")

        sendMessage( 'ActionRequest', type, true, function(result) {
          if (result.status == 200) {
            autoHideNotify('success','top-left', 'Uitgevoerd', 'De actie is uitgevoerd of aangevraagd.')
          } else {
            autoHideNotify('error','top-left', 'Fout', 'De actie kon niet worden uitgevoerd of aangevraagd.')
          }
          $('button#'+ev.currentTarget.id).attr('disabled', false)

        }, function(result) {
          autoHideNotify('error','top-left', 'Fout', 'De actie kon niet worden uitgevoerd of aangevraagd.')
          $('button#'+ev.currentTarget.id).attr('disabled', false)

        })
      })

      // Start websockets
      startMqttHistoryStatusWebSocket()
      requestMqttHistoryStatus()
      startSettingsStatusWebSocket()
      startBackupStatusWebSocket()

      $("button[id^='mqtt-send-history-']").on('click', function(ev) {
        // Disable buttons
        $("button[id^='mqtt-send-history-']").attr('disabled', true)

        mqttHistory( ev.currentTarget.id.replace('mqtt-send-history-', ''), 'POST', function(result) {
          // Success
          switch (result.status) {
            case 200:   // Ok
            case 202:   // Accepted
              switch (result.action) {
                case 'start':
                  autoHideNotify('success','top-left', 'Succes', 'Versturen van de historie gestart.')
                  break
                case 'pause':
                  autoHideNotify('success','top-left', 'Succes', 'Versturen van de historie gepauzeerd.')
                  break
                case 'cancel':
                  autoHideNotify('success','top-left', 'Succes', 'Versturen van de historie geannuleerd.')
                  break
                default:
                  autoHideNotify('warning','top-left', 'Onbekend antwoord', "Onbekende actie voor vet versturen van de historie ("+result.action+")")
                  break
              }
              break
            case 409:   // Conflict
              break
            case 501:   // Not implemented
            default:
              autoHideNotify('error','top-left', 'Fout opgetreden', 'Er is een fout opgetreden in de communicatie met de server.')
              break
          }
        }, function(result) {
          // Failed
          autoHideNotify('warning','top-left', 'Ophalen status mislukt', 'Oppleo gaf geen antwoord op de statusvraag voor het versturen van de historie.')
        }, function(result) {
          // Always
        })

      })
      

      // After init, load pushover sounds with current token
      {% if oppleosystemconfig.pushoverApiKey is not none %}
      loadPushoverSounds( "{{ oppleosystemconfig.pushoverApiKey }}", "{{ oppleosystemconfig.pushoverSound }}" )
      {% if oppleosystemconfig.pushoverUserKey is not none %}
      loadPushoverDevices("{{ oppleosystemconfig.pushoverUserKey }}", "{{ oppleosystemconfig.pushoverApiKey }}")
      {% endif %}
      {% endif %}
      // MQTT
      $('input#pushoverEnabled').change(function() {
        updateSettings( 'pushoverEnabled', $(this).prop('checked') )
      })
      // MQTT
      $('input#mqttOutboundEnabled').change(function() {
        updateSettings( 'mqttOutboundEnabled', $(this).prop('checked') )
      })
      // HOMEASSISTANT MQTT
      $('input#homeAssistantMqttEnabled').change(function() {
        updateSettings( 'homeAssistantMqttEnabled', $(this).prop('checked') )
      })

      // Remove spinner
      $('.spinner').hide()
    })

    </script>

{% endblock %}
{% block content %}

<div class="wrapper" id="{{ var1 }}">
  <div class="container-fluid">

    <!-- Page-Title -->
    <div class="row">
        <div class="col-sm-12">
            <div class="page-title-box">
            </div>
        </div>
    </div>
    <!-- end page title end breadcrumb -->

    <div class="row">
      <div class="col-md-12">
          <div class="card-box">
              <h4 class="header-title m-t-0 m-b-30">Instellingen</h4>

              <ul class="nav nav-tabs tabs-bordered nav-justified" id="SettingsNavTabs">
                <li class="nav-item">
                  <a href="#v-charger" class="nav-link{% if active==1 %} active{% endif %}" data-toggle="tab" aria-expanded="false"><i class="fas fa-charging-station"></i> Laadpunt</a>
                </li>
                <li class="nav-item">
                  <a href="#v-kwhmeter" class="nav-link{% if active==2 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-tachometer-alt"></i> kWh meter</a>
                </li>
                <li class="nav-item">
                  <a href="#v-network" class="nav-link{% if active==3 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-network-wired"></i> Netwerk</a>
                </li>
                <li class="nav-item">
                  <a href="#v-database" class="nav-link{% if active==4 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-database"></i> Database</a>
                </li>
                <li class="nav-item">
                  <a href="#v-notifications" class="nav-link{% if active==5 %} active{% endif %}" data-toggle="tab" aria-expanded="false"><i class="far fa-envelope"></i> Notificaties</a>
                </li>
                <li class="nav-item">
                  <a href="#v-hardware" class="nav-link{% if active==6 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-microchip"></i> Hardware</a>
                </li>
                <li class="nav-item">
                  <a href="#v-backup" class="nav-link{% if active==7 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-download"></i> Backup</a>
                </li>
                <li class="nav-item">
                  <a href="#v-diagnostics" class="nav-link{% if active==8 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-stethoscope"></i> Diagnostics</a>
                </li>
              </ul>

              <div class="tab-content">

                  <div class="tab-pane{% if active==1 %} active{% endif %}" id="v-charger">
                    <div class="col-lg-12">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-charging-station"></i> Laadpunt</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            {% if oppleoconfig %}
                            <tr>
                              <td class="text-dark">Naam laadpunt:</td>
                              <td class="text-primary" style="width: 75%;">
                                <oppleo-edit-str 
                                  id="chargerNameText"
                                  value="{{ oppleoconfig.chargerNameText }}"
                                  validation="^([0-9]|[a-z]|[A-Z]|[!@#$%^&*()-+._/\\\[\]{}',:;|&quot; ])+$"
                                  info="De naam van het laadpunt. Letters, cijfers, spaties en de meeste speciale tekens zijn toegestaan."
                                  />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Laadpunt ID:</td>
                              <td class="text-primary" style="width: 75%;">
                                <oppleo-edit-str 
                                  id="chargerID"
                                  value="{{ oppleoconfig.chargerID }}"
                                  validation="^([0-9]|[a-z]|[A-Z]|[_])+$"
                                  info="Om openstaande laadsessies te voorkomen kan het ID van het laadpunt alleen worden gewijzigd wanneer de laadsessie is afgesloten. Alleen cijfers, letters en underscore toegestaan."
                                  />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">kWh Factor:</td>
                              <td class="text-primary" style="width: 75%;">
                                <oppleo-edit-str 
                                  id="factorWhkm"
                                  value="{{ oppleoconfig.factorWhkm }}"
                                  validation="^([0-9])+$"
                                  info="De Wh per km factor waarmee het km/h equivalent wordt berekend. Een waarde van 162 komt overeen met wat de Tesla Model 3 laat zien op het scherm in de auto. Een meer realistisch gemiddelde op basis van 16.836km in een Tesla Model 3 is 182Wh/km"
                                  />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Laadpunt tarief:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="chargerTariff"
                                  prefix="&euro; " 
                                  value="{{ oppleoconfig.chargerTariff }}"
                                  validation="^(?:0|[1-9][0-9]*)(?:[.][0-9]{1,2})?$"
                                  info="Standaard tarief in Den Haag in 2020 is &euro; 0.34. Het tarif kan alleen worden gewijzigd wanneer de laadsessie is afgesloten. De nauwkeurigheid is nu 2 decimalen."
                                  />
                            </tr>
                            {% endif %}
                            {% if ('modified_at' in charger_config) %}
                            <tr>
                              <td class="text-dark">Laatste wijziging:</td>
                              <td class="text-primary">{{ charger_config['modified_at'] }}</td>
                            </tr>
                            {% endif %}

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> Rapportages</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Bonnummer prefix:</td>
                              <td class="text-primary">
                                <form id="receipt-prefix-form">
                                  <oppleo-edit-str 
                                  id="receiptPrefix"
                                  prefix="" 
                                  value="{{ oppleoconfig.receiptPrefix }}"
                                  validation="^[A-Za-z0-9.-]{0,20}$"
                                  info="Prefix voor de bonnummers gegenereert in PDF maandrapporten. Het bonnummersformat is [prefix][jaartal][maand]. De prefix mag cijfers, kleine en hoofdletters, en punt of streep bevatten en niet langer zijn dan 20 karakters."
                                  />
                                </form>
                              </td>
                            </tr>          

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> Daluren</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Alleen laden binnen daluren:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if oppleoconfig.offpeakEnabled %}checked{% endif %}
                                  name="offpeakEnabled"
                                  id="offpeakEnabled"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Eenmalig laden buiten daluren:</td>
                              <td class="text-primary">
                                <form id="peak-hours-allow-peak-once-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.allowPeakOnePeriod %}checked{% endif %}
                                    name="allowPeakOnePeriod"
                                    id="allowPeakOnePeriod"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>

                            {% if 'offPeak' in diag and 'allReps' in diag['offPeak'] %}
                            {% for weekday in diag['offPeak']['allReps'] %}
                            {% set weekdayOffPeak = diag['offPeak']['allReps'][weekday] %}
                            <tr">
                              <td class="text-dark">{{ weekday }}:</td>
                              <td class="text-primary" id="offPeak{{ weekday }}">
                                <div class="progress">
                                  {% for section in weekdayOffPeak %}
                                  {% set diffMins = section['diffMins'] %}
                                  {% set diffMinsPercentage = (diffMins / (24 * 60)) *100 %}
                                  {% set offPeak = section['offPeak'] %}
                                  <div class="progress-bar progress-bar-striped {% if section['offPeak'] %}progress-bar-animated bg-success{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ diffMinsPercentage }}%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                  {% endfor %}
                                </div>
                                <div class="hours-of-day"></div>
                              </td>
                            </tr>
                            {%- endfor -%}
                            {%- endif -%}

                            {% if 'offPeak' in diag and 'all' in diag['offPeak'] %}
                            {% for offPeak in diag['offPeak']['all'] %}
                            {% if offPeak.is_holiday() %}
                            <tr id="offPeakHoliday_{{ offPeak.id }}">
                              <td class="text-dark">{{ offPeak.description }}:</td>
                              <td class="text-primary">
                                {% if offPeak.recurring %} 
                                  Elk jaar op {{ offPeak.holiday_day }} {{ offPeak.monthNlStr() }}
                                {% endif %}
                                {% if not offPeak.recurring %} 
                                  In {{ offPeak.holiday_year }} op {{ offPeak.holiday_day }} {{ offPeak.monthNlStr() }}
                                {% endif %}
                                <button 
                                  type="button" 
                                  id="offPeakDelete_{{ offPeak.id }}"
                                  style="float: right;"
                                  class="btn btn-xs btn-low-key-danger waves-effect waves-light" 
                                  data-toggle="tooltip" 
                                  data-placement="bottom" 
                                  data-html="true"
                                  title="<em class='text-danger font-weight-bold'>Let op!<br /><span class='text-white font-weight-normal'>Wordt direct verwijderd!</span></em>"
                                  > 
                                    <i class="fas fa-trash-alt"></i> Verwijder 
                                </button>
                              </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            {% endif %}

                            <tr id="offPeakNewHolidayDate" style="display: none;">
                              <td class="text-primary" style="text-align: right;">Nieuwe zon/feestdag:</td>
                              <td class="text-primary">

                                  <div class="input-daterange input-group">
                                    <div class="input-group-prepend">
                                      <span class="input-group-text bg-primary b-0 text-white">
                                        <i class="far fa-calendar-alt"></i>
                                      </span>
                                    </div>
                                    <input type="text" id="holidayDate" class="form-control" name="holidayDate" placeholder="Datum" value=""/>
                                    <div class="input-group-prepend">
                                      <span class="input-group-text bg-primary b-0 text-white">
                                        <i class="fas fa-heading"></i>
                                      </span>
                                    </div>
                                    <input type="text" id="holidayDescription" class="form-control" name="holidayDescription" style="text-align: left; flex: 40%;" placeholder="Omschrijving" value=""/>
                                    <button
                                      id="offPeakNewRecurring"
                                      type="button" 
                                      class="btn waves-effect waves-light btn-primary" 
                                      data-toggle="tooltip" 
                                      data-placement="bottom" 
                                      data-html="true" 
                                      title="<em>Klik om jaarlijks terugkerend te maken</em>"
                                      >
                                      <i class="fas fa-calendar-day"></i>
                                    </button> 
                                  </div>
                                                  
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">&nbsp;</td>
                              <td class="text-primary">
                                <button 
                                  type="button" 
                                  id="offPeakNewDate" 
                                  class="btn btn-outline-primary waves-effect waves-light"
                                  > 
                                  <i class='fas fa-edit'></i> Nieuwe zon/feestdag 
                                </button>
                                <button 
                                  type="button" 
                                  id="offPeakNewSave" 
                                  style="float: right; display: none;"
                                  class="btn btn-primary waves-effect waves-light"
                                  > 
                                  <i class='far fa-thumbs-up'></i> Opslaan 
                                </button>
                                <div style="float: right; width: 5px;">&nbsp;</div>
                                <button 
                                  type="button" 
                                  id="offPeakNewCancel"
                                  style="float: right; display: none;"
                                  class="btn btn-secondary waves-effect waves-light" 
                                  > 
                                  <i class='fas fa-times'></i> Annuleren 
                                </button>
                              </td>
                            </tr>

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-credit-card"></i> WebCharge</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark"> WebCharge op Dashboard:</td>
                              <td class="text-primary">
                                <form id="webcharge-on-dashboard-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.webChargeOnDashboard %}checked{% endif %}
                                    name="webChargeOnDashboard"
                                    id="webChargeOnDashboard"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Autorisatie:</td>
                              <td class="text-primary">
                                <form id="auth-webcharge-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.authWebCharge %}checked{% endif %}
                                    name="authWebCharge"
                                    id="authWebCharge"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>                            

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> Auto-session</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Ingeschakeld:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if oppleoconfig.autoSessionEnabled %}checked{% endif %}
                                  name="autoSessionEnabled"
                                  id="autoSessionEnabled"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Minutes:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="autoSessionMinutes"
                                suffix=" min" 
                                value="{{ oppleoconfig.autoSessionMinutes }}"
                                validation="^([1-9]+)$"
                                info="Tesla Model 3 settings are 0.1kWh in 90 minutes"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Energy:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="autoSessionEnergy"
                                suffix="kWh" 
                                value="{{ oppleoconfig.autoSessionEnergy }}"
                                validation="^[0-9]*[.]*[0-9]+$"
                                info="Tesla Model 3 settings are 0.1kWh in 90 minutes"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Condense sessies:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if oppleoconfig.autoSessionCondenseSameOdometer %}checked{% endif %}
                                  name="autoSessionCondenseSameOdometer"
                                  id="autoSessionCondenseSameOdometer"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                />
                              </td>
                            </tr>

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> Voertuiginformatie</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Voertuiginformatie op het Dashboard:</td>
                              <td class="text-primary">
                                <form id="vehicle-data-on-dashboard-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.vehicleDataOnDashboard %}checked{% endif %}
                                    name="vehicleDataOnDashboard"
                                    id="vehicleDataOnDashboard"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Voertuig wekken:</td>
                              <td class="text-primary">
                                <form id="wakeup-vehicle-on-data-request-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.wakeupVehicleOnDataRequest %}checked{% endif %}
                                    name="wakeupVehicleOnDataRequest"
                                    id="wakeupVehicleOnDataRequest"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-credit-card"></i> Afschermen (Reverse Proxy)</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark"> Menuopties afschermen:</td>
                              <td class="text-primary">
                                <form id="restrict-menu-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.restrictMenu %}checked{% endif %}
                                    name="restrictMenu"
                                    id="restrictMenu"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Dashboard afschermen:</td>
                              <td class="text-primary">
                                <form id="restrict-dashboard-access-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.restrictDashboardAccess %}checked{% endif %}
                                    name="restrictDashboardAccess"
                                    id="restrictDashboardAccess"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>                               

                            <tr>
                              <td class="text-dark">Dashboard lokaal onafgeschermd:</td>
                              <td class="text-primary">
                                <form id="allow-local-dashboard-access-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.allowLocalDashboardAccess %}checked{% endif %}
                                    name="allowLocalDashboardAccess"
                                    id="allowLocalDashboardAccess"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>

                            {% for subnetOrIP in oppleoconfig.routerIPAddress %}
                            <tr class="subnetOrIPRow">
                              <td class="text-dark">{% if subnetOrIP == (oppleoconfig.routerIPAddress | first) %}Extern netwerk/ Reverse Proxy:{% else %}&nbsp;{% endif %}</td>
                              <td class="text-primary">
                                <i class="{% if ipv4.isSingleIP(subnetOrIP) %}fas fa-desktop{% else %}fas fa-network-wired{%endif%} w-20px mr-2"></i>
                                <span class="subnetOrIP">{{ ipv4.remove32Subnet(subnetOrIP) }}</span>
                                <button type="button" style="float: right;" class="subnetOrIPDelete btn btn-xs btn-low-key-danger waves-effect waves-light" data-toggle="tooltip" data-placement="bottom" data-html="true" title="" data-original-title="<em class='text-danger font-weight-bold'>Let op!<br /><span class='text-white font-weight-normal'>Wordt direct verwijderd!</span></em>"> 
                                  <i class="fas fa-trash-alt"></i> Verwijder 
                                </button>
                              </td>
                            </tr>
                            {% endfor %}
                            {% if oppleoconfig.routerIPAddress | length == 0 %}
                            <tr class="subnetOrIPRow">
                              <td class="text-dark">Extern netwerk/ Reverse Proxy:</td>
                              <td class="text-primary"><span class="subnetOrIP"><i class="far fa-clipboard"></i> <span class="pl-2">Geen</span></span></td>
                            </tr>
                            {% endif %}
                            <tr id="newSubnetOrIPInputRow" class="d-none">
                              <td class="text-dark">{% if oppleoconfig.routerIPAddress | length == 0 %}Extern netwerk/ Reverse Proxy:{% else %}&nbsp;{% endif %}</td>
                              <td class="text-primary">
                                <div class="input-daterange input-group">
                                  <div class="input-group-prepend">
                                    <span class="input-group-text bg-primary b-0 text-white">
                                      <i class="fas fa-network-wired"></i>
                                    </span>
                                  </div>
                                  <input type="text" id="newSubnetOrIPInput" class="form-control" name="newSubnetOrIPInput" style="text-align: left; flex: 40%;" placeholder="x.x.x.x/yy" value="">
                                  <div class="input-group-append">

                                  <div class="input-group-append info-button-style" data-toggle="tooltip" data-placement="bottom" data-html="true" title="" data-original-title="IPv4 adres met x.x.x.x formaat, of een netwerk subnet met x.x.x.x/xx CIDR (Classless Inter-Domain Routing) mask.">
                                    <span class="input-group-text border-secondary bg-secondary text-muted">
                                      <i class="fas fa-info-circle"></i>
                                    </span>
                                  </div>
                                </div>
                              </td>
                            </tr>                            
                            <tr>
                              <td class="text-dark">&nbsp;</td>
                              <td class="text-primary">
                                <button type="button" id="newSubnetOrIPButton" class="btn btn-sm btn-outline-primary waves-effect waves-light"> 
                                  <i class="fas fa-edit"></i> IP/Subnet toevoegen
                                </button>
                                <button type="button" id="newSubnetOrIPSave" style="float: right;" class="btn btn-sm btn-primary waves-effect waves-light d-none"> 
                                  <i class="far fa-thumbs-up"></i> Opslaan 
                                </button>
                                <div style="float: right; width: 5px;">&nbsp;</div>
                                <button type="button" id="newSubnetOrIPCancel" style="float: right;" class="btn btn-sm btn-secondary waves-effect waves-light d-none"> 
                                  <i class="fas fa-times"></i> Annuleren 
                                </button>
                              </td>
                            </tr>

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-code-branch"></i> Software versie {% if changelog.activeBranch() != "master" %} (Developer Branch){% endif %}</h4>
                              </th>
                            </tr>
                            {% if changelog.activeBranch() != "master" %}
                            {% set changelogs = changelog.all(changelog.nl_NL) %}
                            <tr>
                              <td class="text-dark"> Branch:</td>
                              <td class="text-primary"><small><a href="https://github.com/ilseh/Oppleo/tree/{{ changelog.activeBranch() }}" class="font-italic text-warning font-smaller" target="_new"><i class="fas fa-external-link-alt"></i> {{ changelog.activeBranch() }}</a> (developer)</small></td>
                            </tr>
                            <tr>
                              <td class="text-dark"> Changelog <span class="text-primary font-italic">{{ changelog.activeBranch() }}</span>:</td>
                              {% if changelogs is not none and changelog.activeBranch() in changelogs and 'version' in changelogs[changelog.activeBranch()] %}
                              <td class="text-primary">v{{ changelogs[changelog.activeBranch()]['version'] }}, {{ changelogs[changelog.activeBranch()]['date'] }}<small class="pr-5" style="float: right;"><a href="{{ url_for('flaskRoutes.changelog') }}" class="stay font-italic text-success font-smaller pl-5"><i class="fas fa-link"></i> Change log</a></small></td>
                              {% else %}
                              <td class="text-primary"><small class="pr-5" style="float: right;"><a href="{{ url_for('flaskRoutes.changelog') }}" class="stay font-italic text-success font-smaller pl-5"><i class="fas fa-link"></i> Change log</a></small></td>
                              {% endif %}
                            </tr>
                            <tr>
                              <td class="text-dark"> </td>
                              <td class="text-primary"><small>Server commit: {{ gitutil.lastBranchGitDateStr(branch=changelog.activeBranch(), remote=False) }}, Github commit: {{ gitutil.lastBranchGitDateStr(branch=changelog.activeBranch(), remote=True) }})</small></td>
                            </tr>
                            <tr>
                              <td class="text-dark"> Changelog <span class="text-primary font-italic">master</span>:</td>
                              {% if changelogs is not none and 'master' in changelogs and 'version' in changelogs['master'] %}
                              <td class="text-primary">v{{ changelogs['master']['version'] }}, {{ changelogs['master']['date'] }}<small class="pr-5" style="float: right;"><a href="https://github.com/ilseh/Oppleo/blob/master/doc/changelog.txt" class="font-italic text-warning font-smaller pl-5" target="_new"><i class="fas fa-external-link-alt"></i> Change log</a></small></td>
                              {% else %}
                              <td class="text-primary"><small class="pr-5" style="float: right;"><a href="https://github.com/ilseh/Oppleo/blob/master/doc/changelog.txt" class="font-italic text-warning font-smaller pl-5" target="_new"><i class="fas fa-external-link-alt"></i> Change log</a></small></td>
                              {% endif %}
                            </tr>
                            <tr id="softwateUpdateCurrentVersionRow">
                              <td class="text-dark"> </td>
                              <td class="text-primary"><small>Server commit: {{ gitutil.lastBranchGitDateStr(branch='master', remote=False) }}, Github commit: {{ gitutil.lastBranchGitDateStr(branch='master', remote=True) }})</small></td>
                            </tr>
                            {% endif %}
                            {% if changelog.activeBranch() == "master" %}
                            <tr id="softwateUpdateCurrentVersionRow">
                              <td class="text-dark"> Huidige versie:</td>
                              <td class="text-primary">v{{ changelog.currentVersion }}, {{ changelog.currentVersionDateStr(changelog.nl_NL) }}<small><a href="{{ url_for('flaskRoutes.changelog') }}" class="stay font-italic text-warning font-smaller pl-5"><i class="fas fa-external-link-alt"></i> Change log</a></small></td>
                            </tr>
                            {% endif %}
                            <tr id="softwateUpdateCheckRow">
                              <td class="text-dark"></td>
                              <td class="text-primary">
                                <button 
                                  type="button" 
                                  id="softwateUpdateCheck" 
                                  class="btn btn-outline-success btn-sm waves-effect waves-light"
                                  > 
                                  <i class='far fa-question-circle'></i> Controleer {% if changelog.activeBranch() != "master" %}{{ changelog.activeBranch() }} {% endif %}op updates 
                                </button>                                
                              </td>
                            </tr>

                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==2 %} active{% endif %}" id="v-kwhmeter">
                    <div class="col-lg-9">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-tachometer-alt"></i> kWh meter</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            {% if (energydevicemodel is not none) %}
                            <tr>
                              <td class="text-dark">Actief:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if energydevicemodel.device_enabled %}checked{% endif %}
                                  id="energyDeviceEnabled"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                />
                                <span id="energyDeviceEnabledInfo" class="pl-2 text-secondary">Deactiveer om te wijzigen</span>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Device interface:</td>
                              <td class="text-primary">Modbus
                                <button class="btn btn-xs btn-outline-info waves-effect ml-2 pl-1 pr-1" 
                                  style="cursor: pointer;"
                                  data-toggle="tooltip"
                                  data-placement="right" 
                                  data-html="true" 
                                  title="Meer informatie over seriele verbindingen."
                                  onclick="parent.open('https://pyserial.readthedocs.io/en/latest/pyserial_api.html#constants')"
                                  >
                                  <i class="fa fa-info-circle"></i>
                                </button>
                                <button class="btn btn-xs btn-outline-info waves-effect pl-1 pr-1" 
                                  style="cursor: pointer;"
                                  data-toggle="tooltip"
                                  data-placement="right" 
                                  data-html="true" 
                                  title="Meer informatie over modbus mode."
                                  onclick="parent.open('https://www.virtual-serial-port.org/articles/modbus-rtu-guide/')"
                                  >
                                  <i class="fa fa-info-circle"></i>
                                </button>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Port name:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="port_name"
                                  prefix="" 
                                  value="{{ energydevicemodel.port_name }}"
                                  validation=""
                                  info="USB poort naam voor de modbus interface, bijv. /dev/ttyUSB0"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Slave address:</td>
                              <td class="text-primary">                                
                                <oppleo-edit-str 
                                id="slave_address"
                                prefix="" 
                                value="{{ energydevicemodel.slave_address }}"
                                validation="^([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])$"
                                info="Slave adres ingesteld op de kWh meter (modbus slave adres). Standaard waarde 1, waarde tussen 1 en 256."
                                />
                                </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Mode:</td>
                              <td class="text-primary">
                                <oppleo-edit-select 
                                  id="mode"
                                  options='[ { "text": "Remote Terminal Unit (RTU)", "id": "rtu"{% if energydevicemodel.mode == 'rtu' %}, "selected": "true" {% endif %} },
                                             { "text": "ASCII", "id": "ascii"{% if energydevicemodel.mode == 'ascii' %}, "selected": "true" {% endif %} }
                                           ]'
                                  placeholder="Maak een keuze..."
                                  info="Modbus mode rtu of ascii."
                                />                               
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Snelheid:</td>
                              <td class="text-primary">
                                <oppleo-edit-select 
                                  id="baudrate"
                                  options='[{ "text":   "2400", "id":   "2400"{% if energydevicemodel.baudrate ==   2400 %}, "selected": "true"{% endif %} }, 
                                            { "text":   "4800", "id":   "4800"{% if energydevicemodel.baudrate ==   4800 %}, "selected": "true"{% endif %} },
                                            { "text":   "9600", "id":   "9600"{% if energydevicemodel.baudrate ==   9600 %}, "selected": "true"{% endif %} },
                                            { "text":  "19200", "id":  "19200"{% if energydevicemodel.baudrate ==  19200 %}, "selected": "true"{% endif %} },
                                            { "text":  "38400", "id":  "38400"{% if energydevicemodel.baudrate ==  38400 %}, "selected": "true"{% endif %} },
                                            { "text":  "57600", "id":  "57600"{% if energydevicemodel.baudrate ==  57600 %}, "selected": "true"{% endif %} },
                                            { "text": "115200", "id": "115200"{% if energydevicemodel.baudrate == 115200 %}, "selected": "true"{% endif %} }
                                          ]'
                                  placeholder="Maak een keuze..."                                
                                  info="Seriele poort snelheid om de kWh meter uit te lezen. Dit moet overeenkomen met de snelheid op de kWh meter! Max van de Eastron SMD630 Modbus is 38400"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Byte size:</td >
                              <td class="text-primary">
                                <oppleo-edit-select 
                                  id="bytesize"
                                  options='[ { "text": "5", "id": "5"{% if energydevicemodel.bytesize == 5 %}, "selected": "true" {% endif %} }, 
                                             { "text": "6", "id": "6"{% if energydevicemodel.bytesize == 6 %}, "selected": "true" {% endif %} }, 
                                             { "text": "7", "id": "7"{% if energydevicemodel.bytesize == 7 %}, "selected": "true" {% endif %} },
                                             { "text": "8", "id": "8"{% if energydevicemodel.bytesize == 8 %}, "selected": "true" {% endif %} }
                                           ]'
                                  placeholder="Maak een keuze..."
                                  info="Afhankelijk van het apparaat. <a href='https://pyserial.readthedocs.io/en/latest/pyserial_api.html#constants' target='_new'>Info</a>"
                                />                               
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Stop bits:</td >
                              <td class="text-primary">
                                <oppleo-edit-select 
                                  id="stopbits"
                                  options='[ { "text": "1", "id": "1"{% if energydevicemodel.stopbits == 1 %}, "selected": "true" {% endif %} },
                                             { "text": "2", "id": "2"{% if energydevicemodel.stopbits == 2 %}, "selected": "true" {% endif %} }
                                           ]'
                                  placeholder="Maak een keuze..."
                                  info="Afhankelijk van het apparaat. <a href='https://pyserial.readthedocs.io/en/latest/pyserial_api.html#constants' target='_new'>Info</a>"
                                />                               
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Parity:</td >
                              <td class="text-primary">
                                <oppleo-edit-select 
                                  id="parity"
                                  options='[ { "text": "None", "id": "N"{% if energydevicemodel.parity == 'N' %}, "selected": "true" {% endif %} }, 
                                             { "text": "Even", "id": "E"{% if energydevicemodel.parity == 'E' %}, "selected": "true" {% endif %} }, 
                                             { "text": "Odd", "id": "O"{% if energydevicemodel.parity == 'O' %}, "selected": "true" {% endif %} },
                                             { "text": "Mark", "id": "M"{% if energydevicemodel.parity == 'M' %}, "selected": "true" {% endif %} },
                                             { "text": "Space", "id": "S"{% if energydevicemodel.parity == 'S' %}, "selected": "true" {% endif %} }
                                           ]'
                                  placeholder="Maak een keuze..."
                                  info="Afhankelijk van het apparaat. <a href='https://pyserial.readthedocs.io/en/latest/pyserial_api.html#constants' target='_new'>Info</a>"
                                />                               
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Timeout:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="serial_timeout"
                                  suffix=" seconden" 
                                  value="{{ energydevicemodel.serial_timeout }}"
                                  validation="^(?!0+(?:\.0+)?$)(?:9|9.0|9.00|9.000|[0-9]{1}(?:\.[0-9]{1,3})?)$"
                                  info="Modbus timeout. 0-9.999s"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Simulate:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if energydevicemodel.simulate %}checked{% endif %}
                                  id="simulate"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                  />
                                <span id="energyDeviceSimulateInfo" class="pl-2 text-secondary">Deactiveer om te wijzigen</span>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Close port after each call:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if energydevicemodel.close_port_after_each_call %}checked{% endif %}
                                  id="close_port_after_each_call"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                  />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Modbus register configuration:</td>
                              <td class="text-primary">
                                <oppleo-edit-select 
                                  id="modbusConfig"
                                  options='[ {% for mco in diag['modbusConfigOptions'] %}{ "text": "{{ mco.short }}", "id": "{{ mco.name }}"{% if mco.name == energydevicemodel.modbus_config %}, "selected": "true" {% endif %}}{% if mco.name != (diag['modbusConfigOptions'] | last).name %}, {% endif %}{% endfor %} ]'
                                  placeholder="Maak een keuze..."
                                  info="Modbus register definitie, kan verschillen per energiemeter type en versie."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">kWh meter uitleesinterval:</td>
                              <td class="text-primary">                                
                                <oppleo-edit-str 
                                  id="modbusInterval"
                                  value="{{ oppleoconfig.modbusInterval }}"
                                  suffix=" seconden"
                                  validation="^([1-9]|[1-5][0-9]|60)$"
                                  info="Interval in seconden tussen achtereenvolgende kWh meter uitlezingen (1-60 seconden). Een kortere periode geeft veranderingen sneller weer op de web interface en maakt een meer ganulaire log bij wijzigingen, maar zorgt ook voor meer log entries."
                                />
                                </td>
                            </tr>
                            
                            {% endif %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==3 %} active{% endif %}" id="v-network">
                    <div class="col-lg-6">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-network-wired"></i> Netwerk</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            {% if ('ip' in diag and 'eth0' in diag['ip'] and 'INET' in diag['ip']['eth0'] and diag['ip']['eth0']['INET'] | length > 0 and 'addr' in diag['ip']['eth0']['INET'][0]) %}
                            <tr>
                              <td class="text-dark">IPv4:</td>
                              <td class="text-primary">{{ diag['ip']['eth0']['INET'][0]['addr'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('ip' in diag and 'en0' in diag['ip'] and 'INET' in diag['ip']['en0'] and diag['ip']['en0']['INET'] | length > 0 and 'addr' in diag['ip']['en0']['INET'][0]) %}
                            <tr>
                              <td class="text-dark">IPv4:</td>
                              <td class="text-primary">{{ diag['ip']['en0']['INET'][0]['addr'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('ip' in diag and 'eth0' in diag['ip'] and 'INET6' in diag['ip']['eth0'] and diag['ip']['eth0']['INET6'] | length > 0 and 'addr' in diag['ip']['eth0']['INET6'][0]) %}
                            <tr>
                              <td class="text-dark">IPv6:</td>
                              <td class="text-primary">{{ diag['ip']['eth0']['INET6'][0]['addr'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('ip' in diag and 'en0' in diag['ip'] and 'INET6' in diag['ip']['en0'] and diag['ip']['en0']['INET6'] | length > 0 and 'addr' in diag['ip']['en0']['INET6'][0]) %}
                            <tr>
                              <td class="text-dark">IPv6:</td>
                              <td class="text-primary">{{ diag['ip']['en0']['INET6'][0]['addr'] }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                              <td class="text-dark">HTTP Host:</td>
                              <td class="text-primary">{{ oppleosystemconfig.httpHost }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">HTTP Port:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="httpPort"
                                  prefix="" 
                                  value="{{ oppleosystemconfig.httpPort }}"
                                  validation="^([0-9]{1,4}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$"
                                  info="HTTP port waarop de Oppleo service beschikbaar is."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">HTTP outbound timeout:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="httpTimeout"
                                  suffix=" seconden" 
                                  value="{{ oppleosystemconfig.httpTimeout }}"
                                  validation="^[1-9][0-9]{0,2}$"
                                  info="Timeout voor outbound HTTP connecties naar de Prowl, Pushover en Tesla API's."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Reloader:</td>
                              <td class="text-primary">{{ oppleoconfig.useReloader }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==4 %} active{% endif %}" id="v-database">
                    <div class="col-lg-12">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-database"></i> Database</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            <tr>
                              <td class="text-dark">Database:</td>
                              <td class="text-primary">PostgreSQL</td>
                            </tr>
                            <tr>
                              <td class="text-dark">SQLAlchemy URL:</td>
                              <td class="text-primary">
                                  <oppleo-edit-str 
                                  id="DATABASE_URL"
                                  prefix="" 
                                  value="{{ oppleosystemconfig.DATABASE_URL }}"
                                  validation="^(postgresql://)[a-zA-Z0-9]+(:)[a-zA-Z0-9]+(@)[a-zA-Z0-9.:/]+$"
                                  info="Alleen PostgresSQL ondersteund. Formaat: postgresql://charger:charger@10.0.1.160:5432/charger"
                                  />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">SQLAlchemy Pool Status:</td>
                              <td class="text-primary">{{ oppleosystemconfig.sqlAlchemyPoolStatus() }}</td>
                            </tr>

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> On Database Failure</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Herstart toestaan:<br />(via webapp)</td>
                              <td class="text-primary">
                                <form id="on-db-failure-allow-restart">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.onDbFailureAllowRestart %}checked{% endif %}
                                    id="bootstrapToggle_onDbFailureAllowRestart"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Magic Password:<br />(herstart autorisatie)</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="onDbFailureMagicPassword"
                                  prefix=""
                                  value=""
                                  hide="[hashed]"
                                  hideEdit=true
                                  validation="^[a-zA-Z0-9]{8,}$"
                                  info="Wanneer de database niet beschikbaar is zijn alle instellingen onbekend en is inloggen niet mogelijk. Dit wachtwoord geeft alleen dan autorisatie om de applicatie te herstarten, en eventueel de database URL opnieuw in te stellen."
                                />
                            </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Database URL wijzigen:</td>
                              <td class="text-primary">
                                <form id="on-db-failure-allow-url-change">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.onDbFailureAllowUrlChange %}checked{% endif %}
                                    name="bootstrapToggle_onDbFailureAllowUrlChange"
                                    id="bootstrapToggle_onDbFailureAllowUrlChange"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Toon Database URL:<br />(DB wachtwoord!)</td>
                              <td class="text-primary">
                                <form id="on-db-failure-show-current-url">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.onDbFailureShowCurrentUrl %}checked{% endif %}
                                    name="bootstrapToggle_onDbFailureShowCurrentUrl"
                                    id="bootstrapToggle_onDbFailureShowCurrentUrl"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                        
                          </tbody>
                        </table>
                        <img src="{{ url_for('static', filename='images/postgresql.png') }}" width="100px">
                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==5 %} active{% endif %}" id="v-notifications">
                    <div class="col-lg-12">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="far fa-envelope"></i> Notifications</h4>
                        <table class="table table-striped table-sm">
                          <tbody>

                            {% if oppleoconfig %}

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> Prowl (iOS Push messages)
                                  <span class="ml-5"
                                    style="cursor: help;"
                                    data-toggle="tooltip" 
                                    data-placement="bottom" 
                                    data-html="true" 
                                    title="Prowl berichten worden verzonden met standaard priority <em class='text-warning font-weight-bold'>0</em>. Prowl client is alleen beschikbaar voor iOS."
                                    >
                                    <i class="fas fa-info-circle"></i>
                                  </span>
                                </h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Prowl actief:</td>
                              <td class="text-primary">
                                <form id="prowl-enabled-form">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.prowlEnabled %}checked{% endif %}
                                    name="prowlEnabled"
                                    id="prowlEnabled"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                  <button type="button" class="btn btn-sm btn-outline-primary ml-5" id="prowl-send-testmessage"> <i class="far fa-paper-plane"></i> Verstuur testbericht</button>
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Prowl API key:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="prowlApiKey"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.prowlApiKey is not none  %}{{ oppleosystemconfig.prowlApiKey }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9]*$"
                                  info="API key voor je <a href='https://www.prowlapp.com/'>Prowl</a> push message app."
                                  />
                            </tr>
                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> Pushover (iOS/Android/Desktop Push messages)
                                  <span class="ml-5"
                                    style="cursor: help;"
                                    data-toggle="tooltip" 
                                    data-placement="bottom" 
                                    data-html="true" 
                                    title="Pushover berichten worden verzonden met standaard priority <em class='text-warning font-weight-bold'>0</em>. Pushover clients zijn beschikbaar voor Android, iOS en desktop browser web clients."
                                    >
                                    <i class="fas fa-info-circle"></i>
                                  </span>
                                </h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Pushover actief:</td>
                              <td class="text-primary">
                                <form id="prowl-enabled-form">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.pushoverEnabled %}checked{% endif %}
                                    name="pushoverEnabled"
                                    id="pushoverEnabled"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                  <button type="button" class="btn btn-sm btn-outline-primary ml-5" id="pushover-send-testmessage"> <i class="far fa-paper-plane"></i> Verstuur testbericht</button>
                                </form>
                              </td>
                            </tr>
                            <tr> 
                              <td class="text-dark">Pushover API key:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="pushoverApiKey"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.pushoverApiKey is not none  %}{{ oppleosystemconfig.pushoverApiKey }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9]*$"
                                  info="API key voor je <a href='https://pushover.net/api'>Pushover</a> push message app."
                                  />
                            </tr>
                            <tr>
                              <td class="text-dark">Pushover User Key:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="pushoverUserKey"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.pushoverUserKey is not none  %}{{ oppleosystemconfig.pushoverUserKey }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9]*$"
                                  info="User key voor je <a href='https://pushover.net/api'>Pushover</a> push message app."
                                  />
                            </tr>
                            <tr>
                              <td class="text-dark">Pushover device:</td >
                              <td class="text-primary">
                                <oppleo-edit-select 
                                  id="pushoverDevice"
                                  {% if oppleosystemconfig.pushoverDevice is not none  %}
                                  options='[ { "text": "{{ oppleoconfig.pushoverDevice }}", "id": "{{ oppleoconfig.pushoverDevice }}", "selected": "true" } ]'
                                  {% else %}
                                  options='[ ]'
                                  {% endif %}
                                  info="Device naam voor het <a href='https://pushover.net/api'>Pushover</a> push bericht."
                                  placeholder="Maak een keuze..."
                                  unlock=false
                                  />
                            </tr>
                            <tr>
                              <td class="text-dark">Pushover sound:</td >
                              <td class="text-primary">
                                <oppleo-edit-select 
                                  id="pushoverSound"
                                  {% if oppleosystemconfig.pushoverSound is not none  %}
                                  options='[ { "text": "{{ oppleoconfig.pushoverSound }}", "id": "{{ oppleoconfig.pushoverSound }}", "selected": "true" } ]'
                                  {% else %}
                                  options='[ ]'
                                  {% endif %}
                                  info="Geluid voor de <a href='https://pushover.net/api'>Pushover</a> push melding."
                                  placeholder="Maak een keuze..."
                                  unlock=false
                                  />
                            </tr>

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> MQTT 
                                  <span class="ml-5"
                                        style="cursor: help;"
                                        data-toggle="tooltip" 
                                        data-placement="bottom" 
                                        data-html="true" 
                                        title="Berichten worden verzonden naar topic met prefix <em class='text-warning font-weight-bold'>oppleo/{{ oppleoconfig.chargerID }}/</em> zonder retain en QoS waarde 0. Oppleo support alleen tcp verbinding, MQTT versie 3.1.1 (poha default)."
                                        >
                                    <i class="fas fa-info-circle"></i>
                                  </span>
                                </h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Outbound actief:</td>
                              <td class="text-primary">
                                <form id="mqtt-outbound-enabled-form">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.mqttOutboundEnabled %}checked{% endif %}
                                    name="mqttOutboundEnabled"
                                    id="mqttOutboundEnabled"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                  <button type="button" class="btn btn-sm btn-outline-primary ml-5" id="mqtt-send-testmessage"> <i class="far fa-paper-plane"></i>  Verstuur testbericht</button>
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">
                                Verstuur archief:
                                <span style="cursor: help;"
                                      class="text-warning"
                                      data-toggle="tooltip" 
                                      data-placement="bottom" 
                                      data-html="true" 
                                      title="<em class='text-warning font-weight-bold'>Waarschuwing</em><br>In batches worden alle {{ diag['measurements_str'] }} in de database aanwezige metingen opnieuw verstuurd. De berichten worden verzonden naar het topic <i>oppleo/{{ oppleoconfig.chargerID }}/usage/status_update</i>. Een inschatting van de doorlooptijd wordt zichtbaar na het starten."
                                  ><i class="fas fa-exclamation-triangle"></i>
                                </span>
                              </td>
                              <td class="text-primary">
                                <button type="button" class="btn btn-xs btn-outline-warning" id="mqtt-send-history-start" disabled> <i class="fas fa-play"></i>  Replay </button>
                                <button type="button" class="btn btn-xs btn-outline-success ml-1" id="mqtt-send-history-pause" disabled> <i class="fas fa-pause"></i>  Pauze</button>
                                <button type="button" class="btn btn-xs btn-outline-danger ml-1" id="mqtt-send-history-cancel" disabled> <i class="fas fa-stop"></i>  Annuleer</button>
                                <span class="text-secondary" id="mqtt-send-history-progress-info" style="position: relative; top: -5px; float: right; font-size: 1.7em; height: 1em; cursor: help; display: none;" data-toggle="tooltip" data-placement="bottom" data-html="true" title="">
                                  <i class="fas fa-info-circle" style="top: 0px;"></i>
                                </span>
                                <span id="mqtt-send-history-progress" data-toggle="tooltip" data-placement="bottom" data-html="true" title="" style="height: 5px; cursor: help; display: none;">
                                  <div class="progress mt-2" id="mqtt-send-history-progress-div" style="height: 5px; margin-bottom: 2px;">
                                    <div class="progress-bar progress-bar-striped bg-success" id="mqtt-send-history-progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                  </div>
                                </span>
                              </td>
                            </tr>                            
                            <tr>
                              <td class="text-dark">Host (naam of IP):</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="mqttHost"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.mqttHost is not none  %}{{ oppleosystemconfig.mqttHost }}{% else %}{% endif %}"
                                  validation="^(((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$|((\/(3[0-2]|[012]?[0-9])){0,1})$)){4})$|^((?=.{1,255}$)[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?(?:\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?)*\.?)$"
                                  info="Hostnaam of IP adres van de MQTT broker."
                                  />
                            </tr>
                            <tr>
                              <td class="text-dark">Port:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="mqttPort"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.mqttPort is not none  %}{{ oppleosystemconfig.mqttPort }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9]+$"
                                  info="Poort van de MQTT broker."
                                  />
                            </tr>
                            <tr>
                              <td class="text-dark">Username:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="mqttUsername"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.mqttUsername is not none  %}{{ oppleosystemconfig.mqttUsername }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9]+$"
                                  info="Gebruikersnaam van de MQTT broker."
                                  />
                            </tr>
                            <tr>
                              <td class="text-dark">Password:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="mqttPassword"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.mqttPassword is not none  %}{{ oppleosystemconfig.mqttPassword }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9]+$"
                                  info="Wachtwoord van de MQTT broker."
                                  hideEdit=true
                                  />
                            </tr>

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-home"></i> HomeAssistant (MQTT) 
                                  <span class="ml-5"
                                        style="cursor: help;"
                                        data-toggle="tooltip" 
                                        data-placement="bottom" 
                                        data-html="true" 
                                        title="Discovery berichten worden verzonden naar een topic met prefix <em class='text-warning font-weight-bold'>{{ oppleosystemconfig.homeAssistantMqttDiscoveryPrefix }}/sensor/{{ oppleoconfig.chargerID }}_{XX}/config</em> en status updates worden verzonden naar topic met prefix <em class='text-warning font-weight-bold'>{{ oppleosystemconfig.homeAssistantMqttDiscoveryPrefix }}/sensor/{{ oppleoconfig.chargerID }}/state</em>, zonder retain en QoS waarde 0. Oppleo support alleen tcp verbinding, MQTT versie 3.1.1 (poha default)."
                                        >
                                    <i class="fas fa-info-circle"></i>
                                  </span>
                                </h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Actief:</td>
                              <td class="text-primary">
                                <form id="mqtt-outbound-enabled-form">
                                  <input type="checkbox" 
                                    {% if oppleosystemconfig.homeAssistantMqttEnabled %}checked{% endif %}
                                    name="homeAssistantMqttEnabled"
                                    id="homeAssistantMqttEnabled"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />

                                  <span class="text-muted h6 text-uppercase ml-3" id="ha_mqtt">
                                    mqtt:
                                  </span>
                                  <span class="badge bg-secondary ml-1{% if haMqtt != 'DISCONNECTED' %} d-none{% endif %}" id="ha_mqtt_status_disconnected">
                                    Disconnected
                                  </span>
                                  <span class="badge bg-success ml-1{% if haMqtt != 'CONNECTED' %} d-none{% endif %}" id="ha_mqtt_status_connected">
                                    Connected
                                  </span>
                                  <span class="badge bg-warning ml-1{% if haMqtt != 'CONNECT_FAILED' %} d-none{% endif %}" id="ha_mqtt_status_connect_failed">
                                    Failed
                                  </span>
                                  <span class="badge bg-danger ml-1{% if haMqtt != 'NOT_AUTHORIZED' %} d-none{% endif %}" id="ha_mqtt_status_not_authorized">
                                    Denied
                                  </span>
                                  <span class="badge bg-danger ml-1{% if haMqtt != 'UNREACHABLE' %} d-none{% endif %}" id="ha_mqtt_status_unreachable">
                                    Unreachable
                                  </span>
                                  <span class="badge bg-warning ml-1{% if haMqtt != 'OTHER' %} d-none{% endif %}" id="ha_mqtt_status_other">
                                    Unknown
                                  </span>
                                  <span class="text-muted h6 text-uppercase ml-3" id="ha_mqtt_ha">
                                    HOME ASSISTANT:
                                  </span>
                                  <span class="badge bg-secondary ml-1{% if haMqttHa != 'OFFLINE' %} d-none{% endif %}" id="ha_mqtt_ha_offline">
                                    Offline
                                  </span>
                                  <span class="badge bg-success ml-1{% if haMqttHa != 'ONLINE' %} d-none{% endif %}" id="ha_mqtt_ha_online">
                                    Online
                                  </span>
                                  <span class="badge bg-warning ml-1{% if haMqttHa != 'UNKNOWN' %} d-none{% endif %}" id="ha_mqtt_ha_unknown">
                                    Unknown
                                  </span>

                                </form>


                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">
                                Acties:
                                <span style="cursor: help;"
                                      class="text-primary"
                                      data-toggle="tooltip" 
                                      data-placement="bottom" 
                                      data-html="true" 
                                      title="Handmatig triggeren van AutoDiscovery en status update berichten. Oppleo stuurt automatisch AutoDiscover en recente status updates bij het opstarten van Oppleo en bij het detecteren van Birth en Last Will and Testament MQTT berichten van Home Assistant."
                                  ><i class="fas fa-info-circle"></i>
                                </span>
                              </td>
                              <td class="text-primary">
                                <button type="button" class="btn btn-xs btn-outline-primary" id="triggeraction-ha-mqtt-send-autodiscovery" disabled> <i class="far fa-paper-plane"></i>  AutoDiscovery </button>
                                <button type="button" class="btn btn-xs btn-outline-primary ml-1" id="triggeraction-ha-mqtt-send-most-recent" disabled> <i class="far fa-paper-plane"></i>  Gegevens update </button>
                              </td>
                            </tr>                              
                            <tr>
                              <td class="text-dark">Host (naam of IP):</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="homeAssistantMqttHost"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.homeAssistantMqttHost is not none  %}{{ oppleosystemconfig.homeAssistantMqttHost }}{% else %}{% endif %}"
                                  validation="^(((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$|((\/(3[0-2]|[012]?[0-9])){0,1})$)){4})$|^((?=.{1,255}$)[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?(?:\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?)*\.?)$"
                                  info="Hostnaam of IP adres van de HomeAssistant MQTT broker."
                                  />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Port:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="homeAssistantMqttPort"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.homeAssistantMqttPort is not none  %}{{ oppleosystemconfig.homeAssistantMqttPort }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9]+$"
                                  info="Poort van de HomeAssistant MQTT broker."
                                  />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Username:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="homeAssistantMqttUsername"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.homeAssistantMqttUsername is not none  %}{{ oppleosystemconfig.homeAssistantMqttUsername }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9]+$"
                                  info="Gebruikersnaam van de HomeAssistant MQTT broker."
                                  />
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Password:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="homeAssistantMqttPassword"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.homeAssistantMqttPassword is not none  %}{{ oppleosystemconfig.homeAssistantMqttPassword }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9]+$"
                                  info="Wachtwoord van de HomeAssistant MQTT broker."
                                  hideEdit=true
                                  />
                              </td>
                            </tr>


                            <tr>
                              <td class="text-dark">Client Id:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="homeAssistantMqttClientId"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.homeAssistantMqttClientId is not none  %}{{ oppleosystemconfig.homeAssistantMqttClientId }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9_]+$"
                                  info="De Client ID die door Oppleo wordt gebruikt voor het discovery topic. Mag letters, cijfers en underscore bevatten. Wanneer niet ingevoerd gebruikt Oppleo een standaard formaat met 'Oppleo' + underscore + het Device ID."
                                  />
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Discovery Prefix:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="homeAssistantMqttDiscoveryPrefix"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.homeAssistantMqttDiscoveryPrefix is not none  %}{{ oppleosystemconfig.homeAssistantMqttDiscoveryPrefix }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9]+$"
                                  info="De prefix voor het discovery topic verwacht/ geconfigureerd in Home Assistant (default homeassistant)"
                                  />
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Birth & Last Will and Testament Topic:</td >
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="homeAssistantMqttBirthAndLastWillAndTestament"
                                  prefix="" 
                                  value="{% if oppleosystemconfig.homeAssistantMqttBirthAndLastWillAndTestament is not none  %}{{ oppleosystemconfig.homeAssistantMqttBirthAndLastWillAndTestament }}{% else %}{% endif %}"
                                  validation="^[A-Za-z0-9/]$"
                                  info="Het door Home Assistant gebruikte topic voor Birth (iopstarten) en Last Will and Testament (shutdown) notificaties. Default <i>homeassistant/status</i>"
                                  />
                              </td>
                            </tr>

                            {% endif %}

                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==6 %} active{% endif %}" id="v-hardware">
                    <div class="col-lg-12">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-microchip"></i> Platform</h4>
                        <table class="table table-striped table-sm">
                          <tbody>
                            {% if ('model' in diag) %}
                            <tr>
                              <td class="text-dark" style="min-width: 200px;">Model:</td>
                              <td class="text-primary">{{ diag['model'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('revision' in diag) %}
                            <tr>
                              <td class="text-dark">Revision:</td>
                              <td class="text-primary">{{ diag['revision'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('proc' in diag) %}
                            <tr>
                              <td class="text-dark">Processor:</td>
                              <td class="text-primary">{{ diag['proc'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('threading' in diag and 'active_count' in diag['threading']) %}
                            <tr>
                              <td class="text-dark">Thread count:</td>
                              <td class="text-primary">{{ diag['threading']['active_count'] }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                              <td class="text-dark">System type:</td>
                              <td class="text-primary">{{ diag['os']['sysname'] }} ({{ diag['platform'] }})</td>
                            </tr>
                            <tr>
                              <td class="text-dark">System uptime:</td>
                              <td class="text-primary">{{ diag['uptime']['sysuptime'] }} (Start: {{ diag['uptime']['sysstarttime'] }})</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Active process pid:</td>
                              <td class="text-primary">{{ diag['proc_pid'] }} (Parent: {{ diag['parent_pid'] }})</td>
                            </tr>
                            {% if diag['systemctl'] is mapping %}
                            <tr>
                              <td class="text-dark"><i>systemd</i> Status:</td>
                              <td class="text-primary">{{ diag['systemctl']['status'] }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark"><i>systemd</i> pid:</td>
                              <td class="text-primary">{{ diag['systemctl']['pid'] }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark"><i>systemd</i> Memory:</td>
                              <td class="text-primary">{{ diag['systemctl']['mem'] }}</td>
                            </tr>
                            {% else %}
                            <tr>
                              <td class="text-dark"><i>systemd</i>:</td>
                              <td class="text-primary">No</td>
                            </tr>
                            {% endif %}

                            <tr>
                              <td class="text-dark">Oppleo uptime:</td>
                              <td class="text-primary">{{ diag['uptime']['piduptime'] }} (Start: {{ diag['uptime']['pidstarttime'] }})</td>
                            </tr>


                            {% if ('threading' in diag and 'enum' in diag['threading']) %}
                            {% for thread in diag['threading']['enum'] %}
                            <tr>
                              {% if diag['threading']['enum'].index(thread) == 0 %}
                              <td class="text-dark">Threads:</td>
                              {% else %}
                              <td class="text-dark">&nbsp;</td>
                              {% endif %}
                              <td>
                                <span class="text-primary"
                                  data-toggle="tooltip" 
                                  data-placement="bottom" 
                                  data-html="true"
                                  title="{{ thread.ident }}"
                                >
                                  {{ thread.name }}
                                </span>
                                {% if thread.daemon %} <span class="text-muted small">daemon</span>{% endif %}
                                {% if thread._initialized and not thread._is_stopped %} <span class="text-success font-italic small">initialized</span>{% endif %}
                                {% if thread._is_stopped %} <span class="text-danger font-weight-bold">stopped</span>{% endif %}
                              </td>
                            </tr>
                            {% endfor %}
                            {% endif %}

                            <tr>
                              <td class="text-dark">RFID Thread info:</td>
                              {% if 'read' in diag['threading']['rfid_log'] %}
                              <td class="text-primary"><span class="font-italic">read</span> function call <i class="far fa-calendar-alt"></i> {{ diag['threading']['rfid_log']['read']['last'] }} <i class="fas fa-plus"></i> {{ diag['threading']['rfid_log']['read']['cnt'] }}</td>
                              {% else %}
                              <td class="text-primary">No info</td>
                              {% endif %}
                            </tr>
                            {% if 'read' in diag['threading']['rfid_log'] %}
                            <tr>
                              <td>&nbsp;</td>
                              <td class="text-primary"><span class="font-italic">read_no_block</span> function call <i class="far fa-calendar-alt"></i> {{ diag['threading']['rfid_log']['read_no_block']['last'] }} <i class="fas fa-plus"></i> {{ diag['threading']['rfid_log']['read_no_block']['cnt'] }}</td>
                            </tr>
                            <tr>
                              <td>&nbsp;</td>
                              <td class="text-primary">Detected rfid <i class="far fa-calendar-alt"></i> {{ diag['threading']['rfid_log']['detected_rfid']['last'] }} <i class="fas fa-plus"></i> {{ diag['threading']['rfid_log']['detected_rfid']['cnt'] }}</td>
                            </tr>
                            <tr>
                              <td>&nbsp;</td>
                              <td class="text-primary">Detected nothing <i class="far fa-calendar-alt"></i> {{ diag['threading']['rfid_log']['detected_nothing']['last'] }} <i class="fas fa-plus"></i> {{ diag['threading']['rfid_log']['detected_nothing']['cnt'] }}</td>
                            </tr>
                            <tr>
                              <td>&nbsp;</td>
                              <td class="text-primary">Collisions <i class="far fa-calendar-alt"></i> {{ diag['threading']['rfid_log']['detected_collision']['last'] }} <i class="fas fa-plus"></i> {{ diag['threading']['rfid_log']['detected_collision']['cnt'] }}</td>
                            </tr>
                            {% endif %}

                            <tr>
                              <td class="text-dark">Connected WebClients:</td>
                              <td class="text-primary">{{ oppleoconfig.connectedClients | length }}</td>
                            </tr>
                            {% for sid, connectedClient in oppleoconfig.connectedClients.items() %}
                            <tr>
                              <td class="text-dark"><i class="fas fa-level-up-alt fa-rotate-90 pr-1"></i> Client {{loop.index}}:</td>
                              <td class="text-primary">{{ sid }} ( {% if connectedClient['auth'] %}Authenticated{% else %}Not authenticated{% endif %} - {{ connectedClient['namespace'] }} - {{ connectedClient['stats']}} )</td>
                            </tr>
                            {% endfor %}

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> General-Purpose Input/Output (GPIO)</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">GPIO Mode:</td>
                              <td class="text-primary">
                                <oppleo-edit-select 
                                id="gpioMode"
                                options='[ { "text": "BCM: Broadcom SOC Channel (GPIO01 etc.)", "id": "BCM"{% if "BCM" == oppleoconfig.gpioMode %}, "selected": "true"{% endif %} },
                                           { "text": "BOARD: De GPIO.BOARD spec (Pin 1 etc.)", "id": "BOARD"{% if "BOARD" == oppleoconfig.gpioMode %}, "selected": "true"{% endif %} }
                                       ]'
                                placeholder="Maak een keuze..."
                                info="Raspberry Pi GPIO Pin definitie. De GPIO.BOARD spec refereert aan de pins per pin nummer op de header. GPIO.BCM spec refereert aan de pins per <b>Broadcom SOC Channel</b> nummer, als GPIO01. Bij elke Raspberry Pi versie kan de <i>BOARD</i> header Pin nummering verschillen, terwijl de <i>BCM</i> nummering meestal onveranderd blijft."
                                />
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark"><span class="text-danger">R</span><span class="text-success">G</span><span class="text-primary">B</span> Led aangesloten op GPIO:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if oppleosystemconfig.oppleoLedEnabled %}checked{% endif %}
                                  name="oppleoLedEnabled"
                                  id="oppleoLedEnabled"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark pl-3"><i class="fas fa-level-up-alt fa-rotate-90 pr-1"></i> <span class="text-danger">Rode</span> Led of rode pin van RGB led:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="pinLedRed"
                                  prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                  value="{{ oppleoconfig.pinLedRed }}"
                                  validation="^[0-9]+$"
                                  info="BCM GPIO Mode GPIO13"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark pl-3"><i class="fas fa-level-up-alt fa-rotate-90 pr-1"></i> <span class="text-success">Groene</span> Led of groene pin van RGB led:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="pinLedGreen"
                                  prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                  value="{{ oppleoconfig.pinLedGreen }}"
                                  validation="^[0-9]+$"
                                  info="BCM GPIO Mode GPIO12"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark pl-3"><i class="fas fa-level-up-alt fa-rotate-90 pr-1"></i> <span class="text-primary">Blauwe</span> Led of blauwe pin van RGB led:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="pinLedBlue"
                                  prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                  value="{{ oppleoconfig.pinLedBlue }}"
                                  validation="^[0-9]+$"
                                  info="BCM GPIO Mode GPIO16"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Buzzer aangesloten op GPIO:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if oppleosystemconfig.buzzerEnabled %}checked{% endif %}
                                  name="buzzerEnabled"
                                  id="buzzerEnabled"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark pl-3"><i class="fas fa-level-up-alt fa-rotate-90 pr-1"></i> Buzzer pin:</td>
                              <td class="text-primary">
                                <oppleo-edit-str
                                  id="pinBuzzer"
                                  prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                  value="{{ oppleoconfig.pinBuzzer }}"
                                  validation="^[0-9]+$"
                                  info="BCM GPIO Mode GPIO23"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">EVSE switch pin aangesloten op GPIO:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if oppleosystemconfig.evseSwitchEnabled %}checked{% endif %}
                                  name="evseSwitchEnabled"
                                  id="evseSwitchEnabled"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark pl-3"><i class="fas fa-level-up-alt fa-rotate-90 pr-1"></i> EVSE switch pin:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="pinEvseSwitch"
                                  prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                  value="{{ oppleoconfig.pinEvseSwitch }}"
                                  validation="^[0-9]+$"
                                  info="BCM GPIO Mode GPIO5"
                                />
                            </tr>
                            <tr>
                              <td class="text-dark">EVSE Led output aangesloten op GPIO:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if oppleosystemconfig.evseLedReaderEnabled %}checked{% endif %}
                                  name="evseLedReaderEnabled"
                                  id="evseLedReaderEnabled"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark pl-3"><i class="fas fa-level-up-alt fa-rotate-90 pr-1"></i> EVSE Led output GPIO pin nummer:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pinEvseLed"
                                prefix="{% if oppleoconfig.gpioMode == 'BCM' %}GPIO{% else %}Pin {% endif %} " 
                                value="{{ oppleoconfig.pinEvseLed }}"
                                validation="^[0-9]+$"
                                info="BCM GPIO Mode GPIO6"
                                />
                            </tr>
                            <tr>
                              <td class="text-dark">RFID reader aangesloten op SPI via de GPIO:</td>
                              <td class="text-primary">
                                <input type="checkbox" 
                                  {% if oppleosystemconfig.rfidEnabled %}checked{% endif %}
                                  name="rfidEnabled"
                                  id="rfidEnabled"
                                  data-toggle="toggle"
                                  data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                  data-off="<i class='far fa-thumbs-down'></i> NEE"
                                  data-onstyle="primary"
                                  data-offstyle="dark"
                                  data-size="sm"
                                  data-height="30"
                                  data-width="70"
                                />
                              </td>
                            </tr>
                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> LED Pulse levels</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Led pulse min:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pulseLedMin"
                                suffix="%" 
                                value="{{ oppleoconfig.pulseLedMin }}"
                                validation="^([1-9][0-9]?|100)$"
                                info="3%"
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Led pulse max:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="pulseLedMax"
                                suffix="%" 
                                value="{{ oppleoconfig.pulseLedMax }}"
                                validation="^([1-9][0-9]?|100)$"
                                info="98%"
                                />
                              </td>
                            </tr>
                                                        
                            {% if ('os' in diag) %}
                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-tasks"></i> OS</h4>
                              </th>
                            </tr>
                            {% for os_line in diag['os'] %}
                            <tr>
                              <td class="text-dark">{{ os_line }}</td>
                              <td class="text-primary">{{ diag['os'][os_line] }}</td>
                            </tr>
                            {% endfor %}
                            {% endif %}

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-hdd"></i> Disk</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Root:</td>
                              <td class="text-primary">/</td>
                            </tr>
                            {% if ('disk' in diag and 'total' in diag['disk'] and 'size' in diag['disk']['total'] and 'unit' in diag['disk']['total']) %}
                            <tr>
                              <td class="text-dark">Total:</td>
                              <td class="text-primary">{{ diag['disk']['total']['size'] }} {{ diag['disk']['total']['unit'] }}</td>
                            </tr>
                            {% endif %}    
                            {% if ('disk' in diag and 'free' in diag['disk'] and 'size' in diag['disk']['free'] and 'unit' in diag['disk']['free']) %}
                            <tr>
                              <td class="text-dark">Free:</td>
                              <td class="text-primary">{{ diag['disk']['free']['size'] }} {{ diag['disk']['free']['unit'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('disk' in diag and 'used' in diag['disk'] and 'size' in diag['disk']['used'] and 'unit' in diag['disk']['used']) %}
                            <tr>
                              <td class="text-dark">Used:</td>
                              <td class="text-primary">{{ diag['disk']['used']['size'] }} {{ diag['disk']['used']['unit'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('disk' in diag and 'percent' in diag['disk']) %}
                            <tr>
                              <td class="text-dark">&nbsp;</td>
                              <td class="text-primary">{{ diag['disk']['percent'] }}% in use</td>
                            </tr>
                            {% endif %}

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-memory"></i> Memory</h4>
                              </th>
                            </tr>
                            {% if ('pmem' in diag and diag['pmem'] is not none and 'MemTotalFormatted' in diag['pmem'] and 'size' in diag['pmem']['MemTotalFormatted'] and 'unit' in diag['pmem']['MemTotalFormatted']) %}
                            <tr>
                              <td class="text-dark">Total:</td>
                              <td class="text-primary">{{ diag['pmem']['MemTotalFormatted']['size'] }} {{ diag['pmem']['MemTotalFormatted']['unit'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('pmem' in diag and diag['pmem'] is not none and 'MemFreeFormatted' in diag['pmem'] and 'size' in diag['pmem']['MemFreeFormatted'] and 'unit' in diag['pmem']['MemFreeFormatted']) %}
                            <tr>
                              <td class="text-dark">Free:</td>
                              <td class="text-primary">{{ diag['pmem']['MemFreeFormatted']['size'] }} {{ diag['pmem']['MemFreeFormatted']['unit'] }}</td>
                            </tr>
                            {% endif %}
                            {% if ('pmem' in diag and diag['pmem'] is not none and 'MemAvailableFormatted' in diag['pmem'] and 'size' in diag['pmem']['MemAvailableFormatted'] and 'unit' in diag['pmem']['MemAvailableFormatted']) %}
                            <tr>
                              <td class="text-dark">Available:</td>
                              <td class="text-primary">{{ diag['pmem']['MemAvailableFormatted']['size'] }} {{ diag['pmem']['MemAvailableFormatted']['unit'] }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-clipboard-list"></i> Logging</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Logfile:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="logFile"
                                value="{{ oppleosystemconfig.logFile }}"
                                validation="^((/)+[a-zA-Z0-9\\-_/ ]*(.log))$"
                                info="Default locatie is in /tmp/Oppleo.log en de extensie moet .log zijn. De applicatie moet worden herstart na het wijzigen van de log file om wijzigingen in gebruik te nemen."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Log level:</td>
                              <td class="text-primary">
                                <oppleo-edit-select
                                  id="logLevel"
                                  options='[ {% for level in oppleosystemconfig.logLevelOptions %} { "text": "{{ level }}", "id": "{{ level }}"{% if oppleosystemconfig.logLevel == level %}, "selected": "true"{% endif %} }{{ ", " if not loop.last else "" }} {% endfor %} ]'
                                  placeholder="Maak een keuze..."
                                  info="Het loglevel bepaald het aantal berichten in de oppleo log file."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Maximale logfile grootte:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                  id="logMaxBytes"
                                  value="{{ oppleosystemconfig.logMaxBytes }}"
                                  suffix=" Bytes"
                                  validation="^[1-9]\d*$"
                                  info="Maximale logfile bestandsgrootte in bytes. Hierna wordt de logfile geroteeerd (overschreven). Grootte &gt;0."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Aantal logfiles:</td>
                                <td class="text-primary">
                                <oppleo-edit-str 
                                  id="logBackupCount"
                                  value="{{ oppleosystemconfig.logBackupCount }}"
                                  suffix=" file(s)"
                                  validation="^\d*$"
                                  info="Aantal te bewaren logfiles na rotatie. Het totaal is dit aantal historie plus de actieve logfile."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">SQLALCHEMY_TRACK_MODIFICATIONS:</td>
                              <td class="text-primary">{{ oppleosystemconfig.SQLALCHEMY_TRACK_MODIFICATIONS }}
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">DEBUG:</td>
                              <td class="text-primary">{{ oppleosystemconfig.DEBUG }}
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">PYTHONPATH:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="PYTHONPATH"
                                value="{{ oppleosystemconfig.PYTHONPATH }}"
                                validation="^([a-zA-Z0-9\\-_/]{0,})$"
                                info="Python PATH variable."
                                />
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">EXPLAIN_TEMPLATE_LOADING:</td>
                              <td class="text-primary">{{ oppleosystemconfig.EXPLAIN_TEMPLATE_LOADING }}
                              </td>
                            </tr>
                          </tbody>
                        </table>
                        <img src="{{ url_for('static', filename='images/Powered-by-Raspberry-Pi-Logo.png') }}" width="100px">

                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==7 %} active{% endif %}" id="v-backup">
                    <div class="col-lg-12">
                      <div class="card-box">
                        <table class="table table-striped table-sm">
                          <tbody>

                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-download"></i> Backup</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark">Recentste backup:</td>
                              <td class="text-primary" id="backupSuccessTimestamp">...</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Lokale backup directory:</td>
                              <td class="text-primary">{{ oppleoconfig.localBackupDirectory }}</td>
                            </tr>
                            <tr>
                              <td class="text-dark">Handmatig:</td>
                              <td class="text-primary">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="backup-create"{% if backuputil.backupInProgress %} disabled{% endif %}> 
                                  {% if backuputil.backupInProgress %}
                                  <i class="fas fa-spinner fa-spin"></i> 
                                  Backup actief...
                                  {% else %}
                                  <i class="fas fa-angle-right"></i> 
                                  Maak backup
                                  {% endif %}
                                </button>
                                <span id="backupNowStatusText" class="pl-2"></span>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Lokaal beschikbare backups:</td>
                              <td class="text-primary">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="backup-local-showinfo"> <i class="far fa-save"></i></i> Gegevens ophalen</button>
                              </td>
                            </tr>
                            <tr id='localBackupList' class="d-none">
                              <td class="text-dark">
                                Lokale backups:
                                <div id="backupLocalCount" class="text-primary"></div>
                              </td>
                              <td class="text-primary" style="overflow: hidden;">
                                <div style="max-height: 200px; overflow-y: auto;">
                                  <table class="w-100">
                                    <thead>
                                      <tr>
                                        <td class="pl-3 pr-3 text-center" style="border: 0px;"></td>
                                        <td style="border: 0px;">Tijdstip</td>
                                        <td style="border: 0px;">Omvang</td>
                                        <td style="border: 0px;">Filenaam</td>
                                        <td style="border: 0px;">Verwijder</td>
                                      </tr>
                                    </thead>
                                    <tbody id='backupLocalList'>
                                    </tbody>
                                  </table>
                                </div>
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Aantal lokale backups behouden:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="backupLocalHistory"
                                value="{% if oppleoconfig.backupLocalHistory is not none %}{{ oppleoconfig.backupLocalHistory }}{% endif %}"
                                validation="^(0?[1-9]|[1-9][0-9])$"
                                info="Aantal lokaal te behouden backups (1-99). De oudste backup wordt verwijderd. Voer 99 in voor een onbeperkt aantal backups, er worden dan geen backups verwijderd."
                                />
                              </td>
                            </tr>

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="far fa-calendar-alt"></i> Periodieke Backup</h4>
                              </th>
                            </tr>

                            <tr>
                              <td class="text-dark w-25">Activeer periodieke backup:</td>
                              <td class="text-primary">
                                <form id="backup-enabled-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.backupEnabled %}checked{% endif %}
                                    name="backupEnabled"
                                    id="backupEnabled"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark">Backup interval:</td>
                              <td class="text-primary">
                                <oppleo-edit-select 
                                id="backupInterval"
                                options='[ { "text": "Weekdag",     "id": "{{ oppleoconfig.BACKUP_INTERVAL_WEEKDAY }}"{% if oppleoconfig.BACKUP_INTERVAL_WEEKDAY == oppleoconfig.backupInterval %}, "selected": "true"{% endif %} },
                                           { "text": "Kalenderdag", "id": "{{ oppleoconfig.BACKUP_INTERVAL_CALDAY }}"{% if oppleoconfig.BACKUP_INTERVAL_CALDAY == oppleoconfig.backupInterval %}, "selected": "true"{% endif %} }
                                ]'
                                placeholder="Maak een keuze..."
                                info=""
                                />
                              </td>
                            </tr>

                            <tr id="backupDayOfWeekRow"{% if oppleoconfig.BACKUP_INTERVAL_WEEKDAY != oppleoconfig.backupInterval %} class="d-none"{% endif %}>
                              <td class="text-dark">Weekdag:</td>
                              <td class="text-primary" id="backupDayOfWeek">
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfWeekDay1" type="checkbox" checked="">
                                  <label for="backupDayOfWeekDay1">
                                    Maandag
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfWeekDay2" type="checkbox">
                                  <label for="backupDayOfWeekDay2">
                                    Dinsdag
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfWeekDay3" type="checkbox" checked="">
                                  <label for="backupDayOfWeekDay3">
                                    Woensdag
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfWeekDay4" type="checkbox" checked="">
                                  <label for="backupDayOfWeekDay4">
                                    Donderdag
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfWeekDay5" type="checkbox">
                                  <label for="backupDayOfWeekDay5">
                                    Vrijdag
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfWeekDay6" type="checkbox" checked="">
                                  <label for="backupDayOfWeekDay6">
                                    Zaterdag
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfWeekDay0" type="checkbox" checked="">
                                  <label for="backupDayOfWeekDay0">
                                    Zondag
                                  </label>
                                </div>
                              </td>
                            </tr>

                            <tr id="backupDayOfMonthRow"{% if oppleoconfig.BACKUP_INTERVAL_CALDAY != oppleoconfig.backupInterval %} class="d-none"{% endif %}>
                              <td class="text-dark">Kalenderdag:</td>
                              <td class="text-primary" id="backupDayOfMonth">
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay1" type="checkbox">
                                  <label for="backupDayOfMonthDay1" class="day-label">
                                    1<sup>e</sup>
                                  </label>
                              </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay2" type="checkbox">
                                  <label for="backupDayOfMonthDay2" class="day-label">
                                    2<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay3" type="checkbox">
                                  <label for="backupDayOfMonthDay3" class="day-label">
                                    3<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay4" type="checkbox">
                                  <label for="backupDayOfMonthDay4" class="day-label">
                                    4<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay5" type="checkbox">
                                  <label for="backupDayOfMonthDay5" class="day-label">
                                    5<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay6" type="checkbox">
                                  <label for="backupDayOfMonthDay6" class="day-label">
                                    6<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay7" type="checkbox">
                                  <label for="backupDayOfMonthDay7" class="day-label">
                                    7<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay8" type="checkbox">
                                  <label for="backupDayOfMonthDay8" class="day-label">
                                    8<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay9" type="checkbox">
                                  <label for="backupDayOfMonthDay9" class="day-label">
                                    9<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay10" type="checkbox">
                                  <label for="backupDayOfMonthDay10" class="day-label">
                                    10<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay11" type="checkbox">
                                  <label for="backupDayOfMonthDay11" class="day-label">
                                    11<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay12" type="checkbox">
                                  <label for="backupDayOfMonthDay12" class="day-label">
                                    12<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay13" type="checkbox">
                                  <label for="backupDayOfMonthDay13" class="day-label">
                                    13<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay14" type="checkbox">
                                  <label for="backupDayOfMonthDay14" class="day-label">
                                    14<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay15" type="checkbox">
                                  <label for="backupDayOfMonthDay15" class="day-label">
                                    15<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay16" type="checkbox">
                                  <label for="backupDayOfMonthDay16" class="day-label">
                                    16<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay17" type="checkbox">
                                  <label for="backupDayOfMonthDay17" class="day-label">
                                    17<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay18" type="checkbox">
                                  <label for="backupDayOfMonthDay18" class="day-label">
                                    18<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay19" type="checkbox">
                                  <label for="backupDayOfMonthDay19" class="day-label">
                                    19<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay20" type="checkbox">
                                  <label for="backupDayOfMonthDay20" class="day-label">
                                    20<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay21" type="checkbox">
                                  <label for="backupDayOfMonthDay21" class="day-label">
                                    21<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay22" type="checkbox">
                                  <label for="backupDayOfMonthDay22" class="day-label">
                                    22<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay23" type="checkbox">
                                  <label for="backupDayOfMonthDay23" class="day-label">
                                    23<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay24" type="checkbox">
                                  <label for="backupDayOfMonthDay24" class="day-label">
                                    24<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay25" type="checkbox">
                                  <label for="backupDayOfMonthDay25" class="day-label">
                                    25<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay26" type="checkbox">
                                  <label for="backupDayOfMonthDay26" class="day-label">
                                    26<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay27" type="checkbox">
                                  <label for="backupDayOfMonthDay27" class="day-label">
                                    27<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay28" type="checkbox">
                                  <label for="backupDayOfMonthDay28" class="day-label">
                                    28<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay29" type="checkbox">
                                  <label for="backupDayOfMonthDay29" class="day-label">
                                    29<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay30" type="checkbox">
                                  <label for="backupDayOfMonthDay30" class="day-label">
                                    30<sup>e</sup>
                                  </label>
                                </div>
                                <div class="checkbox checkbox-primary float-boxes wf-100">
                                  <input id="backupDayOfMonthDay31" type="checkbox">
                                  <label for="backupDayOfMonthDay31" class="day-label">
                                    31<sup>e</sup>
                                  </label>
                                </div>


                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Backup tijdstip:</td>
                              <td class="text-primary">
                                <oppleo-edit-time 
                                id="backupTimeOfDay"
                                options='{ "defaultTime": "{{ oppleoconfig.backupTimeOfDay.strftime('%H:%M') }}" }'
                                info="Tijdstip van de backup."
                                />
                              </td>
                            </tr>

                            <tr>
                              <th colspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-cloud-upload-alt"></i> Offsite Backup</h4>
                              </th>
                            </tr>

                            <tr>
                              <td class="text-dark">Aantal offsite backups:</td>
                              <td class="text-primary">
                                <oppleo-edit-str 
                                id="osBackupHistory"
                                value="{% if oppleoconfig.osBackupHistory is not none %}{{ oppleoconfig.osBackupHistory }}{% endif %}"
                                validation="^(0?[1-9]|[1-9][0-9])$"
                                info="Aantal offsite te behouden backups (1-99). De oudste backup wordt verwijderd. Voer 99 in voor een onbeperkt aantal backups, er worden dan geen backups verwijderd."
                                />
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Offsite Backup:</td>
                              <td class="text-primary">
                                <form id="offsite-backup-enabled-form">
                                  <input type="checkbox" 
                                    {% if oppleoconfig.osBackupEnabled %}checked{% endif %}
                                    name="osBackupEnabled"
                                    id="osBackupEnabled"
                                    data-toggle="toggle"
                                    data-on="<i class='far fa-thumbs-up'></i></i> JA"
                                    data-off="<i class='far fa-thumbs-down'></i> NEE"
                                    data-onstyle="primary"
                                    data-offstyle="dark"
                                    data-size="sm"
                                    data-height="30"
                                    data-width="70"
                                  />
                                </form>
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark"><span class="block-highlight">&nbsp;</span>Type:</td>
                              <td class="text-primary" id="osBackupTypeDisplay">
                                {% if oppleoconfig.osBackupType == oppleoconfig.OS_BACKUP_TYPE_SMB %}{{ oppleoconfig.OS_BACKUP_TYPE_SMB_STR }}{% endif %}
                                {% if oppleoconfig.osBackupType == oppleoconfig.OS_BACKUP_TYPE_AFP %}{{ oppleoconfig.OS_BACKUP_TYPE_AFP_STR }}{% endif %}
                                {% if oppleoconfig.osBackupType == oppleoconfig.OS_BACKUP_TYPE_ONEDRIVE %}{{ oppleoconfig.OS_BACKUP_TYPE_ONEDRIVE_STR }}{% endif %}
                                {% if oppleoconfig.osBackupType == oppleoconfig.OS_BACKUP_TYPE_ICLOUD %}{{ oppleoconfig.OS_BACKUP_TYPE_ICLOUD_STR }}{% endif %}
                                {% if oppleoconfig.osBackupType == oppleoconfig.OS_BACKUP_TYPE_UNKNOWN %}-{% endif %}
                              </td>
                            </tr>
                            <!--- SMB -->
                            <tr>
                              <td class="text-dark"><span class="block-highlight">&nbsp;</span>Server naam of IP adres:</td>
                              <td class="text-primary" id="smbBackupServerNameOrIPAddress">
                                {% if oppleoconfig.smbBackupServerNameOrIPAddress is not none %}{{ oppleoconfig.smbBackupServerNameOrIPAddress }}{% else %}-{% endif %}
                              </td>
                            </tr>          
                            <tr>
                              <td class="text-dark"><span class="block-highlight">&nbsp;</span>Gebruikersnaam:</td>
                              <td class="text-primary" id="smbBackupUsername">
                                {% if oppleoconfig.smbBackupUsername is not none %}{{ oppleoconfig.smbBackupUsername }}{% else %}-{% endif %}
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark"><span class="block-highlight">&nbsp;</span>Wachtwoord:</td>
                              <td class="text-primary" id="smbBackupPassword" value="{% if oppleoconfig.smbBackupPassword is not none %}{{ oppleoconfig.smbBackupPassword }}{% else %}{% endif %}">
                                {% if oppleoconfig.smbBackupPassword is not none %}********{% else %}{% endif %}
                              </td>
                            </tr>
                            <tr>
                              <td class="text-dark"><span class="block-highlight">&nbsp;</span>Locatie:</td>
                              <td class="text-primary">
                                <span id="smbBackupServiceName">
                                  {% if oppleoconfig.smbBackupServiceName is not none %}//{{ oppleoconfig.smbBackupServiceName }}{% endif %}</span><span id="smbBackupRemotePath">{% if oppleoconfig.smbBackupRemotePath is not none %}{{ oppleoconfig.smbBackupRemotePath }}{% endif %}</span>
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">&nbsp;</td>
                              <td class="text-primary">
                                <button type="button" class="btn btn-sm btn-outline-warning" id="modal-backup-edit"> <i class="fas fa-angle-right"></i> Offsite backup wijzigen </button>
                              </td>
                            </tr>

                            <tr>
                              <td class="text-dark">Offsite backups:</td>
                              <td class="text-primary">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="backup-offsite-showinfo"> <i class="fas fa-cloud-upload-alt"></i> Gegevens ophalen</button>
                              </td>
                            </tr>

                            <tr id='offsiteBackupList' class="d-none">
                              <td class="text-dark">
                                Offsite backups:
                                <div id="backupOffsiteCount" class="text-primary"></div>
                              </td>
                              <td class="text-primary" style="overflow: hidden;">
                                <div style="max-height: 200px; overflow-y: auto;">
                                  <table class="w-100">
                                    <thead>
                                      <tr>
                                        <td class="pl-3 pr-3 text-center" style="border: 0px;"></td>
                                        <td style="border: 0px;">Tijdstip</td>
                                        <td style="border: 0px;">Omvang</td>
                                        <td style="border: 0px;">Filenaam</td>
                                        <td style="border: 0px;">Verwijder</td>
                                      </tr>
                                    </thead>
                                    <tbody id='backupOffsiteList'>
                                    </tbody>
                                  </table>
                                </div>
                              </td>
                            </tr>                            

                          </tbody>
                        </table>

                      </div>
                    </div>
                  </div>

                  <div class="tab-pane{% if active==8 %} active{% endif %}" id="v-diagnostics">
                    <div class="col-lg-12">
                      <div class="card-box">

                        <table class="table table-striped table-sm">
                          <tbody>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-network-wired"></i> Diagnostics</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark" colspan="2">
                                <pre id="diag_json" style="color:rgba(255, 255, 255, 0.7);"></pre>
                              </td>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-network-wired"></i> HomeAssistant MQTT</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark" colspan="2">
                                <pre id="diag_hamqtt_json" style="color:rgba(255, 255, 255, 0.7);"></pre>
                              </td>
                            </tr>
                            <tr>
                              <th colspan="2" style="line-height: 40px;">
                                <h4 class="m-t-0 header-title"><i class="fas fa-network-wired"></i> ChargeHandlerThread</h4>
                              </th>
                            </tr>
                            <tr>
                              <td class="text-dark" colspan="2">
                                <pre id="diag_cht" style="color:rgba(255, 255, 255, 0.7);"></pre>
                              </td>
                            </tr>

                          </tbody>
                        </table>

                      </div>
                    </div>
                  </div>

          </div>
      </div> <!-- end col -->
    </div> <!-- end row -->

  </div>
</div>


        <!-- Bootstrap Modal -->
        <div class="modal fade" id="offsiteBackupModal" tabindex="-1" role="dialog" aria-labelledby="offsiteBackupModalLabel" aria-hidden="true" data-backdrop="static">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h3 class="modal-title" id="offsiteBackupModalLabel">Offsite backup</h3>
                <button type="button" class="close-x" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
              </div>
              <div class="modal-body">

                <ul class="nav nav-tabs tabs-bordered nav-justified" id="BackupModalNavTabs">
                  <li class="nav-item">
                    <a href="#bm-step1" class="nav-link" aaria-expanded="true" style="cursor: default;"><span class="numberCircle">1</span> Type <i class="fas fa-shoe-prints float-right"></i></a>
                  </li>
                  <li class="nav-item">
                    <a href="#bm-step2" class="nav-link" aaria-expanded="true" style="cursor: default;"><span class="numberCircle">2</span> Server <i class="fas fa-shoe-prints float-right"></i></a>
                  </li>
                  <li class="nav-item">
                    <a href="#bm-step3" class="nav-link" aria-expanded="false" style="cursor: default;"><span class="numberCircle">3</span> Share <i class="fas fa-shoe-prints float-right"></i></a>
                  </li>
                  <li class="nav-item">
                    <a href="#bm-step4" class="nav-link" aria-expanded="false" style="cursor: default;"><span class="numberCircle">4</span> Directory <i class="fas fa-flag-checkered float-right"></i></a>
                  </li>
                </ul>            
                <div class="tab-content">
    
                  <div class="tab-pane fade" id="bm-step1">
                    <div class="col-lg-12">
                      <div class="w-100 pb-4 pt-2">
                        <h4 class="header-title">Offsite backup</h4>
                      </div>
                      <table class="w-100">
                        <tr class="spacer-20"></tr> 
                        <tr>
                          <td class="text-dark">Type</td>
                          <td class="text-primary">
                            <oppleo-edit-select 
                            id="osBackupType"
                            options='[ { "text": "{{ oppleoconfig.OS_BACKUP_TYPE_SMB_STR }}", "id": "{{ oppleoconfig.OS_BACKUP_TYPE_SMB }}"{% if oppleoconfig.OS_BACKUP_TYPE_SMB == oppleoconfig.osBackupType %}, "selected": "true"{% endif %} } ]'
                            placeholder="Maak een keuze..."
                            info="Om dit moment wordt alleen SMB ondersteund. SMB (Server Message Block), ook bekend als Common Internet File System of CIFS, is het netwerkprotocol dat gebruikt wordt om in Microsoft Windows bestandsuitwisseling tussen meerdere computers mogelijk te maken (shared drive)."
                            unlock=true
                            />
                          </td>
                        </tr>

                      </table>

                    </div>
                  </div>
    
                  <div class="tab-pane fade" id="bm-step2">
                    <div class="col-lg-12">

                      <table class="w-100 mb-1">
                        <tr>
                          <td class="w-25 header-title pl-3" colspan="2">Server</td>
                        </tr>
                        <tr style="height: 1em;">
                          <td></td>
                          <td id="bm-step2-msg" class="text-danger font-italic"></td>
                        </tr>
                        <tr class="spacer-10"></tr> 
                        <tr>
                          <td class="text-dark w-25">Server naam of IP adres</td>
                          <td>
                            <oppleo-edit-str 
                            id="offsiteBackupServerOrIP"
                            value="{{ oppleoconfig.smbBackupServerNameOrIPAddress }}"
                            validation="^([0-9]|[a-z]|[A-Z]|[!@#$%\^&*._\-])+$"
                            info="Servernaam of IP adres van de remote server."
                            unlock=true
                            />
                          </td>
                        </tr>
                        <tr class="spacer-20"></tr> 
                        <tr>
                          <td class="text-dark">Gebruikersnaam</td>
                          <td class="text-primary">
                            <oppleo-edit-str 
                            id="offsiteBackupUsername"
                            value="{{ oppleoconfig.smbBackupUsername }}"
                            validation="^([0-9]|[a-z]|[A-Z]|[!@#$%\^&*._\-])+$"
                            info="Om openstaande laadsessies te voorkomen kan de naam van het laadpunt alleen worden gewijzigd wanneer de laadsessie is afgesloten."
                            unlock=true
                            />
                          </td>
                        </tr>
                        <tr class="spacer-10"></tr> 
                        <tr>
                          <td class="text-dark">Wachtwoord</td>
                          <td class="text-primary">
                            <oppleo-edit-str 
                            id="offsiteBackupPassword"
                            value=""
                            validation="^([0-9]|[a-z]|[A-Z]|[!@#$%\^&*._\-])+$"
                            info="Om openstaande laadsessies te voorkomen kan de naam van het laadpunt alleen worden gewijzigd wanneer de laadsessie is afgesloten."
                            unlock=true
                            hideEdit=true
                            />
                          </td>
                        </tr>
                      </table>

                    </div>
                  </div>
    
                  <div class="tab-pane fade" id="bm-step3">
                    <div class="col-lg-12">
                      <table class="w-100">
                        <tr>
                          <td class="w-25 header-title pl-3" colspan="2">Service</td>
                        </tr>
                        <tr class="spacer-20"></tr> 
                        <tr style="height: 1em;">
                          <td></td>
                          <td id="bm-step3-msg" class="text-danger font-italic"></td>
                        </tr>
                        <tr class="spacer-10"></tr> 
                        <tr>
                          <td class="text-dark w-25">Service</td>
                          <td class="text-primary">
                            <oppleo-edit-select 
                            id="osBackupServiceName"
                            {% if oppleoconfig.smbBackupServiceName is not none %}
                            options='[ { "text": "{{ oppleoconfig.smbBackupServiceName }}", "id": "{{ oppleoconfig.smbBackupServiceName }}", "selected": "true" } ]'
                            {% else %}
                            options='[ ]'
                            {% endif %}
                            info="Selecteer de service (naam van de share of gedeelde schijf)."
                            placeholder="Maak een keuze..."
                            unlock=true
                            />
                          </td>
                        </tr>
                        <tr class="spacer-10"></tr> 
                        <tr>
                          <td class="text-dark w-25"></td>
                          <td class="text-primary" id="currentSmbBackupServiceName">
                            {% if oppleoconfig.smbBackupServiceName is not none %}
                            <span class="text-secondary">(Huidige service: </span><span class="text-success">{% if not oppleoconfig.smbBackupServiceName.startswith('//') %}//{% endif %}{{ oppleoconfig.smbBackupServiceName }}{% if not oppleoconfig.smbBackupServiceName.endswith('/') %}/{% endif %}</span><span class="text-secondary">)</span>
                            {% endif %}
                          </td>
                        </tr>
                      </table>
    
                    </div>
                  </div>
                  
                  <div class="tab-pane fade" id="bm-step4">
                    <div class="col-lg-12">
                      <div class="w-100 pb-4 pt-2">
                        <h4 class="header-title">Directory</h4>
                      </div>
                      <table class="w-100">
                        <tr class="spacer-20"></tr> 
                        <tr>
                          <td class="text-dark w-25">Path</td>
                          <td id="smbBackupRemotePathList" class="text-primary" colspan="2">
                            <ul style="list-style-type: none;" class="pl-0 pb-0 mb-0">
                              <li style="display: inline;">/</li>
                            </ul>

                          </td>
                        </tr>
                        <tr class="spacer-10"></tr> 
                        <tr>
                          <td class="text-dark w-25">Directory</td>
                          <td class="text-primary">
                            <oppleo-edit-select 
                            id="smbBackupRemotePathSelect"
                            options='[ ]'
                            placeholder="Maak een keuze..."
                            info="Selecteer de folder (directory)."
                            unlock=true
                            />
                          </td>
                          <td class="text-primary w-10">
                            <button 
                              type="button" 
                              id="modal-directory-apply" 
                              class="btn btn-sm btn-primary" 
                              style="width: 100px;" 
                              data-toggle="tooltip" 
                              data-placement="bottom" 
                              data-html="true"
                              title=""
                              disabled
                              >
                               <i class="fas fa-sign-in-alt"></i> Selecteer 
                            </button>
                          </td>
                        </tr>
                        <tr class="spacer-10"></tr> 
                        <tr>
                          <td class="text-dark w-25"></td>
                          <td class="text-primary" id="currentSmbBackupRemotePath">
                            {% if oppleoconfig.smbBackupRemotePath is not none %}
                            <span class="text-secondary">(Huidige path: </span><span class="text-success">{% if not oppleoconfig.smbBackupRemotePath.startswith('/') %}/{% endif %}{{ oppleoconfig.smbBackupRemotePath }}{% if not oppleoconfig.smbBackupRemotePath.endswith('/') %}/{% endif %}</span><span class="text-secondary">)</span>
                            {% endif %}
                          </td>
                        </tr>
                      </table>

                    </div>
                  </div>
    
                </div>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary mr-2" id="modal-footer-cancel">Annuleren</button>
                <button type="button" class="btn btn-primary" style="width: 50px;" id="modal-footer-prevaction" disabled> <i class="fas fa-angle-left"></i> </button>
                <button type="button" class="btn btn-primary" style="width: 50px;" id="modal-footer-nextaction"> <i class="fas fa-angle-right"></i> </button>
              </div>
            </div>
          </div>
        </div>

{% endblock %}
